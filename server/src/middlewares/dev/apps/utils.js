var __awaiter=this&&this.__awaiter||function(e,i,a,l){return new(a=a||Promise)(function(r,t){function o(e){try{s(l.next(e))}catch(e){t(e)}}function n(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(o,n)}s((l=l.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(o,n){var s,i,a,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},p=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return p.next=e(0),p.throw=e(1),p.return=e(2),"function"==typeof Symbol&&(p[Symbol.iterator]=function(){return this}),p;function e(r){return function(e){var t=[r,e];if(s)throw new TypeError("Generator is already executing.");for(;l=p&&t[p=0]?0:l;)try{if(s=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,i=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(a=0<(a=l.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))l.label=t[1];else if(6===t[0]&&l.label<a[1])l.label=a[1],a=t;else{if(!(a&&l.label<a[2])){a[2]&&l.ops.pop(),l.trys.pop();continue}l.label=a[2],l.ops.push(t)}}t=n.call(o,l)}catch(e){t=[6,e],i=0}finally{s=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__spreadArray=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var o,n=0,s=t.length;n<s;n++)!o&&n in t||((o=o||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))},path=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.infoJson=exports.tempFolderPath=exports.publicPath=exports.appFolderPath=exports.TYPE_KEYWORDS_OF_EXPRESS_APP=exports.WIDGET_SHARED_CODE_PATH=exports.WIDGET_CHUNKS_PATH=exports.WIDGET_INFO_PATH=exports.WIDGET_EXISTED_INFO_PATH=exports.YOUR_EXTENSIONS_FOLDER=exports.DIST_FOLDER=exports.CLIENT_PATH=exports.SERVER_PATH=void 0,exports.requestException=requestException,exports.sortByNumber=sortByNumber,exports.sortByInitial=sortByInitial,exports.getOwner=getOwner,exports.getTypekeywords=getTypekeywords,exports.getOwnerFromInfo=getOwnerFromInfo,exports.filterByType=filterByType,exports.filterDataByOwner=filterDataByOwner,exports.filterDataByTypekeywords=filterDataByTypekeywords,exports.filterDataByPortalUrl=filterDataByPortalUrl,exports.fuzzyMatching=fuzzyMatching,exports.readFolder=readFolder,exports.formatJson=formatJson,exports.commonResponse=commonResponse,exports.addItemParamsIsPass=addItemParamsIsPass,exports.getFolderIndex=getFolderIndex,exports.isHasFolder=isHasFolder,exports.writeResponseLog=writeResponseLog,exports.initTime=initTime,exports.isJson=isJson,exports.createFolder=createFolder,exports.getIdFromUrl=getIdFromUrl,exports.deepClone=deepClone,exports.getUploadMulter=getUploadMulter,exports.getThumbnailUpdateMulter=getThumbnailUpdateMulter,exports.getWidgetsUriFromAppConfig=getWidgetsUriFromAppConfig,exports.updateAppInfo=updateAppInfo,require("path")),fs=require("fs-extra"),extra=require("fs-extra"),multer=require("@koa/multer");function requestException(e,t,r){return void 0===r&&(r=!1),"object"!=typeof e?!(t.body={error:{message:e,success:!1}}):("object"==typeof e.error&&(e.error.success=r),t.response.body=e,!1)}function sortByNumber(e,r,o){void 0===o&&(o="desc");return e.sort(function(e,t){return"desc"===o?t[r]-e[r]:"asc"===o&&e[r]-t[r]}),e}function sortByInitial(e,r){return e.sort(function(e,t){e=e[r],t=t[r];return e.localeCompare(t)}),e}function getOwner(e){var t,r={owner:"",isNot:!1};return e.includes("owner")&&(t=e.split("owner:")[1].split(" ")[0]),e.includes("NOT owner")&&(r.isNot=!0,r.owner=t),!e.includes("NOT owner")&&e.includes(" owner")&&(r.owner=t),r}function getTypekeywords(e){var t,r={typekeywords:"",isNot:!1};return e.includes("typekeywords")&&null!=(t=e.split("typekeywords:")[1].split(")")[0].split('" ')[0])&&t.includes('"')&&(t=t.split('"')[1]),e.includes("NOT typekeywords:")&&(r.isNot=!0,r.typekeywords=t),!e.includes("NOT typekeywords:")&&e.includes("typekeywords:")&&(r.typekeywords=t),r}function getOwnerFromInfo(e){var t="",e=path.join(exports.appFolderPath,e,"info.json");if(null!=e&&e.startsWith(exports.appFolderPath))return t=fs.existsSync(e)?JSON.parse(fs.readFileSync(e,"utf-8")).owner:t}function filterByType(e,t){var r=[],o=t.split('"')[1];return o?(e.forEach(function(e){e.type===o&&r.push(e)}),r):[]}function filterDataByOwner(e,t,r){void 0===r&&(r=!1);var o=[],n=t;return t.includes('"')&&(n=t.split('"').join("")),e.forEach(function(e){r&&e.owner!==n&&o.push(e),!r&&t&&e.owner===n&&o.push(e),r||t||o.push(e)}),o}function filterDataByTypekeywords(e,r,o){void 0===o&&(o=!1);var n=[];return r.includes('"')&&(r=r.split('"').join("")),e.forEach(function(e){var t;!o||null!=(t=null==e?void 0:e.typeKeywords)&&t.includes(r)||n.push(e),!o&&r&&null!=(t=null==e?void 0:e.typeKeywords)&&t.includes(r)&&n.push(e),o||r||n.push(e)}),n}function filterDataByPortalUrl(e,t){var r;return t?(r=[],e.forEach(function(e){(null==e?void 0:e.portalUrl)!==t&&null!=e&&e.portalUrl||r.push(e)}),r):e}function fuzzyMatching(e,t,r,o){var n=(n=o?null==t?void 0:t.toLowerCase():t).replace(/\"/g,"").replace(/\'/g,""),s=[];return e.forEach(function(e){var t=o?null==(t=e[r])?void 0:t.toLowerCase():e[r];n&&-1===(null==t?void 0:t.indexOf(n))&&e.id!==n||s.push(e)}),s}function readFolder(o,n,e){var s=[];return e&&Array.isArray(e)&&(s=deepClone(e)),o=fs.realpathSync(o),fs.readdirSync(o).forEach(function(e){var e=path.join(o,e),t={size:0,created:"",resource:e.split("\\").join("/").split(n)[1]},r=fs.statSync(e);r.isFile()?(t.size=r.size,t.created=r.birthtime.getTime().toLocaleString().split(",").join(""),s.push(t)):s=readFolder(e,n,s)}),s}function formatJson(o,n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){try{if(!n||-1===n.indexOf(".json"))return[2,!1];if(null==(o=fs.realpathSync(o))||!o.startsWith(exports.appFolderPath))return[2];if(fs.existsSync(o))try{if(null==o||!o.startsWith(exports.appFolderPath))return[2];isJson(t=JSON.parse(fs.readFileSync(o,"utf-8")))&&(r=JSON.stringify(t,null,2),fs.writeFileSync(o,r))}catch(e){return[2,e]}}catch(e){return[2,e]}return[2]})})}function commonResponse(e,t){e.response.body=t}function addItemParamsIsPass(e){var t="";return t=e.title?t:"no title"}function getFolderIndex(e,t){return isHasFolder(e,t)?getFolderIndex(e,t+1):t}function isHasFolder(e,t){var r;return!!Array.isArray(e)&&(r=!1,e.forEach(function(e){Number(e)===t&&(r=!0)}),r)}function writeResponseLog(e,t){void 0===t&&(t=!1)}function initTime(e){return!!e&&(e=new Date(e)).getFullYear()+"-"+((e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"-")+(e.getDate()+" ")+(e.getHours()+":")+(e.getMinutes()+":")+e.getSeconds()}function isJson(e){return"object"==typeof(e="string"==typeof e?JSON.parse(e):e)&&"[object object]"===Object.prototype.toString.call(e).toLowerCase()&&!e.length}function createFolder(r,e){var e=e.split("/"),o="";e.forEach(function(e){var t="".concat(r).concat(o,"/").concat(e);fs.ensureDirSync(t),o="".concat(o,"/").concat(e,"/")})}function getIdFromUrl(e,t){void 0===t&&(t=1);var r=e.request.url,e=(r="/"===r?e.originalUrl:r).split("/");return e[e.length-1-t]}function deepClone(e){var t,r=Array.isArray(e)?[]:{};for(t in e){var o=("object"==typeof e[t]||"function"==typeof e[t])&&null!==e[t];r[t]=o?deepClone(e[t]):e[t]}return r}function getUploadMulter(){var e=multer.diskStorage({destination:function(r,e,o){try{Promise.resolve(!0).then(function(){var e=r.url.split("/"),e=e[e.length-2],t=r.body||{},e="".concat(exports.appFolderPath,"/").concat(e),t="resources/"+t.resourcesPrefix,e=(fs.existsSync(e)?createFolder(e,t):console.log("no item"),"".concat(e,"/").concat(t));o(null,e)})}catch(e){console.log(e)}},filename:function(e,t,r){t=t.originalname.split(".");r(null,(e.body||{}).fileName||Date.now()+"."+t[t.length-1])}});return multer({storage:e})}function getThumbnailUpdateMulter(){var e=multer.diskStorage({destination:function(r,e,o){try{Promise.resolve(!0).then(function(){var e=r.url.split("/"),e=e[e.length-2],e="".concat(exports.appFolderPath,"/").concat(e),t="".concat(e,"/").concat("thumbnail");fs.existsSync(e)||console.log("no item"),extra.emptyDirSync(t),o(null,t)})}catch(e){console.log(e)}},filename:function(e,t,r){var t=t.originalname.split("."),o=t[t.length-1];1===t.length&&(o="png"),r(null,"thumbnail"+Date.now()+"."+o)}});return multer({storage:e})}function getWidgetsUriFromAppConfig(t){var e=path.join(exports.CLIENT_PATH,exports.DIST_FOLDER),r=[],o=[],e=fs.existsSync(path.join(e,exports.WIDGET_EXISTED_INFO_PATH))?path.join(e,exports.WIDGET_EXISTED_INFO_PATH):path.join(e,exports.WIDGET_INFO_PATH),n=JSON.parse(fs.readFileSync(e,"utf8")).map(function(e){return e.uri});return t.widgets&&Object.keys(t.widgets).forEach(function(e){e=t.widgets[e];n.includes(e.uri)?r.includes(e.uri)||r.push(e.uri):e.uri&&!o.includes(e.uri)&&o.push(e.uri)}),{coreWidgetsUri:r,customWidgetsUri:o}}function updateAppInfo(e,t){var r=JSON.stringify(e,null,2),t=(fs.writeFileSync(t,r),e.username),r=(null==e?void 0:e.tags)||[];t&&0<r.length&&updateTagsOfUser(t,r)}function updateTagsOfUser(e,t){void 0===t&&(t=[]);var r=path.join(exports.publicPath,"user_resources","tags.json"),o=(fs.ensureFileSync(r),JSON.parse(fs.readFileSync(r,"utf-8")||"{}")||{}),n=((null==o?void 0:o[e])||[]).map(function(e){return null==e?void 0:e.tag}),t=Array.from(new Set(__spreadArray(__spreadArray([],t,!0),n,!0))).map(function(e){return{tag:e}}),n=(o[e]=t,JSON.stringify(o,null,2));fs.writeFileSync(r,n)}exports.SERVER_PATH=path.join(__dirname,"../../../.."),exports.CLIENT_PATH=path.join(exports.SERVER_PATH,"../client"),exports.DIST_FOLDER="dist",exports.YOUR_EXTENSIONS_FOLDER="your-extensions",exports.WIDGET_EXISTED_INFO_PATH="widgets/widgets-info-existed.json",exports.WIDGET_INFO_PATH="widgets/widgets-info.json",exports.WIDGET_CHUNKS_PATH="widgets/chunks",exports.WIDGET_SHARED_CODE_PATH="widgets/shared-code",exports.TYPE_KEYWORDS_OF_EXPRESS_APP="ExpressExperienceApp",exports.appFolderPath=path.join(__dirname,"../../../../public/apps"),exports.publicPath=path.join(__dirname,"../../../../public/"),exports.tempFolderPath=path.join(__dirname,"../../../../temp"),console.log("Apps folder:",exports.appFolderPath),exports.infoJson={created:0,description:"",id:"",modified:0,owner:"",tags:[],thumbnail:null,title:"",type:"Web Experience",snippet:"",typeKeywords:["Web Experience","status: Draft"]};