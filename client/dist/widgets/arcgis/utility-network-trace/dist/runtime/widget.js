System.register(["jimu-core/emotion","jimu-core","jimu-arcgis","jimu-ui","esri/widgets/UtilityNetworkTrace","esri/core/reactiveUtils","esri/layers/FeatureLayer","esri/Graphic"],function(e,t){var i={},a={},s={},o={},r={},n={},l={},u={};return{setters:[function(e){i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){a.BaseWidget=e.BaseWidget,a.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,a.DataSourceManager=e.DataSourceManager,a.DataSourceStatus=e.DataSourceStatus,a.MessageManager=e.MessageManager,a.React=e.React,a.css=e.css,a.getAppStore=e.getAppStore,a.lodash=e.lodash},function(e){s.JimuMapViewComponent=e.JimuMapViewComponent,s.MapViewManager=e.MapViewManager},function(e){o.Paper=e.Paper,o.WidgetPlaceholder=e.WidgetPlaceholder,o.defaultMessages=e.defaultMessages},function(e){r.default=e.default},function(e){n.watch=e.watch},function(e){l.default=e.default},function(e){u.default=e.default}],execute:function(){e((()=>{var e={14321:e=>{"use strict";e.exports=o},14924:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M5 2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0m-1 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0M5 12.5a2.5 2.5 0 1 1-.703-1.739l1.86-1.389A2.5 2.5 0 1 1 10.95 8h2.099a2.5 2.5 0 0 1 2.75-1.982l.447-1.354A2.5 2.5 0 0 1 17.5 0a2.5 2.5 0 1 1-.304 4.982l-.447 1.352a2.5 2.5 0 0 1-.352 4.5l.924 3.172q.09-.006.179-.006a2.5 2.5 0 1 1-1.142.275l-.954-3.277A2.5 2.5 0 0 1 13.05 9h-2.1A2.5 2.5 0 0 1 9 10.95v4.1a2.5 2.5 0 1 1-1 0v-4.1a2.5 2.5 0 0 1-1.312-.727l-1.852 1.384c.106.277.164.578.164.893m-1 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0M8.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m1.5 7.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m7.5.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3M17 8.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m.5-4.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3" clip-rule="evenodd"></path><path fill="#000" d="M3 7V6H2v1zM3 8v1H2V8zM3 17v-1H2v1zM2 18h1v1H2z"></path></svg>'},22089:e=>{"use strict";e.exports=u},22564:e=>{"use strict";e.exports=r},62243:e=>{"use strict";e.exports=n},62686:e=>{"use strict";e.exports=s},67386:e=>{"use strict";e.exports=i},79244:e=>{"use strict";e.exports=a},85633:e=>{"use strict";e.exports=l}},t={};function c(i){var a=t[i];if(void 0!==a)return a.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,c),s.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var i in t)c.o(t,i)&&!c.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.p="";var d={};return c.p=window.jimuConfig.baseUrl,(()=>{"use strict";c.r(d),c.d(d,{__set_webpack_public_path__:()=>M,default:()=>w});var e=c(67386),t=c(79244),i=c(62686),a=c(14321),s=c(22564),o=c(62243);const r=[{value:"traceId",label:"Trace Id"},{value:"traceName",label:"Trace name"},{value:"traceDescription",label:"Trace description"},{value:"startingPoints",label:"Starting points"},{value:"barriers",label:"Barriers"},{value:"version",label:"Version"},{value:"username",label:"User"},{value:"date",label:"Date"},{value:"elementCount",label:"Count of features"},{value:"functionResult",label:"Trace functions"},{value:"areaStatistic",label:"Area statistic"}];var n,l=c(85633),u=c(22089);!function(e){e[e.Feet=528e4]="Feet",e[e.Miles=1e3]="Miles",e[e.Kilometers=1609.344]="Kilometers",e[e.Meters=1609344]="Meters",e[e.Yards=176e4]="Yards"}(n||(n={}));var p=function(e,t,i,a){return new(i||(i=Promise))(function(s,o){function r(e){try{l(a.next(e))}catch(e){o(e)}}function n(e){try{l(a.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,n)}l((a=a.apply(e,t||[])).next())})};class h{constructor(){this.unt=null,this.activeDataSourceId="",this.appConfigDataSources=null,this.updatedConfig=null,this.props=null,this.mvManager=i.MapViewManager.getInstance(),this.getOutputDataSource=e=>t.DataSourceManager.getInstance().getDataSource(e),this.buildTraceResultStatsAsOutput=e=>p(this,void 0,void 0,function*(){const i=`${this.props.widgetId}-output`;let s=this.getOutputDataSource(i);if(s||(s=yield t.DataSourceManager.getInstance().createDataSource(i)),!s)return;if(0===(null==e?void 0:e.length))return void s.setStatus(t.DataSourceStatus.NotReady);const o=[];o.push({alias:"OBJECTID",type:"double",name:"OBJECTID"}),r.forEach(e=>{var t,a,s,r,n;const l=(null===(n=null===(r=null===(s=null===(a=null===(t=this.updatedConfig)||void 0===t?void 0:t.configInfo)||void 0===a?void 0:a[this.activeDataSourceId])||void 0===s?void 0:s.traceResultAreaSettings)||void 0===r?void 0:r.resultAreaProperties)||void 0===n?void 0:n.areaUnit)||"square-feet";"areaStatistic"===e.value?("square-miles"===l||"square-meters"===l||"square-feet"===l||"square-kilometers"===l)&&o.push({alias:this.appConfigDataSources[i].schema.fields[e.value].alias,type:"double",name:e.value}):"version"===e.value||"elementCount"===e.value?o.push({alias:this.appConfigDataSources[i].schema.fields[e.value].alias,type:"double",name:e.value}):o.push({alias:this.appConfigDataSources[i].schema.fields[e.value].alias,type:"string",name:e.value})});const n=[];o.forEach(e=>{e.name&&n.push({fieldName:e.name,label:e.alias})});const c=[],d={type:"simple-fill",color:this.unt.resultAreaProperties.color.color,style:"solid",outline:{color:this.unt.resultAreaProperties.color.color,width:1}};e.forEach((e,t)=>{const i={};i.OBJECTID=t,o.forEach(t=>{const a=e.attributes[t.name];null!=a&&("date"===t.name?i[t.name]=a.toString():i[t.name]=a)});const a=new u.default({geometry:e.geometry,attributes:i,symbol:d});c.push(a)});const p=Object.assign({},a.defaultMessages),h={type:"simple",symbol:d},v=new l.default({id:i+"_layer",title:this.props.intl.formatMessage({id:"outputStatistics",defaultMessage:p.outputStatistics},{name:this.props.label}),fields:o,geometryType:"polygon",source:c,objectIdField:"OBJECTID",popupTemplate:{title:"{traceName}",fieldInfos:n,content:[{type:"fields",fieldInfos:n}]},renderer:h});s.layer=v,null==s||s.setStatus(t.DataSourceStatus.Unloaded),null==s||s.setCountStatus(t.DataSourceStatus.Unloaded),null==s||s.addSourceVersion()})}static getInstance(){return h.instance||(h.instance=new h),h.instance}loadPropsFromView(e){this.props=e}loadTraceWidgetFromAPI(e,t,i){return p(this,void 0,void 0,function*(){var a,o,r,n,l,u;null!==this.unt&&null!==this.unt.viewModel&&this.unt.viewModel.reset();let c=null;e.view.map.utilityNetworks&&(c=e.view.map.utilityNetworks.getItemAt(0));const d=new s.default({container:t,utilityNetwork:c,view:e.view,showSelectionAttributes:!0,selectOnComplete:!0,showGraphicsOnComplete:!0,selectedTraces:[],flags:[],enableResultArea:null===(r=null===(o=null===(a=this.props.config.configInfo)||void 0===a?void 0:a[e.dataSourceId])||void 0===o?void 0:o.traceResultAreaSettings)||void 0===r?void 0:r.enableResultArea,resultAreaProperties:null===(u=null===(l=null===(n=this.props.config.configInfo)||void 0===n?void 0:n[e.dataSourceId])||void 0===l?void 0:l.traceResultAreaSettings)||void 0===u?void 0:u.resultAreaProperties});return this.unt=d,this.activeDataSourceId=e.dataSourceId,this.appConfigDataSources=i,this.updatedConfig=this.props.config,yield this.loadAllChildDS(),this.registerEvents(),d})}updateUntProps(e,t,i,a){var s,o,r,n;null===(o=null===(s=this.unt)||void 0===s?void 0:s.set)||void 0===o||o.call(s,"enableResultArea",e),null===(n=null===(r=this.unt)||void 0===r?void 0:r.set)||void 0===n||n.call(r,"resultAreaProperties",t),this.appConfigDataSources=a,this.updatedConfig=i}registerEvents(){this.unt.on("create-result-area",()=>{const e=[];setTimeout(()=>{this.unt.viewModel.traceResults.forEach(t=>{t.resultAreaGraphic&&e.push(t.resultAreaGraphic)}),this.buildTraceResultStatsAsOutput(e)},500)}),this.unt.on("select-features",e=>{this.clearSelection(e);const i=this.getActiveMap(),a=null==i?void 0:i.jimuLayerViews,s=null==i?void 0:i.jimuTables,o=t.DataSourceManager.getInstance(),r={},n=[],l=[];e.resultSet.forEach(e=>{e&&e.forEach(e=>{for(const t in a){const i=o.getDataSource(a[t].layerDataSourceId);if(i&&("FEATURE_LAYER"===i.type||"SUBTYPE_SUBLAYER"===i.type)&&(i.layer.id===e.layer.id||"SUBTYPE_SUBLAYER"===i.type&&e.layer.layerId===parseInt(i.layerId))){const a=e.layer.objectIdField;r[t]||(r[t]={ds:i,objectIdList:[]}),e.featureSet.features.forEach(e=>{if("SUBTYPE_SUBLAYER"===i.type){const s=i.layer,o=s.subtypeField;e.attributes[o]!==s.subtypeCode&&e.attributes[o.toLowerCase()]!==s.subtypeCode||r[t].objectIdList.push(e.attributes[a])}else r[t].objectIdList.push(e.attributes[a])}),r[t].objectIdList.length>0&&(l.push(t),n.push(this.fetchRecords(i,r[t].objectIdList)))}}for(const t in s){const i=t.split("-").slice(1).join("-"),a=o.getDataSource(i);if(a&&("FEATURE_LAYER"===a.type||"SUBTYPE_SUBLAYER"===a.type)&&(a.layer.id===e.layer.id||"SUBTYPE_SUBLAYER"===a.type&&e.layer.layerId===parseInt(a.layerId))){const i=e.layer.objectIdField;r[t]||(r[t]={ds:a,objectIdList:[]}),e.featureSet.features.forEach(e=>{if("SUBTYPE_SUBLAYER"===a.type){const s=a.layer,o=s.subtypeField;e.attributes[o]!==s.subtypeCode&&e.attributes[o.toLowerCase()]!==s.subtypeCode||r[t].objectIdList.push(e.attributes[i])}else r[t].objectIdList.push(e.attributes[i])}),r[t].objectIdList.length>0&&(l.push(t),n.push(this.fetchRecords(a,r[t].objectIdList)))}}})}),Promise.all(n).then(e=>{let i=[];const a=[];if(l.forEach((t,s)=>{var o;if((null===(o=e[s])||void 0===o?void 0:o.length)>0){const o=r[t].ds;o.selectRecordsByIds(r[t].objectIdList.map(String),e[s],!0),i=i.concat(e[s]),a.push(o.id)}}),i.length>0){const e=new t.DataRecordsSelectionChangeMessage(this.props.id,i,a);t.MessageManager.getInstance().publishMessage(e)}})}),this.unt.on("clear-selection",e=>{var t;this.unt&&(null===(t=this.unt.view)||void 0===t||t.closePopup(),this.clearSelection(e))}),this.unt.on("reset",()=>{var e,i,a;this.unt&&(null===(a=this.getOutputDataSource(null===(i=null===(e=this.props)||void 0===e?void 0:e.outputDataSources)||void 0===i?void 0:i[0]))||void 0===a||a.setStatus(t.DataSourceStatus.NotReady))});const e=this.getFeatureLayerDS();if(null!==e){this.unt.utilityNetwork&&(this.unt.utilityNetwork.gdbVersion=e.getGDBVersion());let t=e.layer;"SUBTYPE_SUBLAYER"===e.type&&(t=e.parentDataSource.layer),o.watch(()=>t.gdbVersion,e=>{this.unt.utilityNetwork.gdbVersion=e})}}fetchRecords(e,t){return p(this,void 0,void 0,function*(){const i={};i.objectIds=t,i.returnGeometry=!0,i.outFields=["*"];const a=e,s=yield null==a?void 0:a.queryAll(i);return Promise.resolve(null==s?void 0:s.records)})}clearSelection(e){const i=this.getActiveMap();if(null!==i){const a=i.jimuLayerViews,s=t.DataSourceManager.getInstance();if(e.resultSet.length>0){const e=[];for(const t in a){if(!e.includes(a[t].layerDataSourceId)){const e=s.getDataSource(a[t].layerDataSourceId);e&&("FEATURE_LAYER"!==e.type&&"SUBTYPE_SUBLAYER"!==e.type||e.clearSelection())}e.push(a[t].layerDataSourceId)}}else for(const e in a){const t=s.getDataSource(a[e].layerDataSourceId);t&&("FEATURE_LAYER"!==t.type&&"SUBTYPE_SUBLAYER"!==t.type||t.clearSelection())}}}clearAll(){var e,i,a;let s=null;null===(i=null===(e=this.unt)||void 0===e?void 0:e.view)||void 0===i||i.closePopup();const o=null===(a=this.mvManager)||void 0===a?void 0:a.getAllJimuMapViewIds();null==o||o.forEach(e=>{var i;const a=null===(i=this.mvManager)||void 0===i?void 0:i.getJimuMapViewById(e);if(s=a,null!==s){const e=t.DataSourceManager.getInstance(),i=s.jimuLayerViews;for(const t in i){const a=e.getDataSource(i[t].layerDataSourceId);a&&("FEATURE_LAYER"!==a.type&&"SUBTYPE_SUBLAYER"!==a.type||a.clearSelection())}s.view.graphics.removeAll(),this.callResetOnJSWidget()}})}callResetOnJSWidget(){null!==this.unt&&null!==this.unt.viewModel&&null!==this.unt.viewModel._unObject&&this.unt.viewModel.reset()}getActiveMap(){var e;let t=null;if(this.props&&(null===(e=this.props.useMapWidgetIds)||void 0===e?void 0:e.length)>0){const e=this.mvManager.getJimuMapViewGroup(this.props.useMapWidgetIds);if(e&&e.jimuMapViews)for(const i in e.jimuMapViews)e.jimuMapViews[i].dataSourceId&&(e.jimuMapViews[i].isActive||void 0===e.jimuMapViews[i].isActive)&&(t=e.jimuMapViews[i])}return t}getFeatureLayerDS(){const e=this.getActiveMap();if(null!==e){const i=e.jimuLayerViews,a=t.DataSourceManager.getInstance();for(const e in i){const t=a.getDataSource(i[e].layerDataSourceId);if(!t)return null;if("FEATURE_LAYER"===t.type||"SUBTYPE_SUBLAYER"===t.type){const e=(t.type,t);if(e.getLayerDefinition().fields.some(e=>e.name.toLowerCase().includes("subnetworkname")))return e}}return null}return null}loadAllChildDS(){return p(this,void 0,void 0,function*(){const e=this.getActiveMap();if(e){yield e.whenAllJimuLayerViewLoaded();const i=t.DataSourceManager.getInstance().getDataSource(e.dataSourceId);return i.isDataSourceSet()&&!i.areChildDataSourcesCreated()&&(yield i.childDataSourcesReady()),!0}return!1})}getURLVersion(){const e=(0,t.getAppStore)().getState().queryObject;if(e&&(null==e?void 0:e.data_version)){e.data_version.split(",").forEach(e=>{const t=e.split(":");this.unt&&this.unt.utilityNetwork&&(this.unt.utilityNetwork.gdbVersion=t[1])})}}}const v={_widgetLabel:"Utility Network Trace",_widgetDescription:"A widget to trace an ArcGIS Utility Network",_action_filter_label:"Filter"};function g(e,i){const a=e.sys.color.surface.paper;return t.css`
    overflow: auto;
    width: 100%;
    height: 100%;
    background-color: ${a};
    .widget-utility-trace {
      width: 100%;
      height: 100%;
      background-color: ${a};
    }
    .esri-utility-network-trace__block-container {
      --calcite-font-family: ${e.sys.typography.body.fontFamily};
    }
    .esri-utility-network-trace__clear-results-block {
      width: 100%;
      h3 {
        font-family: ${e.sys.typography.body.fontFamily};
      }
    }
    calcite-scrim {
      height: 200px;
    }
  `}var f=c(14924),S=c.n(f),y=function(e,t,i,a){return new(i||(i=Promise))(function(s,o){function r(e){try{l(a.next(e))}catch(e){o(e)}}function n(e){try{l(a.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,n)}l((a=a.apply(e,t||[])).next())})};class m extends t.BaseWidget{constructor(e){var i;super(e),this.containerRef=t.React.createRef(),this.viewModel=h.getInstance(),this.onActiveViewChange=e=>{this.viewModel.loadPropsFromView(this.props),null!==e?(this.state.unt&&null!==this.state.unt&&(null!==this.state.unt.viewModel.utilityNetwork?(this.viewModel.clearAll(),this.state.unt.destroy()):this.state.unt.destroy()),this.setState({},()=>y(this,void 0,void 0,function*(){const t=document.createElement("div");t.className="trace-container",this.containerRef.current.innerHTML="",this.containerRef.current.appendChild(t);const i=yield this.viewModel.loadTraceWidgetFromAPI(e,t,this.props.dataSources);this.setState({unt:i,jmv:e,activeDataSource:e.dataSourceId},()=>{this.viewModel.loadAllChildDS(),this.viewModel.getURLVersion()})}))):(this.state.unt&&(null!==this.state.unt&&null!==this.state.unt.viewModel.utilityNetwork?(this.viewModel.callResetOnJSWidget(),this.viewModel.clearAll(),this.state.unt.destroy()):this.state.unt.destroy()),this.setState({unt:null,jmv:null}))},this.nls=e=>{var t;const i=Object.assign({},v);return(null===(t=this.props.intl)||void 0===t?void 0:t.formatMessage)?this.props.intl.formatMessage({id:e,defaultMessage:i[e]}):i[e]},this.componentDidUpdate=e=>{var i,a,s,o,r,n,l;if(window.jimuConfig.isInBuilder&&(null!==this.state.jmv?null!==this.state.unt&&this.props.config&&Object.prototype.hasOwnProperty.call(this.props.config,"configInfo")&&((null===(i=this.props.useMapWidgetIds)||void 0===i?void 0:i.length)>0?this.setState({unt:this.state.unt,hasMapWidget:!0}):this.onActiveViewChange(null)):this.setState({hasMapWidget:!1},()=>{this.viewModel.callResetOnJSWidget(),this.viewModel.clearAll()})),this.props.config&&Object.prototype.hasOwnProperty.call(this.props.config,"configInfo")){const i=null===(o=null===(s=null===(a=e.config)||void 0===a?void 0:a.configInfo)||void 0===s?void 0:s[this.state.activeDataSource])||void 0===o?void 0:o.traceResultAreaSettings,u=null===(l=null===(n=null===(r=this.props.config)||void 0===r?void 0:r.configInfo)||void 0===n?void 0:n[this.state.activeDataSource])||void 0===l?void 0:l.traceResultAreaSettings;(null==i?void 0:i.enableResultArea)===(null==u?void 0:u.enableResultArea)&&t.lodash.isDeepEqual(null==i?void 0:i.resultAreaProperties,null==u?void 0:u.resultAreaProperties)||this.viewModel.updateUntProps(null==u?void 0:u.enableResultArea,null==u?void 0:u.resultAreaProperties,this.props.config,this.props.dataSources)}},this.componentWillUnmount=()=>{this.viewModel.clearAll()},this.state={jmv:null,unt:null,hasMapWidget:(null===(i=this.props.useMapWidgetIds)||void 0===i?void 0:i.length)>0,activeDataSource:""}}render(){var s,o;return(0,e.jsxs)(a.Paper,{shape:"none",css:g(this.props.theme,this.props.config),className:"jimu-widget",children:[(0,e.jsx)("div",{ref:this.containerRef,css:this.state.hasMapWidget?t.css`
    height: 100%;
  `:""}),this.state.hasMapWidget?"":(0,e.jsx)(a.WidgetPlaceholder,{icon:S(),message:this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:v._widgetLabel}),widgetId:this.props.id}),(null===(s=this.props.useMapWidgetIds)||void 0===s?void 0:s.length)>0&&(0,e.jsx)(i.JimuMapViewComponent,{useMapWidgetId:null===(o=this.props.useMapWidgetIds)||void 0===o?void 0:o[0],onActiveViewChange:this.onActiveViewChange})]})}}m.mapExtraStateProps=e=>{var t;return{dataSources:null===(t=null==e?void 0:e.appConfig)||void 0===t?void 0:t.dataSources}};const w=m;function M(e){c.p=e}})(),d})())}}});