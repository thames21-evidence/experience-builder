"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_image-collection-explorer_node_modules_arcgis_imagery-compo-864ddc"],{1516:(e,t,i)=>{i.r(t),i.d(t,{ArcgisImageryProcessingTemplate:()=>f});var s=i(3074),r=i(2288),n=i(1925),a=i(588),o=i(3752),c=i(6744),l=i(1802),m=i(4345),u=i(459),h=(e=>(e[e.IDLE=0]="IDLE",e[e.PENDING=1]="PENDING",e[e.RESOLVED=2]="RESOLVED",e[e.REJECTED=3]="REJECTED",e))(h||{});const d={status:h.IDLE,data:null,error:null},g=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;const p=n.AH`:host{display:flex;height:100%;overflow:hidden}.beta-notice,.warning-notice{max-width:100%;text-align:center;padding:.5rem}.raster-function-thumbnail{height:100px;width:100px;padding:0 8px}.rft-item-loader{display:inline-flex;align-items:center;justify-content:center;width:100%}.loader-text{margin:0 1rem}.raster-function-thumbnail-error{width:100px;--calcite-icon-color: var(--calcite-color-status-danger)}`;class f extends r.WF{constructor(){super(...arguments),this._messages=(0,u.u)({blocking:!0}),this.showRFTItemBrowser=!1,this.rftItemData=d,this.closable=!1,this.showRendererWarning=!1,this.showItemBrowser=!1,this.hideButtons=!1,this.arcgisClose=(0,r.lh)()}static{this.properties={activeRasterFunctionName:16,customRasterFunction:16,showRFTItemBrowser:16,items:16,pagination:16,rftItemData:16,rasterFunctionInfos:16,layer:0,portal:0,panelHeading:1,closable:5,showRendererWarning:5,showItemBrowser:5,hideButtons:5}}static{this.styles=p}load(){this.init()}willUpdate(e){if(this.hasUpdated&&e.has("layer")&&(this.updateActiveRasterFunctionName(null),this.init()),this.hasUpdated&&e.has("customRasterFunction")){const t=e.get("customRasterFunction")?.thumbnail,i=this.customRasterFunction?.thumbnail;t!==i&&this.revokeThumbnailUrls([t])}if(this.hasUpdated&&e.has("rasterFunctionInfos")){const t=e.get("rasterFunctionInfos")?.map(({thumbnail:e})=>e),i=this.rasterFunctionInfos?.map(({thumbnail:e})=>e);t?.forEach(e=>{!i?.includes(e)&&this.revokeThumbnailUrls([e])})}}disconnectedCallback(){super.disconnectedCallback();const e=[this.customRasterFunction?.thumbnail];this.rasterFunctionInfos?.forEach(({thumbnail:t})=>{e.push(t)}),this.revokeThumbnailUrls(e)}async init(){const{layer:e}=this;await e.load(),this.saveOriginalValues(),this.rasterFunctionInfos=this.getRasterFunctionInfos(),this.loadThumbnailsProgressively();let t=this.originalRasterFunction?.functionName??this.rasterFunctionInfos[0]?.name??"None";t&&"None"!==t&&!this.rasterFunctionInfos.some(({name:e})=>e===t)?(this.customRasterFunction=this.createCustomRasterFunction(this.originalRasterFunction),t=this.customRasterFunction.name):this.customRasterFunction=void 0,this.updateActiveRasterFunctionName(t)}handleImportTemplate(){this.updateShowItemBrowser(!0)}handleCustomRFTAdd(e){this.fetchRFTItem(e)}handleDone(){this.saveOriginalValues(),this.arcgisClose.emit("save")}handleCancel(){const{layer:e,_messages:{custom:t}}=this;e.rasterFunction=this.originalRasterFunction,e.renderer=this.originalRenderer,e.activePresetRendererName=this.originalActivePresetRendererName,"imagery"===e.type&&e?.mosaicRule?.multidimensionalDefinition&&(e.mosaicRule.multidimensionalDefinition=this.originalMultidimensionalDefinition),e.bandIds=this.originalBandIds,e.multidimensionalSubset=this.originalMultidimensionalSubset;const i=this.rasterFunctionInfos?.find(({name:e})=>"none"===e?.toLocaleLowerCase());let s=this.originalRasterFunction?.functionName??i?.name;this.originalRasterFunction?.functionName&&!this.rasterFunctionInfos?.some(({name:e})=>e===s)&&(s=`${t}- ${s}`),this.activeRasterFunctionName=s,this.arcgisClose.emit("cancel")}updateActiveRasterFunctionName(e){this.activeRasterFunctionName=e}updateLayerRasterFunction(e){const{layer:t,customRasterFunction:i}=this;let s={functionName:e};if(e===i?.name&&(s=i?.function),"imagery-tile"===t.type)t.rasterFunction="none"===e?.toLowerCase()?null:s;else if(t.rasterFunction=s,t?.mosaicRule?.multidimensionalDefinition&&t.mosaicRule.multidimensionalDefinition[0]?.variableName!==e){const e=t.mosaicRule.multidimensionalDefinition.map(e=>(e.variableName="",e));t.mosaicRule.multidimensionalDefinition=e}this.activeRasterFunctionName=e;const r=t.presetRenderers?.find(t=>"raster-function-template"===t.method&&t.value===e);r?t.activePresetRendererName=r.name:(t.activePresetRendererName="",t.renderer=null),t.bandIds=r?.bandIds,t.multidimensionalSubset=null}updateCustomRasterFunction(e){const t=this.createCustomRasterFunction(e);this.customRasterFunction?.name!==t.name&&(this.customRasterFunction=t,this.updateActiveRasterFunctionName(t.name),this.updateLayerRasterFunction(t.name))}updateRFTItemApiData(e){this.rftItemData=e}updateShowItemBrowser(e){this.showRFTItemBrowser=e}async fetchRFTItem(e){if(this.updateRFTItemApiData({status:h.PENDING,data:null,error:null}),e?.id){try{const t=new o.default({id:e.id,portal:this.portal});let i;i=".rft.xml"===e?.name?.slice(-8)?.toLowerCase()?await this.convertRFTFormat(e.id,"json"):await t.fetchData("json");const s=c.default.fromJSON({rasterFunction:e?.title,rasterFunctionDefinition:i});await this.validateRFT(s),this.updateRFTItemApiData({status:h.RESOLVED,data:s,error:null}),this.updateCustomRasterFunction(s)}catch(e){this.updateRFTItemApiData({status:h.REJECTED,data:null,error:e instanceof Error?e.message:this._messages.errorRetrievingRFTItem})}this.updateShowItemBrowser(!1)}else this.updateRFTItemApiData({status:h.REJECTED,data:null,error:this._messages.errorRetrievingRFTItem})}async validateRFT(e){try{const{layer:t,_messages:i}=this,s=e.toJSON();if(!("imagery"===t.type?await(0,m.default)(t.url,{query:{f:"json",renderingRule:JSON.stringify(s?.rasterFunctionDefinition??s)}}):await t.generateRasterInfo(e)))throw new Error(i.rftValidationFailed)}catch(e){const{_messages:{rftValidationFailed:t,unsupportedFunction:i}}=this;let s=t;if(e instanceof Error){const r=e.message?.toLowerCase().indexOf("unsupported raster function:");r>-1&&(s=`${t} ${i.replace("${rasterFunction}",e.message.slice(r+28).trim())}`)}throw new Error(s)}}async convertRFTFormat(e,t){const i=this.portal.helperServices.rasterUtilities;if(!i)throw new Error(this._messages.rasterutilitySeverMissing);try{const s=`${i.url}/ConvertRasterFunctionTemplate`,r={inputRasterFunction:JSON.stringify({itemId:e}),format:t},n=await l.submitJob(s,r),a={interval:1500};await n.waitForJobCompletion(a);const o=(await n.fetchResultData("outputRasterFunction"))?.value;if(!o)throw new Error(this._messages.unsupportedFunction);return(await(0,m.default)(o.url)).data}catch{throw new Error(this._messages.errorRetrievingRFTItem)}}createCustomRasterFunction(e){const{_messages:{custom:t},layer:i,portal:s}=this,r=e?.rasterFunctionDefinition??e,{functionName:n}=e,{description:a,thumbnailEx:o,help:c}=r,l={name:`${t}- ${n}`,function:e,description:a,thumbnail:o,help:c,functionType:0};if(!o&&!g.test(o))if("imagery-tile"===i.type)l.thumbnail=`${s.sourceJSON?.staticImagesUrl}/rasterfunctiontemplate.png`;else{const e=this.getExportImageBaseURL(),t=`renderingRule=${encodeURIComponent(JSON.stringify(r))}`;l.thumbnail=`${e}&${t}`}return this.fetchAndProcessThumbnail(l,-1),l}async loadThumbnailsProgressively(){if(!this.rasterFunctionInfos)return;const e=this.rasterFunctionInfos.map((e,t)=>this.fetchAndProcessThumbnail(e,t));await Promise.allSettled(e)}async fetchAndProcessThumbnail(e,t){try{const i=`${this.layer.url}/exportImage`;if(!e.thumbnail.startsWith(i))return;const s=(await(0,m.default)(e.thumbnail,{responseType:"blob"}))?.data,r=URL.createObjectURL(s);if(this.customRasterFunction&&-1===t)return void(this.customRasterFunction={...this.customRasterFunction,thumbnail:r});e.thumbnail=r,this.rasterFunctionInfos=this.rasterFunctionInfos?[...this.rasterFunctionInfos]:null}catch{e.thumbnail=`${this.portal.sourceJSON?.staticImagesUrl}/rasterfunctiontemplate.png`,this.rasterFunctionInfos=this.rasterFunctionInfos?[...this.rasterFunctionInfos]:null}}revokeThumbnailUrls(e){e.forEach(e=>{const t=e?.startsWith("blob:");!e||!t||URL.revokeObjectURL(e)})}getRasterFunctionInfos(){const{type:e}=this.layer;return"imagery-tile"===e?[{name:"None",description:this._messages.noneRasterFunctionDescription,help:"",functionType:0,thumbnail:`${this.portal.sourceJSON?.staticImagesUrl}/rasterfunctiontemplate.png`}]:this.fixImageryRasterFunctionsThumbnail(this.layer.rasterFunctionInfos??[])}fixImageryRasterFunctionsThumbnail(e){const{layer:t,_messages:i}=this;if("imagery"!==t.type)return e;const s=this.getExportImageBaseURL();return e.map(e=>{const r="none"===e.name.toLowerCase(),n=((e,t)=>`${e}&renderingRule=${encodeURIComponent(`{"rasterFunction":"${t}" }`)}`)(s,e.name);if(r){const s=i.noneRasterFunctionDescription;let r=n;const a=t.bandIds;return null!=a&&a?.length>=3&&(r=`${n}+&bandIds=${a[0]},${a[1]},${a[2]}`),{...e,description:s,thumbnail:r}}const a=e.description??"";let o=e.thumbnail;return(!e.thumbnail||!g.test(e.thumbnail))&&(o=n),{...e,description:a,thumbnail:o}})}getExportImageBaseURL(){const{layer:e}=this;if(null==e?.fullExtent)return"";const t=e.fullExtent.clone(),i=e.fullExtent.width,s=e.fullExtent.height;if(i/s>=2||s/i>=2){const r=Math.min(i,s)/2,n=e.fullExtent.center;t.xmin=n.x-r,t.ymin=n.y-r,t.xmax=n.x+r,t.ymax=n.y+r}const r=`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`,n=a.default.findCredential(e.url)?.token,o=new URLSearchParams({bbox:r,token:n,size:"400,400",...e.customParameters,f:"image"});n||o.delete("token");const c=e.sourceJSON;return 2===c.bandCount&&c.serviceDataType?.includes("Vector")&&o.append("renderingRule",JSON.stringify({rasterFunction:"VectorFieldRenderer",rasterFunctionArguments:{MagnitudeBandID:0,DirectionBandID:1,IsUVComponents:"esriImageServiceDataTypeVector-UV"===c.serviceDataType,ReferenceSystem:1,MassFlowAngleRepresentation:0,SymbolTileSize:30,SymbolTileSizeUnits:100,CalculationMethod:"Vector Average",SymbologyName:"Single Arrow",MinimumMagnitude:1,MaximumMagnitude:-1,MinimumSymbolSize:40,MaximumSymbolSize:80},outputPixelType:"U8",variableName:"Raster"})),`${e.url}/exportImage?${o.toString()}`}saveOriginalValues(){const{layer:e}=this;this.originalRasterFunction=e.rasterFunction,this.originalRenderer=e.renderer,this.originalActivePresetRendererName=e.activePresetRendererName,"imagery"===e.type&&e?.mosaicRule?.multidimensionalDefinition&&(this.originalMultidimensionalDefinition=e.mosaicRule.multidimensionalDefinition),this.originalBandIds=e.bandIds,this.originalMultidimensionalSubset=e.multidimensionalSubset}render(){return n.qy`<calcite-flow>${this.showRFTItemBrowser?this.renderRFTBrowsePanel():this.renderTemplatePanel()}</calcite-flow>`}renderRFTBrowsePanel(){const{layer:e,rftItemData:t,_messages:i}=this,s=t.status===h.PENDING;return n.qy`<calcite-flow-item .heading=${i.chooseRasterFunctionTemplate} .loading=${!e}>${this.renderBack()}${s&&this.renderRFTItemLoader()||""}${this.renderRFTItemBrowser()}</calcite-flow-item>`}renderRFTItemBrowser(){const{portal:e,_messages:t,pagination:i}=this,s=`${function(e){const{customBaseUrl:t,portalHostname:i,urlKey:s}=e,{protocol:r}=window.location;return`${r}//${s?`${s}.${t}`:i}`}(e)}/home/`;return n.qy`<arcgis-item-browser api=4 .portal=${e} .config=${{baseUrl:s}} .q=${'type:"Raster function template"'} .user=${e.user} view=list @arcgisItemBrowserUpdate=${e=>{const{results:t,num:i,start:s,total:r}=e.detail;this.items=t,this.pagination={start:s,num:i,total:r}}} @arcgisItemBrowserLoading=${()=>this.items=[]}><arcgis-item-browser-top-bar slot=top-bar><arcgis-item-browser-bucket-select slot=bucket></arcgis-item-browser-bucket-select><arcgis-item-browser-search slot=search .placeholder=${t.itemBrowserPlaceholder} term></arcgis-item-browser-search></arcgis-item-browser-top-bar><arcgis-item-browser-sort slot=sort></arcgis-item-browser-sort><arcgis-item-browser-filters slot=filters><arcgis-item-browser-filter-extent></arcgis-item-browser-filter-extent><arcgis-item-browser-filter-folder></arcgis-item-browser-filter-folder><arcgis-item-browser-filter-categories></arcgis-item-browser-filter-categories><arcgis-item-browser-filter-date property=modified></arcgis-item-browser-filter-date><arcgis-item-browser-filter-date property=created></arcgis-item-browser-filter-date><arcgis-item-browser-filter-tags></arcgis-item-browser-filter-tags><arcgis-item-browser-filter-sharing></arcgis-item-browser-filter-sharing><arcgis-item-browser-filter-content-status></arcgis-item-browser-filter-content-status></arcgis-item-browser-filters><arcgis-item-browser-content slot=content>${this.items?.map(t=>n.qy`<arcgis-item-browser-card .baseUrl=${s} .item=${t} .portal=${e} preview=top show-date-updated show-owner show-thumbnail .user=${e.user}><calcite-button slot=actions-end appearance=transparent icon-start=plus-circle kind=neutral scale=s @click=${()=>this.handleCustomRFTAdd(t)}></calcite-button></arcgis-item-browser-card>`)}</arcgis-item-browser-content><arcgis-item-browser-pagination slot=pagination .total=${i?.total} .start=${i?.start} .num=${i?.num}></arcgis-item-browser-pagination></arcgis-item-browser>`}renderRFTItemLoader(){return n.qy`<div class="rft-item-loader"><calcite-loader inline label=rftItemLoader type=indeterminate></calcite-loader><div class="loader-text">${this._messages.rftItemLoaderText}</div></div>`}renderTemplatePanel(){const{layer:e,rftItemData:t,_messages:i,showRendererWarning:s,showItemBrowser:r,hideButtons:a,panelHeading:o,closable:c}=this,l="imagery-tile"===e.type,m=t.status===h.REJECTED;return e.loaded?n.qy`<calcite-flow-item .heading=${o??i.processingTemplates}>${c&&this.renderClose()||""}${l&&this.renderBetaNotice()||""}${s&&this.renderWarningNotice()||""}${r&&this.renderImportTemplateButton()||""}${m&&this.renderValidationError(t.error??i.errorRetrievingRFTItem)||""}${this.renderServerRasterFunctionsInfo()}${!a&&this.renderFooterActions()||""}</calcite-flow-item>`:n.qy`<calcite-flow-item loading .heading=${o??i.processingTemplates}></calcite-flow-item>`}renderBetaNotice(){return n.qy`<div class="beta-notice"><calcite-notice closable icon open scale=s><div slot=message>${this._messages.betaNotice}</div></calcite-notice></div>`}renderWarningNotice(){return n.qy`<div class="warning-notice"><calcite-notice closable icon kind=info open scale=s><div slot=message>${this._messages.warningNotice}</div></calcite-notice></div>`}renderImportTemplateButton(){return n.qy`<calcite-button appearance=transparent icon-start=plus @click=${this.handleImportTemplate}>${this._messages.importUserTemplate}</calcite-button>`}renderValidationError(e){return n.qy`<calcite-alert kind=danger .label=${e} open><div slot=title>${this._messages.validationErrorTitle}</div><div slot=message>${e}</div></calcite-alert>`}renderServerRasterFunctionsInfo(){const{customRasterFunction:e,rasterFunctionInfos:t,_messages:i}=this;return 0===t?.length?n.qy`<calcite-list .label=${i.processingTemplates}><calcite-list-item .description=${i.noRasterFunctions}></calcite-list-item></calcite-list>`:n.qy`<calcite-list .label=${i.processingTemplates} selection-mode=single-persist>${e?this.renderRasterFunctionInfo(e,t?.length??0):null}${t?.map((e,t)=>this.renderRasterFunctionInfo(e,t))}</calcite-list>`}renderRasterFunctionInfo(e,t){const{name:i,description:s,thumbnail:a}=e,o=s?.length>100,c=o,l=o?`${s.slice(0,100)}...`:s,m=`${i}_raster_function_info_${t}`,u=`${this.layer.url}/exportImage`,h=!a?.startsWith(u);return n.qy`<div>${c&&n.qy`<calcite-tooltip .referenceElement=${m} overlay-positioning=fixed placement=top>${s}</calcite-tooltip>`||""}<calcite-list-item id=${m??r.s6} .description=${l} .label=${i} .value=${i} .selected=${i===this.activeRasterFunctionName} @calciteListItemSelect=${()=>this.updateLayerRasterFunction(i)}><calcite-action slot=actions-start compact scale=s .text=${i} @click=${()=>this.updateLayerRasterFunction(i)}>${h?n.qy`<img src=${a??r.s6} class="raster-function-thumbnail">`:n.qy`<calcite-loader class="raster-function-thumbnail" label=loading scale=s></calcite-loader>`}</calcite-action></calcite-list-item></div>`}renderBack(){const e="raster-processing-template-back-action";return n.qy`<calcite-action id=${e} .text=${this._messages.back} scale=s slot=header-actions-start @click=${()=>this.updateShowItemBrowser(!1)}><calcite-icon scale=s icon=chevron-left></calcite-icon><calcite-tooltip .referenceElement=${e} slot=tooltip>${this._messages.back}</calcite-tooltip></calcite-action>`}renderClose(){return n.qy`<calcite-action .text=${this._messages.close} scale=s slot=header-actions-end @click=${this.handleCancel}><calcite-icon scale=m icon=x></calcite-icon></calcite-action>`}renderFooterActions(){return n.qy`${this.renderDoneButton()}${this.renderCancelButton()}`}renderDoneButton(){return n.qy`<calcite-button slot=footer width=half @click=${this.handleDone}>${this._messages.done}</calcite-button>`}renderCancelButton(){return n.qy`<calcite-button slot=footer appearance=outline-fill width=half @click=${this.handleCancel}>${this._messages.cancel}</calcite-button>`}}(0,s.c)("arcgis-imagery-processing-template",f)}}]);