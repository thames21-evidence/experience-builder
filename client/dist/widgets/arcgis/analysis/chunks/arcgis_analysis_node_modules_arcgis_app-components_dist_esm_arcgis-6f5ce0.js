/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-6f5ce0.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-6f5ce0"],{6750:(e,i,t)=>{function a(e){var i,t;const{dataLayer:a,type:l,sourceDataLayer:n}=e,o=null!==(i=null==a?void 0:a.geometryType)&&void 0!==i?i:null===(t=null==a?void 0:a.layerInfo)||void 0===t?void 0:t.geometryType,r="table"===(null==n?void 0:n.type.toLowerCase()),s=null==a?void 0:a.type;if("Microsoft Excel"===l||"CSV"===l){if(("address"===a.locationType&&a.addressFields||"coordinates"===a.locationType)&&"esriGeometryPoint"===(null==n?void 0:n.geometryType))return null;if(!o||"none"===a.locationType||r)return{title:"noGeometryMatchTitle",description:"noGeometryTableMessage"};if((null==n?void 0:n.geometryType)!==o)return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"}}else{if((null==n?void 0:n.geometryType)!==(null==a?void 0:a.geometryType))return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"};if(r&&"table"===s.toLowerCase())return{title:"noGeometryMatchTitle",description:"noGeometryTableMessage"};if(r)return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"}}}function l(e,i,t){return"Microsoft Excel"===t||"CSV"===t?"Table"===(null==i?void 0:i.type)||("esriGeometryPoint"===(null==i?void 0:i.geometryType)&&"none"===(null==e?void 0:e.locationType)||"esriGeometryPoint"===(null==i?void 0:i.geometryType)&&(!!e.addressFields||"none"!==e.locationType)):"Table"===(null==i?void 0:i.type)||(null==e?void 0:e.geometryType)===(null==i?void 0:i.geometryType)}t.d(i,{c:()=>l,v:()=>a})},10556:(e,i,t)=>{t.d(i,{a:()=>s,b:()=>d,f:()=>n,i:()=>r,m:()=>o});var a=t(4429),l=t(15912);function n(e,i){let t;t=i?i.map(e=>e.type):Object.keys(l.a);let a=[];return t.forEach(i=>{var t;(null===(t=l.a[i].fileExt)||void 0===t?void 0:t.indexOf(e))>=0&&a.push(l.a[i])}),a}function o(e){return e?(0,a.b)(e.flatMap(e=>{var i;return null===(i=l.a[e])||void 0===i?void 0:i.fileExt}).filter(e=>!!e)):null}const r=e=>e/1024/1024>50,s=e=>e/1024/1024>20,d=e=>e/1024/1024>10},14188:(e,i,t)=>{t.r(i),t.d(i,{arcgis_new_item_pages_append_upload:()=>T});var a=t(87849),l=t(59317),n=t(24869),o=t(72257),r=t(74695),s=t(84454),d=t(3826),c=t(1536),p=t(12906),u=t(95878),y=t(44069),h=t(15912),v=t(10556),m=t(6750),g=t(88878),f=t(69280);t(37762),t(86562),t(15332),t(54251),t(27137),t(41473),t(931),t(93814),t(76246),t(58573),t(83692),t(29599),t(60958),t(32478),t(54077),t(1654),t(46904),t(10578),t(98704),t(82149),t(8417),t(50315),t(26262),t(26854),t(62645);async function b(){try{await(0,c.d)(d.a.id,{permanentDelete:!0}),d.a.id=null}catch(e){console.warn("Delete item failed",e)}}const T=class{constructor(e){(0,a.r)(this,e),this.fileSelect=(0,a.c)(this,"fileSelect",7),this.newItemUpdatePage=(0,a.c)(this,"newItemUpdatePage",7),this.newItemToggleNavigationEnabled=(0,a.c)(this,"newItemToggleNavigationEnabled",7),this.newItemPrevPage=(0,a.c)(this,"newItemPrevPage",7),this.workflowComplete=(0,a.c)(this,"workflowComplete",7),this.sourceName="",this.itemTypes=[{value:"File Geodatabase",icon:"data",publishable:!0},{value:"Shapefile",icon:"file-zip",publishable:!0}],this.insideModal=!0,this.fullHeight=!0,this.selectedZipFile="File Geodatabase",this.step="upload",this.loading=void 0,this.loaderMessage=void 0,this.loaderType="indeterminate",this.error=void 0,this.overwriteProcess=!1,this.file=void 0,this.header=void 0,this.description=void 0}async handlePrev(e){if(e.preventDefault(),!this.loading){if("analyzeZip"===this.step)return d.a.file=null,void(this.step="upload");d.a.appendOptions.layers.length>1&&(d.a.sourceDataLayer=null),this.newItemPrevPage.emit()}}async handleNext(){var e;if(this.overwriteProcess&&"overwrite"===d.a.addAppendSelectOption){const{addAppendSelectOption:i}=d.a,t=Object.assign({id:null===(e=this.publishResponse)||void 0===e?void 0:e.id,appendType:i,item:Object.assign({},d.a),overwriteStatus:this.overwriteStatus},this.publishResponse);return void this.workflowComplete.emit(t)}if(d.a.file){if("zip"===d.a.extension)if(this.step="analyzeZip",d.a.type=h.a[this.selectedZipFile].type,"overwrite"===d.a.addAppendSelectOption)d.a.id=this.item.id,await this.handleOverwrite();else{await this.uploadAndAnalyzeFile()&&this.nextStep()}}else this.handleError({code:"providePath"})}async fileSelectHandler(e){var i;const t=e.detail.file;d.a.originalFileName=t.name;const{title:a,fileName:l,extension:o}=(0,n.s)(t,!0);if("overwrite"===d.a.addAppendSelectOption&&!(0,n.v)(d.a.originalFileName,this.sourceName))return void this.handleError({code:"useSameFileName"});if(d.a.initialTitle=a,d.a.file=t,d.a.fileName=l,d.a.newItemMode="file",d.a.extension=o,d.a.type="zip"===d.a.extension&&this.isEnterprise?"Shapefile":(0,v.f)(o,this.validTypes)[0].type,d.a.addAsUniqueFile=!0,"esriGeometryMultiPatch"===(null===(i=d.a.sourceDataLayer)||void 0===i?void 0:i.geometryType)&&"File Geodatabase"!==d.a.type&&"Shapefile"!==d.a.type&&"update"!==d.a.addAppendSelectOption)return this.step="upload",void this.handleError({code:"multiPatchRestriction"});const s=(null==t?void 0:t.size)>r.M&&"zip"===d.a.extension,c="overwrite"!==d.a.addAppendSelectOption&&!this.isEnterprise,p="overwrite"===d.a.addAppendSelectOption&&(null==t?void 0:t.size)>r.M;if("overwrite"!==d.a.addAppendSelectOption||s)if("zip"===d.a.extension&&(c||p))this.step="analyzeZip";else{this.step="analyze";await this.uploadAndAnalyzeFile()&&this.nextStep()}else await this.handleOverwrite()}async componentWillLoad(){var e,i;const{existingItem:t,addAppendSelectOption:a}=d.a,{config:n,portal:o}=l.c;this.item=t,this.sourceName=(null===(e=d.a.appendOptions.sourceData)||void 0===e?void 0:e.name)||this.item.name,this.i18n=u.u.i18n.appendUpload,this.config=n,this.isEnterprise=o.isPortal;const r=null===(i=d.a.appendOptions.sourceData)||void 0===i?void 0:i.type;this.allowedExtensions="overwrite"===a?(0,v.m)(["geojson"===r.toLowerCase()?"GeoJson":r]):o.isPortal?y.c:y.d,this.header=this.i18n.selectData,this.description="",this.validTypes=Object.values(h.a).filter(e=>e.appendUploadFormat),"overwrite"===a&&this.validTypes.push(h.a["Service Definition"]),d.a.id&&await b(),d.a.file=null}async handleOverwrite(){var e;const{existingItem:i,file:t,keepDescription:a,fileName:n,appendOptions:r}=d.a;u.u.nextText="proceed";const s=i;this.loading=!0,this.overwriteProcess=!0,this.newItemToggleNavigationEnabled.emit(!1),this.loaderMessage=u.u.i18n.append.appendLoadingMessages.overwriting;const c=(0,g.g)(await(0,g.f)(this.item.owner,l.c.portal),l.c.portal),{error:y}=await(0,p.f)(r.sourceData,c,{file:t,overwrite:!0,keepDescription:a,fileName:n,existingItemId:s.id});if(y)return this.handleError(y),this.loading=!1,!1;try{const{result:t,error:a}=await(0,p.p)(i,null!==(e=o.i.title)&&void 0!==e?e:d.a.initialTitle,l.c.portal,l.c.user,d.a.appendOptions);if(a)throw a;this.publishResponse=t,this.updateAndCheckStatus(s)}catch(y){return this.handleError({code:"unhandledError"}),this.loading=!1,!1}}async updateAndCheckStatus(e){var i;const{result:t}=await(0,p.r)(e);this.newItemToggleNavigationEnabled.emit(!0);const a=await(0,r.g)(e.id,{success:null==t?void 0:t.success});this.overwriteStatus=null==a?void 0:a.status;const l=Object.assign({id:null===(i=this.publishResponse)||void 0===i?void 0:i.id,item:Object.assign({},d.a),overwriteStatus:this.overwriteStatus,appendType:d.a.addAppendSelectOption},this.publishResponse);if("completed"===(null==a?void 0:a.status.toLowerCase()))return l.overwriteStatus=null==a?void 0:a.status,void this.workflowComplete.emit(l);"failed"===(null==a?void 0:a.status.toLowerCase())&&(u.u.nextText="next",this.loading=!1,this.handleError({code:"unhandledError"}))}nextStep(){var e,i,t;let a="appendSelectLayer";const{analyzeResults:l}=d.a,n=l.publishParameters;if(1===(null===(e=l.publishParameters.layers)||void 0===e?void 0:e.length)||!l.publishParameters.layers){d.a.dataLayer=null!==(t=null===(i=null==n?void 0:n.layers)||void 0===i?void 0:i[0])&&void 0!==t?t:n;const e=(0,f.a)(d.a.type,d.a.dataLayer,d.a.sourceDataLayer);if("update"!==d.a.addAppendSelectOption){if(!(0,m.c)(d.a.dataLayer,d.a.sourceDataLayer,d.a.type))return void this.handleError({code:"incompatibleGeometries"})}a="Microsoft Excel"!==d.a.type&&"CSV"!==d.a.type||"esriGeometryPoint"!==(null===d.a||void 0===d.a?void 0:d.a.sourceDataLayer.geometryType)||"Table"===(null===d.a||void 0===d.a?void 0:d.a.sourceDataLayer.type)?"add"!==d.a.addAppendSelectOption||(e||d.a.backupLayerFields.some(e=>"esriFieldTypeDate"===e.type))&&!this.isEnterprise?"appendKeyPairSelect":"appendMatchFields":"csvLocationFields"}this.newItemToggleNavigationEnabled.emit(!0),this.newItemUpdatePage.emit(a)}updateLoader(e,i){this.loaderType=e,this.loaderMessage=i}async uploadAndAnalyzeFile(){const{file:e,originalFileName:i,type:t}=d.a,{portal:a,user:n,config:o,lang:c}=l.c;this.loading=!0,this.newItemToggleNavigationEnabled.emit(!1),this.updateLoader((null==e?void 0:e.size)>r.M?"determinate":"indeterminate",u.u.i18n.append.appendLoadingMessages.uploading.replace("${fileName}",i));let p=null;return({error:p}=await(0,r.y)()),p?(this.handleError(p),!1):(this.updateLoader("indeterminate",this.i18n.analyzing),({error:p}=await(0,s.a)({analyzeArgs:{type:"item",itemid:d.a.id,workflow:"append"},itemArgs:{itemType:t},configArgs:{portal:a,user:n,config:o,lang:c},initialize:!0})),p&&(this.handleError(p),d.a.id&&await b()),!p)}async handleError(e){this.newItemToggleNavigationEnabled.emit(!0);let i=u.u.i18n.error,t=this.i18n.errors.errorWhileUpload;switch(e.code){case"exceedsFileSize":t=this.i18n.errors.errorExceedFileSize;break;case"invalidFileGeodatabase":i=u.u.i18n.itemProperties.invalidGeodatabase.title,t=u.u.i18n.itemProperties.invalidGeodatabase.description;break;case"invalidShapefile":i=u.u.i18n.itemProperties.invalidShapefile.title,t=u.u.i18n.itemProperties.invalidShapefile.description;break;case"useSameFileName":t=this.i18n.errors.sameFileName.replace("${x}",this.sourceName);break;case"providePath":t=this.i18n.errors.providePath;break;case"incompatibleGeometries":i=u.u.i18n.appendSelectLayer.sameGeometryWarningTitle,t=u.u.i18n.appendSelectLayer.sameGeometryWarningDescription;break;case"multiPatchRestriction":i=u.u.i18n.appendSelectLayer.sameGeometryWarningTitle,t=this.i18n.errors.multiPatchErrorDescription;break;case"unhandledError":"overwrite"===d.a.addAppendSelectOption&&(t=this.i18n.errors.errorUpdate)}("incompatibleGeometries"===e.code||"multiPatchRestriction"===e.code&&d.a.id)&&(d.a.file=null,await b()),this.loading=!1,this.error={title:i,description:t}}renderPickZip(){const e=this.itemTypes.map(({value:e,icon:i})=>({optionTitle:this.i18n[e].title,value:e,description:this.i18n[e].description,icon:i}));return(0,a.h)("calcite-label",{class:"zip-select"},(0,a.h)("div",{class:"zip-select-heading"},this.i18n.itemType),(0,a.h)("div",{class:"w-full"},(0,a.h)("div",{class:"w-full"},(0,a.h)("calcite-tile-group",{label:this.i18n.itemType,layout:"vertical",selectionMode:"single-persist"},Object.keys(e).map(i=>{const{icon:t,value:l,optionTitle:n,description:o}=e[i];return(0,a.h)("calcite-tile",{key:l,selected:l===this.selectedZipFile,heading:n,description:o,icon:t,"input-enabled":!0,"data-value":l,onCalciteTileSelect:e=>{this.selectedZipFile=e.target.dataset.value}})})))))}render(){const{i18n:e,error:i,loaderType:t,loaderMessage:l,step:n,loading:o,config:r,sourceName:s,validTypes:c,allowedExtensions:p,isEnterprise:u}=this,y="overwrite"===d.a.addAppendSelectOption;y&&(this.header=e.selectData,this.description=e.sameFileNameDescription.replace("${fileName}",s));const h=u&&y?"120004189":"120001300",v=`${r.helpBase}${r.helpMap[h]}`;return(0,a.h)(a.H,{key:"6fdfd2ad80f5f30ffc2ca6af8ea4d01926929523",class:{"overflow-hidden":o}},(0,a.h)("arcgis-new-item-loader",{key:"bec43e5bd1158a7dce77d8b09391c950155a38e2",type:t,active:o,text:l,value:Math.min(d.a.uploadProgress,99)}),"analyzeZip"!==n&&(0,a.h)("div",{key:"ac59734f658e373677409e151d76a5231d38e603",class:{"upload-step":!0,"upload-step--header-with-description":y}},(0,a.h)("arcgis-new-item-description",{key:"28eec854def52df6257de2116ef598bfe8d441de",header:this.header,content:this.description})),"analyzeZip"!==n&&(0,a.h)("div",{key:"146d80acd4efd498d852a740f923a207f551d606",class:{"file-browser-container":!0,"file-browser-container--has-description":y}},(0,a.h)("arcgis-file-browser",{key:"9c5cd09da5e49f00c6e198c4c64d23b3876330df",cloud:!1,validTypes:c,allowedExtensions:p,insideModal:!0,config:r,helpText:e.learnMore,helpLink:v,helpIdType:"append",fullHeight:!0})),"analyzeZip"===n&&(0,a.h)("div",{key:"11f56503242c823b95441747ad790191c648f1fb",class:"analyze-step"},(0,a.h)("arcgis-new-item-input-readonly",{key:"cb8bea49cac6bc01b5487aec651163a5dd4147ed",label:e.file}),"zip"===d.a.extension&&this.renderPickZip()),(0,a.h)("arcgis-new-item-alert",{key:"d6b6d54d3ed0899378cf912d876c75fc7e6604ec",heading:null==i?void 0:i.title,description:null==i?void 0:i.description,link:{href:null==i?void 0:i.link,title:null==i?void 0:i.linkText},active:!!i,onAlertDismiss:()=>this.error=null}))}get el(){return(0,a.a)(this)}};T.style=":host{overflow:hidden}.file-browser-container{display:block;height:95%}.file-browser-container--has-description{display:block;height:90%}.upload-step{margin-bottom:0px;display:block}.upload-step--header-with-description{margin-bottom:0.75rem;display:block}.read-only{z-index:50;display:block}.zip-select-heading{font-weight:500}calcite-tile-group{inline-size:100%}calcite-tile{max-inline-size:100%;min-inline-size:100%}"},69280:(e,i,t)=>{t.d(i,{a:()=>c,c:()=>s,g:()=>d,h:()=>p});var a=t(3826),l=t(54077),n=t(15912),o=t(95878),r=function(e,i){var t={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&i.indexOf(a)<0&&(t[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var l=0;for(a=Object.getOwnPropertySymbols(e);l<a.length;l++)i.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(e,a[l])&&(t[a[l]]=e[a[l]])}return t};function s(e,i){var t;const a=(null==e?void 0:e.type)||null,l=(null==i?void 0:i.type)||null;return l&&(l===a||(null===(t={esriFieldTypeSmallInteger:["esriFieldTypeSmallInteger"],esriFieldTypeInteger:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],esriFieldTypeSingle:["esriFieldTypeSingle","esriFieldTypeDouble"],esriFieldTypeDouble:["esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeBigInteger"],esriFieldTypeDate:["esriFieldTypeDate"],esriFieldTypeString:["esriFieldTypeString","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset","esriFieldTypeBigInteger"],esriFieldTypeGUID:["esriFieldTypeGUID","esriFieldTypeString"],esriFieldTypeOID:["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger"],esriFieldTypeGlobalID:["esriFieldTypeGlobalID","esriFieldTypeGUID","esriFieldTypeString"],esriFieldTypeDateOnly:["esriFieldTypeDateOnly"],esriFieldTypeTimeOnly:["esriFieldTypeTimeOnly"],esriFieldTypeTimestampOffset:["esriFieldTypeTimestampOffset"],esriFieldTypeBigInteger:["esriFieldTypeBigInteger"]}[a])||void 0===t?void 0:t.includes(l)))}function d(e){var i;const{timezone:t,analyzeResults:s,type:d,fieldMappings:c,dataLayer:p,id:u,portal:y,uidPair:h,addAppendSelectOption:v,sourceDataLayer:m,attachmentsEnabled:g,insertAttachmentsEnabled:f,featureAttachmentOption:b}=e;let T,F;const{publishParameters:w}=s,S=r(s,["publishParameters"]),O="upsert"===v||"update"===v,P=function(e){const i=e.filter(e=>e.source!==`<${o.u.i18n.appendKeyValuePair.noneField}>`),t=i.map(({source:e,name:i})=>({source:e,name:i}));return t}(c),k=function(e){const i=e.map(e=>e.name);return i}(P),x={dateFieldsTimeReference:Object.assign(Object.assign({},(null==y?void 0:y.isPortal)?{timeZone:t||"UTC"}:{ianaTimeZone:t||"GMT"}),{respectsDaylightSaving:!0})},G={sourceTableName:p.name,fieldMappings:(null==P?void 0:P.length)?JSON.stringify(P):null,upsert:O,skipInserts:"update"===v,skipUpdates:!1,useGlobalIds:O&&"esriFieldTypeGlobalID"===(null==h?void 0:h.type),updateGeometry:!O||"attributeAndGeometry"===a.a.addAppendSelectUpdateTypeOption,appendFields:k.length?JSON.stringify(k):null,appendItemId:u,appendUploadFormat:n.a[a.a.type].appendUploadFormat,rollbackOnFailure:!0};"Table"===m.type&&(w.locationType="none");const I=r(w,["layers"]);if("CSV"===d)w.layerInfo.dateFieldsTimeReference=x.dateFieldsTimeReference,F=Object.assign(Object.assign(Object.assign({},x),w),S);else if("Microsoft Excel"===d){const e=function(e,i){const t=Object.assign({},e);t.locationType=(null==i?void 0:i.locationType)||e.locationType,"address"===t.locationType?(t.addressFields=i.addressFields,t.sourceCountry=i.sourceCountry):"coordinates"===t.locationType&&(t.coordinateFieldType=i.coordinateFieldType,"LatitudeAndLongitude"===t.coordinateFieldType?(t.latitudeFieldName=i.latitudeFieldName,t.longitudeFieldName=i.longitudeFieldName):t.coordinateFieldName=i.coordinateFieldName);return t}((0,l.a)({},!0),I);e.dateFieldsTimeReference=x.dateFieldsTimeReference,I.name=p.name,F=Object.assign(Object.assign(Object.assign(Object.assign({},x),{layers:[e]}),I),S)}else F=Object.assign(Object.assign(Object.assign({},x),w),S);return T=Object.assign(Object.assign(Object.assign({},G),{appendSourceInfo:JSON.stringify(F)}),g&&function({insertAttachmentsEnabled:e}){return e?{skipAttachmentInserts:!1,skipAttachmentUpdates:!0,skipAttachmentDeletes:!0}:{skipAttachmentInserts:!0,skipAttachmentUpdates:!0,skipAttachmentDeletes:!0}}({appendType:v,insertAttachmentsEnabled:f,featureAttachmentOption:b})),"add"===v?T.upsertMatchingField=m.objectIdField||(null===(i=m.uniqueField)||void 0===i?void 0:i.name):O&&(null==h?void 0:h.isUniqueIndex)&&(T.upsertMatchingField=null==h?void 0:h.name),T}function c(e,i,t){return"File Geodatabase"===e&&t.hasAttachments&&i.hasAttachments}function p(e,i){const t=i.appendErrorMessages;let a=o.u.i18n.error,l=t.appendError;switch(e.code){case"invalidUniqueIdentifier":a=t.invalidUniqueIdentifier.title,l=t.invalidUniqueIdentifier.description;break;case"cannotAddNullData":a=t.cannotAddNullData.title,l=t.cannotAddNullData.description;break;case"exceededMaxFieldLength":a=t.exceededMaxFieldLength.title,l=t.exceededMaxFieldLength.description;break;case"invalidFieldType":a=t.invalidFieldType.title,l=t.invalidFieldType.description}return{title:a,description:l}}},84454:(e,i,t)=>{t.d(i,{a:()=>p,g:()=>c,s:()=>u});var a=t(3826),l=t(44069),n=t(54077),o=t(10578),r=t(41473),s=t(83692);function d(e,i,t,a){var l,n,o,r;const s=null!==(l=i.latitudeFieldName)&&void 0!==l?l:t.latitudeFieldName,d=null!==(n=i.longitudeFieldName)&&void 0!==n?n:t.longitudeFieldName,c=null!==(o=i.coordinateFieldName)&&void 0!==o?o:t.coordinateFieldName,p=null!==(r=i.coordinateFieldType)&&void 0!==r?r:t.coordinateFieldType;return a[e.name]?a[e.name]:e.name===c?null==p?void 0:p.toLowerCase():e.name===s?"latitude":e.name===d?"longitude":e.locationType||"unknown"}const c=(e,i)=>{if(!i)return e;const{layers:t,tables:a}=i;return"Map Service"===e&&!(null==t?void 0:t.length)&&(null==a?void 0:a.length)?"Feature Service":e};async function p({analyzeArgs:e,configArgs:i,itemArgs:t,initialize:c}){var p,h,v,m;const{config:g,lang:f,portal:b,user:T}=i,{itemType:F,ignoreV2FieldTypesVersion:w}=t;if(c&&(0,o.o)(T)){const e=(0,n.b)(null!==(h=null===(p=b.helperServices)||void 0===p?void 0:p.geocode)&&void 0!==h?h:[],T,b.isPortal);if(e&&(a.a.allowGeocode=e.allowGeocode,a.a.isAgoWorldGeocodeServer=e.isAgoWorldGeocodeServer,a.a.isServiceProxyAgoWorldGeocodeServer=e.isServiceProxyAgoWorldGeocodeServer,a.a.isWorldGeocodeServer=e.isWorldGeocodeServer,a.a.geocodeServers=e.geocodeServers,a.a.geocodeServiceUrl=e.geocodeServiceUrl),a.a.geocodeServers){a.a.sourceCountry=(0,n.d)(T.region,b.ipCntryCode);try{a.a.countryCodes=await async function(e,i,t){const a=(0,n.f)(e,t);let l;if(null==a?void 0:a.itemId){const e=`${i}/content/items/${a.itemId}`,t=await(0,s.r)(e),n=t.proxyFilter&&JSON.parse(t.proxyFilter).sourceCountry;n&&(l=n.split(",").map(e=>e.toLowerCase()),l.push("world"))}return Object.keys(n.c).map(e=>({label:n.c[e],value:e})).filter(({value:e})=>!l||l.includes(e.toLowerCase())).sort((e,i)=>e.label<i.label?-1:e.label>i.label?1:0)}(a.a.geocodeServiceUrl,g.restBaseUrl,a.a.geocodeServers),a.a.standardizedFieldNames=await y(a.a.geocodeServiceUrl,f)}catch(e){return console.error("Geocoder unavailable",e),{error:{code:"unavailableGeocoder"}}}}}const{locationType:S,isWorldGeocodeServer:O,geocodeServiceUrl:P,geocodeServers:k,isServiceProxyAgoWorldGeocodeServer:x,sourceCountry:G,analyzeResults:I,analyzedLocationTypes:z}=a.a,N=`${g.restBaseUrl}content/features/analyze`,{isPortal:D}=b;let A,L=!1;"item"===(null==e?void 0:e.type)&&"append"===e.workflow?(A=l.a[F],L=!0):A="Microsoft Excel"===F?"excel":F.toLowerCase();const M="file"===(null==e?void 0:e.type)&&e.analyze3DData;let C={filetype:A};switch(null==e?void 0:e.type){case"url":C.sourceUrl=e.sourceUrl;break;case"item":C.itemid=e.itemid;break;case"file":C=new FormData,C.append("file",e.file),C.append("filetype",M&&"File Geodatabase"===t.itemType?"fileGeodatabase":A);break;case"text":C.text=e.text}if(!M)if(D&&P||!D){const e={enableGlobalGeocoding:!0,sourceLocale:f,locationType:S,returnEstimatedRowCount:!0,returnSize:!0};if(w||(e.fieldTypesVersion="V2"),(D||!D&&(null==k?void 0:k.length))&&(e.geocodeServiceUrl=encodeURI(P)),I||D){const i="address"===S?"addressTypes":"locationTypes";-1===z.indexOf(i)&&z.push(i),e.locationType=S||"coordinates"}(!b.isPortal&&O||b.isPortal&&x)&&(e.sourceCountryHint=I?"":G.toLowerCase(),e.sourceCountry=I?G.toLowerCase():"");const i=JSON.stringify(e);C instanceof FormData?C.append("analyzeParameters",i):C.analyzeParameters=i}else w||(C instanceof FormData?C.append("analyzeParameters",JSON.stringify({fieldTypesVersion:"V2"})):C.analyzeParameters=JSON.stringify({fieldTypesVersion:"V2"}));try{const e=await(C instanceof FormData?(0,s.a)(N,C,{},"post"):(0,s.r)(N,C,{},"post"));if(M){if(!function(e){var i;const t=null==e?void 0:e.publishParameters,a=null===(i=null==t?void 0:t.layers)||void 0===i?void 0:i[0],l=null==a?void 0:a.infoFor3D,n="esriGeometryMultiPatch"===(null==a?void 0:a.geometryType);return l&&n}(e))return{error:{code:"invalid3DObjectFeatureClass"}}}else!async function({response:e,analyzeSelectedLayer:i,initialize:t,geocodeServiceUrl:l,lang:o,portal:c,itemType:p}){var y,h,v,m,g,f;const b=a.a,T=c.isPortal,F="Microsoft Excel"===p,w=F?null!==(h=null===(y=e.publishParameters.layers)||void 0===y?void 0:y[b.selectedSheet])&&void 0!==h?h:null===(v=e.publishParameters.layers)||void 0===v?void 0:v[0]:e.publishParameters;let S;if(!T&&b.isWorldGeocodeServer||T&&b.isServiceProxyAgoWorldGeocodeServer){const e=null!=w.sourceCountry;S=b.sourceCountry||w.sourceCountry||"world",S="wo"===S?"world":S,a.a.isWorldGeocodeServer=e,a.a.sourceCountry=S}b.allowGeocode||"address"!==w.locationType||(a.a.locationType="none");!function(e){var i,t,l,n,o,r;const{selectedSheet:s}=a.a,{publishParameters:c}=e,p=null!==(n=null!==(t=null===(i=c.layers)||void 0===i?void 0:i[s])&&void 0!==t?t:null===(l=c.layers)||void 0===l?void 0:l[0])&&void 0!==n?n:c.layerInfo;if(!p)return e;const u=null!==(r=null!==(o=p.addressFields)&&void 0!==o?o:c.addressFields)&&void 0!==r?r:{},y=Object.keys(u).reduce((e,i)=>Object.assign(Object.assign({},e),{[u[i]]:i}),{});p.fields=p.fields.map(e=>Object.assign(Object.assign({},e),{locationType:d(e,p,c,y)})),a.a.selectedFields&&(a.a.selectedFields=Object.keys(a.a.selectedFields).reduce((e,i)=>{const t=a.a.selectedFields[i];return e[i]=Object.assign(Object.assign({},t),{locationType:d(t,p,c,y)}),e},{}))}(e);const O=function(e){return function(e,i){var t,a,l,n;const{selectedFields:o,type:r,selectedSheet:s}=i;if(!o)return e;const d=e.publishParameters;let c=null==d?void 0:d.layerInfo;switch(r){case"Microsoft Excel":c=null!==(a=null===(t=null==d?void 0:d.layers)||void 0===t?void 0:t[s])&&void 0!==a?a:null===(l=null==d?void 0:d.layers)||void 0===l?void 0:l[0];break;case"GeoJson":c=null===(n=null==d?void 0:d.layers)||void 0===n?void 0:n[0]}return c.fields=c.fields.reduce((e,i)=>{const t=o[i.name];return t&&(i.alias=t.alias,e.push(i)),e},[]),e}(e,a.a)}(e);a.a.analyzeResults=O,(null===(m=null==O?void 0:O.publishParameters)||void 0===m?void 0:m.layers)&&(a.a.excelLayers=null===(g=null==O?void 0:O.publishParameters)||void 0===g?void 0:g.layers);const P=(0,n.a)(e,i);t?a.a.backupLayerFields=JSON.parse(JSON.stringify(P.fields)):w.standardizedFieldNames?a.a.standardizedFieldNames=w.standardizedFieldNames:u({lang:o,geocodeServiceUrl:l,locationType:a.a.locationType});"address"===a.a.locationType||"address"===P.locationType||"address"===(null===(f=null==e?void 0:e.publishParameters)||void 0===f?void 0:f.locationType)?a.a.geocodeCost=await(k=P.estimatedRecordCount,(0,s.r)(`${(0,r.g)()}portals/self/cost`,{geocodeCount:k})):a.a.geocodeCost=null;var k}({response:e,initialize:c,analyzeSelectedLayer:L,geocodeServiceUrl:P,lang:f,portal:b,itemType:F});return{}}catch(e){console.error(e);const i=(null==e?void 0:e.message)||e||"";switch(!0){case i.includes("specify data to be analyzed"):return{error:{code:"emptyFile"}};case i.includes("duplicate field names are not allowed"):return{error:{code:"duplicateFieldNames"}};case i.toLowerCase().includes("timeout"):return{error:{code:"timeout"}};case i.toLowerCase().includes("unable to analyze"):if(null===(m=null===(v=null==e?void 0:e.details)||void 0===v?void 0:v.messages[0])||void 0===m?void 0:m.toLowerCase().includes("file exceeds the max size allowed of 10mb."))return{error:{code:"exceedsFileSize"}};case i.toLowerCase().includes("error in analyzing filegeodatabase"):return{error:{code:"invalidFileGeodatabase"}}}return{error:{code:"unhandledError"}}}}async function u({lang:e,geocodeServiceUrl:i,locationType:t}){"address"===t&&(a.a.standardizedFieldNames=await y(i,e))}async function y(e,i){return(await(0,s.r)(e,{},{addTokenManually:!1})).addressFields.reduce((e,t)=>{var a;return"unknown"!==t.name&&(e[t.name]=(null===(a=null==t?void 0:t.localizedNames)||void 0===a?void 0:a[`${i}`])||t.alias||t.name),e},{})}}}]);