/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-9a83bc.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-9a83bc"],{4265:(e,t,a)=>{a.d(t,{a:()=>r,d:()=>i,t:()=>l});const i=(e,t)=>{let a,i="idle";const r=async(...r)=>await new Promise(l=>{switch(i){case"flushed":i="idle",a?(clearTimeout(a),l(e(...r))):l(null);break;case"invoked":clearTimeout(a),i="idle",l(e(...r));break;case"cancelled":clearTimeout(a),i="idle",l(null);break;default:a&&clearTimeout(a),i="pending",a=setTimeout(()=>{i="idle",l(e(...r))},t)}});return r.flush=async function(...e){return i="flushed",await r(...e)},r.invoke=async function(...e){return i="invoked",await r(...e)},r.cancel=async function(...e){return i="cancelled",await r(...e)},r.getStatus=function(){return i},r},r=(e,t)=>{let a;return async(...i)=>await new Promise(r=>{a||(a=setTimeout(()=>{clearTimeout(a),a=void 0,r(e(...i))},t))})};function l(e){return new Promise(t=>setTimeout(t,e))}},36486:(e,t,a)=>{a.d(t,{u:()=>l});var i=a(83552),r=a(73679);const l=(0,i.yr)(r.g)},45820:(e,t,a)=>{a.d(t,{a:()=>u,g:()=>n,q:()=>c});var i=a(28275),r=a(34031),l=a(63438),s=a(5933);async function n(e){const{isTable:t,layer:a,mapView:r}=i.f;if(!a||!("fields"in a))return await Promise.reject(new Error("getOneFeature: wrong layer type"));if(t)return await o(e);{const t=await r.whenLayerView(a),i="hasM"in a&&a.hasM,l="hasZ"in a&&a.hasZ,s=t.availableFields.length===a.fields.length&&!i&&!l;if("createQuery"in a&&s){const i=a.createQuery();i.start=0,i.num=5,i.outFields=["*"],i.returnGeometry=!0,i.outSpatialReference=a.spatialReference;const r=await t.queryFeatures(i);return r.features?.length?await Promise.resolve(r):await o(e)}return await o(e)}}async function o(e){const{layer:t}=i.f;if(!t||!("queryFeatures"in t))return d();try{return await c(e)||d()}catch{return}}async function c(e){const{layer:t}=i.f,a=new r.default({outFields:["*"],where:e||"1=1",outSpatialReference:t.spatialReference,returnGeometry:!0,returnM:"hasM"in t&&t.hasM,returnZ:"hasZ"in t&&t.hasZ});return t.sourceJSON?.advancedQueryCapabilities?.supportsPagination&&(a.num=1),await t.queryFeatures(a)}function d(){const{layer:e}=i.f,t={};e?.fields&&e.fields.forEach(e=>{e.defaultValue?t[e.name]=e.defaultValue:["small-integer","big-integer","integer","single","double","long","date","oid"].includes(e.type)?t[e.name]=0:"date-only"===e.type?t[e.name]=null:t[e.name]=""});const a=new l.default({geometry:void 0,symbol:void 0,attributes:t});return new s.default({features:[a],fields:[],geometryType:e.geometryType,spatialReference:e?.spatialReference.clone()})}async function u(e="1=1"){const{layer:t}=i.f,a=new r.default({where:e});try{return await t.queryFeatureCount(a)}catch{return 0}}},46317:(e,t,a)=>{a.d(t,{D:()=>s});var i=a(85282),r=a(34670),l=a(42466);const s=(0,r.u$)(class extends r.WL{constructor(){super(...arguments),this.key=i.s6}render(e,t){return this.key=e,t}update(e,[t,a]){return t!==this.key&&((0,l.mY)(e),this.key=t),a}})},47640:(e,t,a)=>{a.d(t,{YZ:()=>s,e1:()=>r});var i=a(4836);const r={INITIAL:0,PENDING:1,COMPLETE:2,ERROR:3},l=Symbol();class s{get taskComplete(){return this.t||(1===this.i?this.t=new Promise((e,t)=>{this.o=e,this.h=t}):3===this.i?this.t=Promise.reject(this.l):this.t=Promise.resolve(this.u)),this.t}constructor(e,t,a){this.p=0,this.i=0,(this._=e).addController(this);const i="object"==typeof t?t:{task:t,args:a};this.v=i.task,this.j=i.args,this.m=i.argsEqual??n,this.k=i.onComplete,this.A=i.onError,this.autoRun=i.autoRun??!0,"initialValue"in i&&(this.u=i.initialValue,this.i=2,this.O=this.T?.())}hostUpdate(){!0===this.autoRun&&this.S()}hostUpdated(){"afterUpdate"===this.autoRun&&this.S()}T(){if(void 0===this.j)return;const e=this.j();if(!Array.isArray(e))throw Error("The args function must return an array");return e}async S(){const e=this.T(),t=this.O;this.O=e,e===t||void 0===e||void 0!==t&&this.m(t,e)||await this.run(e)}async run(e){let t,a;e??=this.T(),this.O=e,1===this.i?this.q?.abort():(this.t=void 0,this.o=void 0,this.h=void 0),this.i=1,"afterUpdate"===this.autoRun?queueMicrotask(()=>this._.requestUpdate()):this._.requestUpdate();const i=++this.p;this.q=new AbortController;let r=!1;try{t=await this.v(e,{signal:this.q.signal})}catch(e){r=!0,a=e}if(this.p===i){if(t===l)this.i=0;else{if(!1===r){try{this.k?.(t)}catch{}this.i=2,this.o?.(t)}else{try{this.A?.(a)}catch{}this.i=3,this.h?.(a)}this.u=t,this.l=a}this._.requestUpdate()}}abort(e){1===this.i&&this.q?.abort(e)}get value(){return this.u}get error(){return this.l}get status(){return this.i}render(e){switch(this.i){case 0:return e.initial?.();case 1:return e.pending?.();case 2:return e.complete?.(this.value);case 3:return e.error?.(this.error);default:throw Error("Unexpected status: "+this.i)}}}const n=(e,t)=>e===t||e.length===t.length&&e.every((e,a)=>!(0,i.Ec)(e,t[a]))},55616:(e,t,a)=>{a.d(t,{a:()=>f,c:()=>m,g:()=>d,p:()=>g,u:()=>y});var i=a(28275),r=a(52797),l=a(45820),s=a(98186),n=a(73679),o=a(31526);function c(e,t){return null!=e?u(e,t,{...r.convertDateFormatToIntlOptions("short-date-short-time"),timeZone:"system"}):null}function d(e,t=i.f.originalField){if(!t)return;if(null===e)return e;const{domain:a}=t,r=["date-only","time-only","timestamp-offset"];if(t.domain){const i=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const a=t.codedValues.filter(t=>t.hasOwnProperty("code")&&t.code===e);return a?.length?a[0].name:e}return null}(e,t.domain);return"date"===t.type&&"range"===a?.type?c(i,t):h(t)&&"range"===a?.type?p(e,t):r.includes(t.type)&&"range"===a?.type?u(i,t):i}return"date"===t.type||r.includes(t.type)||["esri.arcade.arcadedate","esri.core.sql.timeonly","esri.core.sql.dateonly"].includes(e.declaredRootClass)||e.isLuxonDateTime||e._timeStampOffset?c(e,t):h(t)?p(e,t):e}function u(e,t,a){const{selectedLanguage:l}=i.f;return"Arcade"===l?function(e,t,a){switch(t.type){case"date":return["esri.arcade.arcadedate","esri.core.sql.dateonly"].includes(e.declaredRootClass)?r.formatDate(e.toJSDate(),{...r.convertDateFormatToIntlOptions("short-date-short-time"),timeZone:"system"}):r.formatDate(e,a);case"date-only":return"esri.core.sql.dateonly"===e.declaredRootClass?r.formatDateOnly(e.toStorageFormat(),a):r.formatDateOnly(e,a);case"time-only":return"esri.core.sql.timeonly"===e.declaredRootClass?r.formatTimeOnly(e.toStorageString(),a):"esri.core.sql.dateonly"===e.declaredRootClass?r.formatDateOnly(e.toJSDate(),a):"esri.arcade.arcadedate"===e.declaredRootClass?e.toString():r.formatTimeOnly(e,a);case"timestamp-offset":return"esri.arcade.arcadedate"===e.declaredRootClass?r.formatTimestamp(e.toISOString(),{...r.convertDateFormatToIntlOptions("short-date-short-time"),timeZone:"system"}):"esri.core.sql.timeonly"===e.declaredRootClass?e.toStorageString():r.formatTimestamp(e,a);default:return"toStorageString"in e?e.toStorageString():e.toString()||null}}(e,t,a):function(e,t){const{currentScript:a}=i.f;let l={...r.convertDateFormatToIntlOptions("short-date-short-time"),timeZone:"system"},s=e;if("esri.core.sql.timeonly"===e.declaredRootClass&&"time-only"!==t.type)if(a?.includes("CURRENT_TIME")){const{day:t,month:a,year:i}=function(e=!0){const t=new Date;return{day:e?t.getDate():t.getUTCDate(),month:(e?t.getMonth():t.getUTCMonth())+1,year:e?t.getFullYear():t.getUTCFullYear()}}();s=e.toUTCDateTime().set({day:t,month:a,year:i})}else s=e.toUTCDateTime().set({year:1900});else"esri.core.sql.dateonly"===e.declaredRootClass?(s=e.toUTCDateTime(),["time-only","string"].includes(t.type)||(s=s.toLocal())):s=e._timeStampOffset?e.toDateTime():(e.isLuxonDateTime||t.type,e);switch(t.type){case"date":return s.isLuxonDateTime&&(s=s.ts),r.formatDate(s,l);case"date-only":return s.isLuxonDateTime&&(s=s.toString()),r.formatDateOnly(s,l);case"time-only":return s.isLuxonDateTime?s.toFormat("h:mm a"):r.formatTimeOnly(s,l);case"timestamp-offset":return r.formatTimestamp(s,l);case"string":return l={...r.convertDateFormatToIntlOptions("short-date-short-time"),timeZone:"UTC"},"esri.core.sql.dateonly"===e.declaredRootClass?s.isLuxonDateTime?a?.includes("CURRENT_DATE")?s.toFormat("LLL d yyyy h:mm a"):s.toFormat("yyyy-LL-dd HH:mm:ss"):r.formatDateOnly(e.toString(),l):"esri.core.sql.timeonly"===e.declaredRootClass?s.isLuxonDateTime?e.toFormat("HH:mm:ss"):e.toStorageString():e._timeStampOffset?e.toSQLValue():e.isLuxonDateTime?e.toFormat("yyyy-LL-dd HH:mm:ss"):r.formatDate(s,l);default:return null}}(e,t)}function p(e,t){return["single","double","long"].includes(t.type)?r.formatNumber(parseFloat(e),r.convertNumberFormatToIntlOptions({digitSeparator:!1,places:2})):["integer","small-integer","big-integer"].includes(t.type)?r.formatNumber(parseFloat(e),r.convertNumberFormatToIntlOptions({digitSeparator:!1,places:0})):void 0}function h(e){return["integer","small-integer","big-integer","single","double"].includes(e.type)}function f(e){const{features:t,layer:a,selectedLanguage:r,_messages:l}=i.f,n=e.attributes[a.objectIdField];try{if("Arcade"===r)return function(e,t){const{arcadeExecutor:a,features:r,layer:l}=i.f;try{let n=a.execute({$feature:e,$datastore:l.url},{spatialReference:l.spatialReference,rawOutput:!0});const o=(0,i.b)(n);return/<\/?[a-z][\s\S]*>/iu.test(n)&&(n=(0,s.s)(n)),r[t].calculatedValue=n,r[t].passed=o.isFieldValid,o.isFieldValid?r[t].error=void 0:r[t].error=o.errorMessage,n}catch(e){throw e}}(e,n);if("SQL"===r)return function(e,t){const{features:a,sqlEngine:r}=i.f;try{let l=r.calculateValue(e);const n=(0,i.b)(l);return/<\/?[a-z][\s\S]*>/iu.test(l)&&(l=(0,s.s)(l)),a[t].calculatedValue=l,a[t].passed=n.isFieldValid,n.isFieldValid?a[t].error=void 0:a[t].error=n.errorMessage,l}catch(e){throw e}}(e,n)}catch{t[n].calculatedValue=null,t[n].error=l.calculationErrorGeneral,t[n].passed=!1}}async function m(e){const{arcadeExecutor:t,features:a,layer:r,_messages:l}=i.f,n=e.attributes[r.objectIdField];try{let l=await t.executeAsync({$feature:e,$datastore:r.url},{spatialReference:r.spatialReference,rawOutput:!0});const o=(0,i.b)(l);return/<\/?[a-z][\s\S]*>/iu.test(l)&&(l=(0,s.s)(l)),a[n].calculatedValue=l,a[n].passed=o.isFieldValid,o.isFieldValid?a[n].error=void 0:a[n].error=o.errorMessage,l}catch{a[n].calculatedValue=null,a[n].error=l.calculationErrorGeneral,a[n].passed=!1}}async function g(e){const{arcadeExecutor:t,features:a,invalidScript:r,layer:s,sqlEngine:o}=i.f,c=(e.attributes||e.graphic.attributes)[s.objectIdField];if(!a[c]){const e=await(0,l.q)(`${s.objectIdField} = ${c}`);a[c]={feature:e.features[0],tableFeature:!1,calculatedValue:void 0,passed:!1}}return(t||o)&&!(0,i.v)(a[c].calculatedValue)&&!a[c].error&&(t?.isAsync?await m(a[c].feature):await f(a[c].feature)),r?function(){const{_messages:e}=i.f,t=document.createElement("div");return t.style.textAlign="center",t.innerHTML=`<img class="popup-icon" src=${(0,n.g)("./assets/map-config-field-calculate/map-config-field-calculate-icons/alert-48.svg")}></img>\n  <calcite-label>${e.popupError}</calcite-label>`,t}():(0,i.v)(a[c].calculatedValue)||a[c].error?function(e){const{arcadeExecutor:t,features:a,layer:r,originalField:l,_messages:s,sqlEngine:n}=i.f,o={};Object.keys(e).forEach(t=>{o[t.toLowerCase()]=e[t]});const c=document.createElement("div"),u=e[r.objectIdField];if(a[u].error){const e=document.createElement("calcite-label");e.layout="inline";const t=document.createElement("calcite-icon");t.classList.add("popup-error-icon"),t.icon="exclamation-mark-triangle",e.append(t),e.append(a[u].error),c.append(e)}const p=(0,i.v)(a[u].calculatedValue)&&!a[u].error||(0,i.i)(a[u].calculatedValue)?d(a[u].calculatedValue):a[u].calculatedValue,h=document.createElement("calcite-table");h.caption=p;const f=document.createElement("calcite-table-row"),m=document.createElement("calcite-table-header");m.heading=l?.alias??"",f.appendChild(m),h.appendChild(f);const g=document.createElement("calcite-table-row"),y=document.createElement("calcite-table-cell");y.innerHTML=p,g.appendChild(y),h.appendChild(g),c.appendChild(h),c.appendChild(document.createElement("br"));const w=[];if((t?t.fieldsUsed:n?n.fieldNames:[]).forEach(e=>{if(!Object.keys(o).includes(e.toLowerCase()))return;const t=document.createElement("calcite-table-row"),a=document.createElement("calcite-table-cell");a.innerHTML=e;const i=document.createElement("calcite-table-cell");i.innerHTML=d(o[e.toLowerCase()],r.fields.find(t=>t.name.toLowerCase()===e.toLowerCase())),t.append(a,i),w.push(t)}),w.length){const e=document.createElement("calcite-label");e.innerHTML=s.fieldsInCalculation;const t=document.createElement("calcite-table");t.bordered=!0,t.append(...w),e.append(t),c.append(e)}return c}(a[c].feature.attributes):function(){const{_messages:e}=i.f,t=document.createElement("div");return t.style.textAlign="center",t.innerHTML=`<img class="popup-icon" src=${(0,n.g)("./assets/map-config-field-calculate/map-config-field-calculate-icons/edit-48.svg")}></img>\n  <calcite-label>${e.popupPreview}</calcite-label>`,t}()}function y(){const{layer:e,mapView:t}=i.f;t?.popup?.visible&&e&&(e.popupTemplate=new o.default({title:e.displayField?`{${e.displayField}}`:`{${e.objectIdField}}`,content:g,lastEditInfoEnabled:!1}))}},98186:(e,t,a)=>{a.d(t,{d:()=>l,i:()=>r,s:()=>s});var i=a(59290);function r(e,t){if(e?.tagName===t)return!0;{let a=e?.parentElement;for(;a;){if(a.tagName===t)return!0;a=a.parentElement}}return!1}function l(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function s(e){return(new i.S).sanitize(e)}},99941:(e,t,a)=>{a.r(t),a.d(t,{ArcgisMapConfigFieldCalculate:()=>V});var i=a(73679),r=a(4395),l=a(46317),s=a(36486),n=a(45820),o=a(28275),c=(a(52797),a(55616)),d=a(44345),u=a(55448),p=a(98186),h=a(4265),f=a(34031),m=(a(59290),a(70757)),g=a(73801),y=a(47640),w=a(66228),b=a(24824),v=a(588),F=a(1508),$=a(24037),C=a(2058),S=a(31526),E=a(59102),x=a(13096),N=a(43284),T=a(83552);async function P(e,t){const a=e.url,i=e.content||{},r=function(e){const t=u.urlToObject(e);return t.query=t.query||{},Object.keys(t.query).forEach(e=>{t.query.hasOwnProperty(e)&&(Array.isArray(t.query[e])||(t.query[e]=t.query[e].replace(/(&lt;|&gt;|<|>|%3C|%3E)/gu,"")))}),t}(a).query||{};!i.get("f")&&!r.f&&i.append("f","json");const l={body:i,timeout:t?.timeout||0,method:"post",responseType:"json"};try{return(await(0,d.default)(e.url,l)).data}catch(e){throw console.error(e),e}}class O extends Error{constructor(e,{calcErrorType:t,feature:a,objectId:i}){super(e),this.type="FieldCalcError",this.feature=a,this.calcErrorType=t,this.objectId=i}}async function k(){const{layer:e}=o.f,t=`${e.portalItem.url}/${e.layerId}/append`,a=function(){const{originalField:e,layer:t,registeredResultId:a}=o.f,i=[{source:e.name,name:e.name},{source:t.objectIdField,name:t.objectIdField}],r=[e.name,t.objectIdField],l={fieldMappings:JSON.stringify(i),upsert:!0,skipUpdates:!1,useGlobalIds:!1,skipInserts:!0,updateGeometry:!1,appendFields:JSON.stringify(r),appendUploadId:a,appendUploadFormat:"csv",rollbackOnFailure:!0,upsertMatchingField:t.objectIdField,appendSourceInfo:"{}"},s=new FormData;return Object.keys(l).forEach(e=>{s.append(e,l[e])}),s}();try{const e=await P({url:t,content:a});await A(e.statusUrl+="?f=json",500)}catch(e){throw e}}async function A(e,t){const a=["processing","partial","Pending","InProgress","EXECUTING"],i=["completed","Completed","COMPLETED"];try{const r=(await(0,d.default)(e,{responseType:"json"})).data;if(a.includes(r.status))return await(0,h.t)(t),await A(e,t+250);if(r.status&&!i.includes(r.status)||r.code>400||""===r.status)throw new Error(r.errorMessage);return r.recordCount}catch(e){throw e}}function q(e,t,a){a&&e.unshift(a);const i=function(e){let t=("object"!=typeof e?JSON.parse(e):e).map(e=>Object.values(e).toString()).join("\n");return t+="\n",t}(JSON.stringify(e)),r=`${t}.csv`||"export.csv",l=new Blob([i],{type:"text/csv;charset=utf-8;"}),s=document.createElement("form");s.enctype="multipart/form-data";const n=new FormData(s);return n.append("file",l,r),n}function L(){const{layer:e}=o.f,t=e.sourceJSON;return t.advancedQueryCapabilities?.supportsQueryWithResultType&&t.advancedQueryCapabilities?.supportsMaxRecordCountFactor&&t.supportedQueryFormats.includes("PBF")&&t.supportsQuantizationEditMode}async function I(e,t){const{layer:a,originalField:i}=o.f;try{const r=await async function(e){const{arcadeExecutor:t,features:a,layer:i}=o.f,r=[];if(t?.isAsync){const l=await t.executeAsyncBatch(e,e=>({$feature:e,$layer:i,$datastore:i.url}),{spatialReference:i.spatialReference,rawOutput:!0});e.forEach((e,t)=>{try{const s=l[t];if("rejected"===s.status)throw new O(s.reason,{feature:e});{const t=e.attributes[i.objectIdField];let l={objectId:t,ArcadeField:s.value};a[t]||(a[t]={feature:e,calculatedValue:s.value,tableFeature:!1,passed:!1}),l=R(l),r.push(l)}}catch(t){throw"arcade"===t.calcErrorType?new O(t.message,{calcErrorType:t.calcErrorType,objectId:t.objectId,feature:e}):t}})}else for(const l of e)try{const e=t.execute({$feature:l,$datastore:i.url},{spatialReference:i.spatialReference,rawOutput:!0}),s=l.attributes[i.objectIdField];let n={objectId:s,ArcadeField:e};a[s]||(a[s]={feature:l,calculatedValue:e,tableFeature:!1,passed:!1}),n=R(n),r.push(n)}catch(e){throw"arcade"===e.calcErrorType?new O(e.message,{calcErrorType:e.calcErrorType,objectId:e.objectId,feature:l}):e}return r}(e);return null===r?void 0:1===t?q(r,`uploadFile${t}`,{objectId:a.objectIdField,ArcadeField:i.name}):q(r,`uploadFile${t}`)}catch(e){throw e}}function R(e){const{features:t,originalField:a,_messages:i}=o.f;let r=e.ArcadeField;const l=e.objectId,s=(0,o.b)(r);if(null===r&&(r=""),/<\/?[a-z][\s\S]*>/iu.test(r)&&(r=(0,p.s)(r)),t[l].calculatedValue=r,t[l].passed=s.isFieldValid,!s.isFieldValid)throw t[l].error=s.errorMessage,new O(s.errorMessage??i.calculationErrorGeneral,{calcErrorType:"arcade",objectId:l});return"esri.arcade.arcadedate"===r?.declaredRootClass?r=r.toISOString():"esri.core.sql.timeonly"===r?.declaredRootClass?r=r.toStorageString():"esri.core.sql.dateonly"===r?.declaredRootClass&&(r=r.toStorageFormat()),a.type.toLowerCase().includes("string")&&(r=function(e){return"string"==typeof e&&(e=e.replace(/"/gu,'""')),`"${e}"`}(r)),e.ArcadeField=r,e}const _=r.AH`@layer{arcgis-map-config-field-calculate{.async-arcade-notice{margin:16px 20px 0}.auto-preview{display:flex;align-items:center;gap:12px;margin:auto auto auto 10px}.button-margin{margin:auto}.calculate-panel{z-index:calc(var(--calcite-z-index-header) + 1)!important;--calcite-shell-panel-max-width: 50vw;--calcite-shell-panel-width: 680px}.calculation-error-icon{fill:var(--calcite-color-status-danger);width:64px;height:64px;display:unset!important}.calculation-error-description{font-size:20px;max-width:640px;color:var(--calcite-color-text-3);margin-block-start:-10px;margin-block-end:20px}.calculation-finish{text-align:center;margin:auto}.calculation-success-icon{fill:var(--calcite-color-status-success);width:64px;height:64px;display:unset!important}.calculation-result-label{text-align:center;font-size:26px;color:var(--calcite-color-text-1);margin:26px!important}.calculating-values-content{height:100%;align-content:center}.calculating-values-label{font-size:var(--calcite-font-size-xxl);text-align:center;margin-bottom:-50px}.cancel-button{margin:auto 10px auto auto}.error-alert{z-index:var(--calcite-z-index-toast)!important;position:static!important}.feature-count{margin-right:10px;margin-top:auto}.feature-ratio{margin-right:20px;margin-top:15px;text-wrap:nowrap}.field-calc-container{--calcite-dialog-content-space: 0px !important;--calcite-panel-header-content-space: 0px !important}.field-calc-tooltip{z-index:401}.footer-buttons-end{justify-content:flex-end}.hidden{display:none}.left-panel-top-slot{width:100%}.layer-table{border-radius:var(--calcite-corner-radius-round);width:auto;height:100%;box-shadow:var(--calcite-shadow-sm)}.map-and-table-panels{height:100%;display:grid;row-gap:16px;margin:16px}.map-panel{width:auto}.mapView{width:100%;height:100%}.meter{width:200px;margin-right:5px;--calcite-color-brand: #6a6a6a}.meter-label{margin-left:15px;text-wrap:nowrap;margin-top:15px}.modal-footer{display:flex;align-items:center}.panel-border{border:1px solid #e0e0e0}.panel-header{display:inline-flex;margin:16px}.popup-icon{width:64px;height:auto;text-align:center;display:unset!important}.popup-error-icon{--calcite-icon-color: var(--calcite-color-status-warning)}.reset-calc-button{margin-right:10px}.table-panel{z-index:399}.title{font-size:var(--calcite-font-size-xxl);font-weight:var(--calcite-font-weight-bold);margin:14px 12px}}}`;class V extends g.WF{constructor(){super(...arguments),this.autoPreviewSwitchNode=(0,m._)(),this.calculationPanelNode=(0,m._)(),this.closeActionNode=(0,m._)(),this.featuresChipNode=(0,m._)(),this.loaderNode=(0,m._)(),this.mapActionNode=(0,m._)(),this.mapAndTableActionNode=(0,m._)(),this.previewChipNode=(0,m._)(),this.tableNode=(0,m._)(),this.tableActionNode=(0,m._)(),this._direction=(0,T.jH)(),this._loaded=!1,this._initialized=!1,this.invalidFieldOrLayer=!1,this._messages=(0,s.u)({blocking:!0}),this.debouncedEditorScriptChange=(0,h.d)(()=>{this.handleEditorScriptChange()},500),this._propWatcherTask=new y.YZ(this,{task:async([e,t,a])=>{if(!(0,w.i)(e)||!(0,w.i)(t)||!(0,w.i)(a))throw console.error("[arcgis-map-config-field-calculate] Required properties are missing."),new Error("Required properties are missing.");this._propWatcherTask.autoRun=!1,await this.init()},args:()=>[this.config,this.fieldName,this.layer]}),this.editorOpen=!1,this.featureRatio="",this.filterPanelOpen=!1,this.view="both",this.calculationState="none",this.showAsyncArcadeWarning=!1,this.testFeatureCount=0,this.layerFieldSwitcherOptions={active:!1,layerSwitcherDisabled:!1,fieldSwitcherDisabled:!1},this.withinPanel=!1,this.arcgisCalculationsFinished=(0,g.lh)(),this.arcgisCalculationsStarted=(0,g.lh)(),this.arcgisClose=(0,g.lh)(),this.arcgisDataUpdate=(0,g.lh)(),this.arcgisFieldCalculateClose=(0,g.lh)(),this.arcgisFieldCalculateDataUpdate=(0,g.lh)(),this.arcgisLayerChange=(0,g.lh)(),this.arcgisScriptChange=(0,g.lh)(),this.arcgisWorkflowUpdate=(0,g.lh)()}static{this.properties={editorOpen:16,featureRatio:16,filterPanelOpen:16,view:16,calculationState:16,showAsyncArcadeWarning:16,testFeatureCount:16,config:0,layerFieldSwitcherOptions:0,fieldName:1,layer:0,withinPanel:5,whereClause:1}}static{this.styles=_}static{this.shadowRootOptions=g.Iq}async calculationsInProgress(){return"running"===this.calculationState}async getCurrentScript(){return o.f.currentScript}async updated(){if(this._propWatcherTask.status===y.e1.COMPLETE&&this._initialized&&!this._loaded){if(this._loaded=!0,this.invalidFieldOrLayer)return;const{arcadeSupported:e,isTable:t}=o.f;!t&&this.mapAndTableActionNode.value&&(this.mapAndTableActionNode.value.active=!0),e&&(this.lruCache=new $.default)}if("map"!==this.view&&this.tableNode.value){const e=await this.tableNode.value.getMode();"none"===this.calculationState&&("features"===e&&this.featuresChipNode.value?this.featuresChipNode.value.selected=!0:this.previewChipNode.value&&(this.previewChipNode.value.selected=!0))}}async init(){await this.loadStore();const{isTable:e,layer:t}=o.f;if(!(0,o.c)(t))return console.error("User must have rights for updating item and layer must be a hosted feature layer."),void(this.invalidFieldOrLayer=!0);if(!(0,o.a)(o.f.originalField))return console.error("Field type must be editable to calculate."),void(this.invalidFieldOrLayer=!0);if(!e&&t?.portalItem?.portal){const e=t.portalItem?.portal,a=e.useVectorBasemaps?e.defaultVectorBasemap:e.defaultBasemap;this.map=new b.default({basemap:a}),this.map.add(t)}t?.portalItem?.url&&await v.default.getCredential(t.portalItem.url),this._initialized=!0}changeView(e){this.view=e,this.mapActionNode.value.active="map"===this.view,this.tableActionNode.value.active="table"===this.view,this.mapAndTableActionNode.value.active="both"===this.view,this.filterPopoverNode&&"map"===this.view&&(this.filterPopoverNode.remove(),this.filterPopoverNode=void 0)}closeEditor(){this.editorOpen=!1,this.calculationPanelNode.value?.closeEditor(),this.filterPopoverNode?.open&&(this.filterPopoverNode.remove(),this.testFeatureFilterWhere=void 0,this.filterPopoverNode=void 0)}async handleEditorScriptChange(){const{arcadeExecutor:e,layer:t,selectedLanguage:a,sqlEngine:i}=o.f;e||i?(e?.isAsync&&(o.f.autoPreviewEnabled=!1,this.autoPreviewSwitchNode.value&&(this.autoPreviewSwitchNode.value.checked=!1,this.autoPreviewSwitchNode.value.disabled=!0)),t.outFields=e?.fieldsUsed||i.fieldNames,this.showAsyncArcadeWarning="Arcade"===a&&!!e?.isAsync,await(this.tableNode.value?.calculateValues())):this.tableNode.value?.refresh(!0),this.arcgisScriptChange.emit(o.f.currentScript)}closeFilterPanel(){const{layer:e}=o.f;this.filterPanelOpen=!1,e.definitionExpression=o.f.whereClause,this.calculationPanelNode.value&&(this.calculationPanelNode.value.closeFilterPanel(),this.calculationPanelNode.value.filterPanelWhere=o.f.whereClause)}createMapViewAndPopupTemplate(e){const{layer:t}=o.f;if(e&&o.f.mapView?.container!==e){if(e.style.width="100%",e.style.height="100%",o.f.mapView)return void(o.f.mapView.container=e);o.f.mapView=new F.default({map:this.map,popup:new C.default({dockEnabled:!0,dockOptions:{buttonEnabled:!1,position:"top-left",breakpoint:!1},viewModel:{includeDefaultActions:!1}}),container:e,constraints:{snapToZoom:!1},extent:t.fullExtent??void 0}),t.popupTemplate=new S.default({title:t.displayField?`{${t.displayField}}`:`{${t.objectIdField}}`,content:c.p,lastEditInfoEnabled:!1})}}createFeatureEffect(e){const{layer:t,whereClause:a}=o.f;t.featureEffect=a?new E.default({filter:{where:a},excludedEffect:`grayscale(1) opacity(${e?0:80}%) brightness(100%)`}):null}downloadScript(){const{currentScript:e}=o.f,t=document.createElement("a"),a=new Blob([e??""],{type:"text/plain"});t.href=URL.createObjectURL(a),t.download="script.txt",t.click(),URL.revokeObjectURL(t.href)}async handleRunCalculations(){const{arcadeExecutor:e,autoPreviewEnabled:t,currentScript:a,features:i,selectedLanguage:l,_messages:s,sqlEngine:n}=o.f,c=this.tableNode.value&&await this.tableNode.value.noRowsVisible(),d=!Object.values(i).find(e=>e.tableFeature&&!e.passed);let u=!n&&!(c||d&&e);if(!d&&!c&&(e?.isAsync||!t||"map"===this.view)&&!n&&(u=!await(this.calculationPanelNode.value?.isTestResultValid())),u){const e=(0,g.dN)(r.qy`<calcite-alert slot=alerts class="error-alert" kind=warning icon=exclamation-mark-triangle-f open .label=${s.errorAlertTitle}><div slot=title>${s.errorAlertTitle}</div><div slot=message>${s.errorAlertMessage}</div><calcite-link slot=link @click=${()=>{"map"===this.view&&this.changeView("both"),setTimeout(()=>{this.tableNode.value?.setMode("preview"),this.previewChipNode.value&&(this.previewChipNode.value.selected=!0)},300)}}>${s.errorAlertLink}</calcite-link></calcite-alert>`);return void this.outerContainerNode.append(e)}this.calculationState="running",this.arcgisCalculationsStarted.emit({language:l,script:a}),o.f.workflowState="layer-calculation",this.arcgisWorkflowUpdate.emit("layer-calculation"),"Arcade"===l?this.runCalculationsArcade():"SQL"===l&&this.runCalculationsSQL()}handleInvalidScript(){const{features:e}=o.f;o.f.arcadeExecutor=void 0,o.f.sqlEngine=void 0,o.f.invalidScript=!0,(0,c.u)(),this.tableNode.value?.refresh(!0),Object.keys(e).forEach(t=>{e[t].error=void 0,e[t].calculatedValue=void 0})}async loadStore(e=!1,t,a){const i=t??this.layer;i.loaded||await i.load(),e||((0,o.d)(o.f),o.f._messages=this._messages),o.f.layer=i.clone(),o.f.layer.featureReduction=null,o.f.layer.effect=null,o.f.layer.featureEffect=null,o.f.layer.visible=!0,o.f.layer.definitionExpression=null,await o.f.layer.load(),o.f.originalField=a??i.fields.find(e=>e.name===this.fieldName),o.f.numRecords=40,o.f.config=this.config,o.f.features={},o.f.autoPreviewEnabled=!0,o.f.workflowState="language-select",o.f.isRTL="rtl"===this._direction;const r=o.f.layer.portalItem.portal,l=r.isPortal||"multitenant"!==r.portalMode,s=o.f.layer.sourceJSON,c=s.capabilities?.includes("Uploads"),d=!l||c;o.f.arcadeSupported=!s.capabilities?.includes("Sync")&&!s.capabilities?.includes("ChangeTracking")&&d,o.f.whereClause=this.whereClause,o.f.layer.definitionExpression=this.whereClause,o.f.isTable="feature"===o.f.layer.type&&o.f.layer.isTable,o.f.totalFeatureCount=await(0,n.a)(),o.f.filteredFeatureCount=this.whereClause?await(0,n.a)(this.whereClause):o.f.totalFeatureCount,this.featureRatio=o.f.isRTL?`${o.f.totalFeatureCount} / ${o.f.filteredFeatureCount}`:`${o.f.filteredFeatureCount} / ${o.f.totalFeatureCount}`}openEditor(){this.editorOpen=!0,this.calculationPanelNode.value?.openEditor(),o.f.workflowState="script-editor",this.arcgisWorkflowUpdate.emit("script-editor")}openFilterPanel(){const{layer:e}=o.f;this.filterPanelOpen=!0,this.calculationPanelNode.value?.openFilterPanel(),e.definitionExpression=null,this.createFeatureEffect(!1),o.f.workflowState="filter",this.arcgisWorkflowUpdate.emit("filter")}async openFilterPopover(e){const{_messages:t}=o.f,a=(await(this.tableNode.value?.getLayer()))?.clone();a&&(await a.load(),!this.filterPopoverNode&&(this.filterPopoverNode=(0,g.dN)(r.qy`<calcite-popover open placement=bottom-start pointer-disabled trigger-disabled .label=${t.testFeaturesFilter} .referenceElement=${e} @calcitePopoverClose=${()=>{this.filterPopoverNode=void 0}}> <arcgis-common-sql-expression-config style=${(0,g.zl)({width:"30vw"})} panel-max-height=50vh .layer=${a} hide-layer-title .noFilterMsg=${t.testFeatureFilterTipMsg} @arcgisCancel=${()=>{this.filterPopoverNode?.remove(),this.testFeatureFilterWhere=void 0,this.filterPopoverNode=void 0,e.setFocus()}} @arcgisChange=${e=>{this.testFeatureFilterWhere=e.detail}} @arcgisSave=${()=>{this.filterPopoverNode?.remove(),this.tableNode.value?.updateTableFilter(this.testFeatureFilterWhere),this.filterPopoverNode=void 0,e.setFocus()}}></arcgis-common-sql-expression-config></calcite-popover>`),this.outerContainerNode.appendChild(this.filterPopoverNode),this.filterPopoverNode.setFocus(),"updateFocusTrapElements"in this.outerContainerNode&&this.outerContainerNode.updateFocusTrapElements(this.filterPopoverNode)))}resetWorkflow(){const{features:e,mapView:t}=o.f;this.editorOpen=!1,this.filterPanelOpen=!1,o.f.currentScript="",o.f.arcadeExecutor=void 0,o.f.sqlEngine=void 0,o.f.invalidScript=!1,o.f.layer.definitionExpression=void 0,this.showAsyncArcadeWarning=!1,this.updateFieldCalcFilter(void 0,!0),t?.popup?.visible&&t.popup.close(),Object.keys(e).forEach(t=>{e[t].calculatedValue=void 0,e[t].error=void 0,e[t].passed=void 0}),o.f.workflowState="language-select",this.arcgisWorkflowUpdate.emit("language-select")}async runCalculationsArcade(){const{currentScript:e,features:t,layer:a,selectedLanguage:i,_messages:r}=o.f;try{const t=await async function(){const{layer:e}=o.f,t=`${e.portalItem.url}/uploads/register`,a=new FormData;return a.append("itemName",`${e.portalItem.id}.csv`),a.append("description","Arcade Calculate"),await P({url:t,content:a})}();if(!t.success)return this.calculationState="error",this.arcgisCalculationsFinished.emit({language:i,script:e,success:!1}),void(this.calculationErrorMessage=r.calculationErrorGeneral);o.f.registeredResultId=t.item.itemID;const l=await this.queryAndUploadProcess(1,0);if(!l)return;const s=`${a.portalItem.url}/uploads/${o.f.registeredResultId}/commit`,n=new FormData;n.append("parts",this.allPartsInString(l)),n.append("f","json"),await P({url:s,content:n}),await k(),this.calculationState="success",this.arcgisCalculationsFinished.emit({language:i,script:e,success:!0}),this.arcgisDataUpdate.emit(),this.arcgisFieldCalculateDataUpdate.emit()}catch(l){if(this.arcgisCalculationsFinished.emit({language:i,script:e,success:!1}),this.calculationState="error","arcade"===l.calcErrorType){this.calculationErrorMessage=l.message;const e=l.feature.attributes[a.objectIdField];this.testFeatureFilterWhere=`${a.objectIdField} = ${e}`,t[e]||(t[e]={}),t[e].passed=!1}else this.calculationErrorMessage=r.calculationErrorGeneral,console.error(l)}}async runCalculationsSQL(){const{currentScript:e,filteredFeatureCount:t,layer:a,originalField:i,selectedLanguage:r,_messages:l,whereClause:s}=o.f;try{const n=`${a.url}/${a.layerId}/calculate`,o=new FormData,c=JSON.stringify([{field:i.name,sqlExpression:e}]);o.append("calcExpression",c),o.append("where",s||"1=1"),o.append("async","true"),o.append("f","json");const d=await P({url:n,content:o});d.error?(this.calculationState="error",this.arcgisCalculationsFinished.emit({language:r,script:e,success:!1}),this.calculationErrorMessage=l.calculationErrorGeneral):await A(d.statusUrl+="?f=json",500)===t?(this.calculationState="success",this.arcgisCalculationsFinished.emit({language:r,script:e,success:!0})):(this.calculationState="error",this.arcgisCalculationsFinished.emit({language:r,script:e,success:!1}),this.calculationErrorMessage=l.calculationErrorGeneral)}catch(t){console.error(t),this.calculationErrorMessage=l.calculationErrorGeneral,t.details?.raw?.description?this.calculationErrorDescription=t.details.raw.description:t.message&&(this.calculationErrorDescription=t.message),this.calculationState="error",this.arcgisCalculationsFinished.emit({language:r,script:e,success:!1})}}allPartsInString(e){let t="",a="";for(let i=1;i<=e;i++)a+=t+i,t=",";return a}async queryAndUploadProcess(e,t){const{layer:a,registeredResultId:i,whereClause:r}=o.f;let l=e||1,s=t||0;const n=function(e,t){const{arcadeExecutor:a,isTable:i,layer:r}=o.f,l=[r.objectIdField].concat(a.fieldsUsed),s=a.geometryUsed&&"hasM"in r&&r.hasM,n=a.geometryUsed&&"hasZ"in r&&r.hasZ,c=new f.default({start:e,returnGeometry:a.geometryUsed,returnM:s,returnZ:n,outFields:l,where:t});let d=0;const u={format:L()?"pbf":"json"};return d=a.geometryUsed||i?r.sourceJSON.standardMaxRecordCount:r.sourceJSON.standardMaxRecordCountNoGeometry,c.resultType="standard",c.maxRecordCountFactor=1,c.num=d,{query:c,options:u,maxSize:d}}(t||0,r),c=n.maxSize;try{let t=await a.queryFeatures(n.query),r=await I(t.features,e);if(!r)return;r.append("f","json"),r.append("partId",`${l}`);const o=`${a.portalItem.url}/uploads/${i}/uploadPart`;return await P({url:o,content:r},{timeout:0}),t.exceededTransferLimit?(s+=c,l++,r=void 0,t=void 0,this.updateProgressBar(l-1,c),await this.queryAndUploadProcess(l,s)):(r=void 0,t=void 0,this.updateProgressBar(l,c),l)}catch(e){throw e}}async updateFieldCalcFilter(e,t){const{features:a,isRTL:i}=o.f;o.f.whereClause=e,this.createFeatureEffect(t),o.f.whereClause?o.f.filteredFeatureCount=await(0,n.a)(o.f.whereClause):o.f.filteredFeatureCount=o.f.totalFeatureCount,Object.keys(a).forEach(e=>{a[e].tableFeature=!1}),this.featureRatio=i?`${o.f.totalFeatureCount} / ${o.f.filteredFeatureCount}`:`${o.f.filteredFeatureCount} / ${o.f.totalFeatureCount}`,await(this.tableNode.value?.updateTableFilter(this.testFeatureFilterWhere))}updateProgressBar(e,t){const{selectedLanguage:a}=o.f;if(!this.loaderNode.value||"SQL"===a)return;const{filteredFeatureCount:i}=o.f;t<1&&(t=1);const r=i/t,l=Math.min(100,Math.floor(e/r*100));if(100===l)this.loaderNode.value.type="indeterminate",this.loaderNode.value.text="";else{const a=e*t>i?i:e*t;this.loaderNode.value.value=l,this.loaderNode.value.text=`${a} / ${i}`}}render(){return this._propWatcherTask.render({complete:()=>this.invalidFieldOrLayer?"":this.withinPanel?r.qy`<calcite-panel class="field-calc-container" ${(0,m.K)(e=>this.outerContainerNode=e)}><calcite-shell>${this.renderShellContent()}</calcite-shell>${this.renderFooter()}</calcite-panel>`:r.qy`<calcite-dialog class="field-calc-container" open placement=cover escape-disabled outside-close-disabled focus-trap-disabled close-disabled @calciteDialogOpen=${e=>{e.stopImmediatePropagation(),this.closeActionNode.value&&this.closeActionNode.value.setFocus()}} ${(0,m.K)(e=>this.outerContainerNode=e)}>${this.renderModalHeader()}<calcite-shell class="shell">${this.renderShellContent()}</calcite-shell>${this.renderFooter()}</calcite-dialog>`})}renderModalHeader(){const{layer:e,originalField:t,_messages:a}=o.f;return r.qy`<div class="title" slot=header-content>${`${e.title} : ${t.alias||t.name}`}</div><calcite-action-bar slot=header-actions-end expand-disabled layout=horizontal>${"none"===this.calculationState&&this.renderViewActions()||""}<calcite-action icon=x .text=${a.close} .label=${a.close} @click=${()=>{this.arcgisClose.emit(),this.arcgisFieldCalculateClose.emit()}} ${(0,m.K)(this.closeActionNode)}></calcite-action></calcite-action-bar>`}renderViewActions(){const{isTable:e,_messages:t}=o.f;return r.qy`<calcite-action id=table-action .disabled=${e} icon=table .text=${t.table} .label=${t.table} @click=${()=>this.changeView("table")} ${(0,m.K)(this.tableActionNode)}></calcite-action><calcite-tooltip class="field-calc-tooltip" reference-element=table-action placement=bottom><span>${t.table}</span></calcite-tooltip><calcite-action id=map-action .disabled=${e} icon=map .text=${t.map} .label=${t.map} @click=${()=>this.changeView("map")} ${(0,m.K)(this.mapActionNode)}></calcite-action><calcite-tooltip class="field-calc-tooltip" reference-element=map-action placement=bottom><span>${t.map}</span></calcite-tooltip><calcite-action id=map-and-table-action .disabled=${e} icon=widgets-group .text=${t.mapAndTable} @click=${()=>this.changeView("both")} ${(0,m.K)(this.mapAndTableActionNode)}></calcite-action><calcite-tooltip class="field-calc-tooltip" reference-element=map-and-table-action placement=bottom><span>${t.mapAndTable}</span></calcite-tooltip>`}renderShellContent(){const{_messages:e}=o.f;return"none"===this.calculationState?r.qy`${this.renderCalculatePanel()}<calcite-panel class="panel-border table-panel">${this.renderTableActions()}${this.showAsyncArcadeWarning&&r.qy`<calcite-notice class="async-arcade-notice" open icon=lightbulb width=auto closable @calciteNoticeClose=${()=>{this.showAsyncArcadeWarning=!1}}><div slot=message>${e.asyncArcadeWarning}</div></calcite-notice>`||""}<div class="map-and-table-panels">${this.renderTable()}${this.renderMap()}</div></calcite-panel>`:this.renderRunningCalculations()}renderRunningCalculations(){const{selectedLanguage:e,_messages:t}=o.f,a={hidden:"none"===this.calculationState};return r.qy`<calcite-panel class=${(0,g.CP)(a)}>${"running"===this.calculationState?r.qy`<div class="calculating-values-content"><div class="calculating-values-label">${t.calculatingValues}</div><calcite-loader .label=${t.calculatingValues} scale=l .type=${"SQL"===e?"indeterminate":"determinate-value"} value=0 .text=${"SQL"===e?"":`0 / ${o.f.filteredFeatureCount}`} ${(0,m.K)(this.loaderNode)}></calcite-loader>${this.withinPanel&&r.qy`<calcite-notice kind=warning icon=exclamation-mark-triangle width=half open><div slot=title>${t.calculationRunningWarning}</div><div slot=message>${t.calculationRunningDescription}</div></calcite-notice>`||""}</div>`:"success"===this.calculationState?r.qy`<div class="calculation-finish"><svg class="calculation-success-icon" xmlns=http://www.w3.org/2000/svg viewBox="0 0 64 64">${r.JW`<path d="M52.745 9.436L23.35 38.869l-9.32-9.57-7.305 7.466 16.63 16.552 26.707-26.708 9.895-10.032zm-3.252 16.61l-26.14 26.141L7.85 36.757l6.176-6.313 9.314 9.564 29.408-29.444 6.076 6.02z" />`}</svg><p class="calculation-result-label">${t.calculationsComplete}</p>${this.withinPanel&&r.qy`<calcite-button class="reset-calc-button" appearance=outline-fill icon-start=arrow-left icon-flip-rtl=start @click=${()=>{this.calculationState="none",this.resetWorkflow()}}>${t.doAnotherCalculation}</calcite-button>`||""}<calcite-button appearance=outline-fill icon-start=download-to @click=${()=>this.downloadScript()}>${t.downloadScript}</calcite-button></div>`:"error"===this.calculationState?r.qy`<div class="calculation-finish"><svg class="calculation-error-icon" xmlns=http://www.w3.org/2000/svg viewBox="0 0 48 48">${r.JW`<path d="M26.158 7.927a1.9 1.9 0 0 0-3.315 0L5.4 39.072A1.9 1.9 0 0 0 7.06 41.9h34.88a1.9 1.9 0 0 0 1.659-2.828zm16.733 32.63a1.107 1.107 0 0 1-.95.543H7.06a1.101 1.101 0 0 1-.961-1.638L23.54 8.318a1.1 1.1 0 0 1 1.919 0L42.9 39.462a1.106 1.106 0 0 1-.01 1.094zM24.1 20h.8v11h-.8zm0 14h.8v3h-.8z" />`}</svg><p class="calculation-result-label">${this.calculationErrorMessage}</p>${this.calculationErrorDescription&&r.qy`<p class="calculation-error-description">${this.calculationErrorDescription}</p>`||""}<calcite-button appearance=outline-fill icon-start=arrow-left icon-flip-rtl=start @click=${()=>{this.calculationState="none",this.calculationErrorDescription=void 0,this.editorOpen=!0,this.tableNode.value?.updateTableFilter(this.testFeatureFilterWhere,!0),this.requestUpdate(),setTimeout(()=>{o.f.arcadeExecutor?.geometryUsed&&this.tableNode.value?.enableGeometry(),this.changeView("both"),this.tableNode.value?.setMode("preview"),this.previewChipNode.value.selected=!0,o.f.autoPreviewEnabled=!0},300)}}>${t.back}</calcite-button></div>`:null}</calcite-panel>`}renderTableActions(){if("map"===this.view)return"";const{autoPreviewEnabled:e,_messages:t}=o.f;return r.qy`<div slot=header-content class="panel-header"><calcite-chip-group label=chips selection-mode=single-persist .disabled=${!this.editorOpen}><calcite-button appearance=outline kind=neutral icon-start=filter @click=${e=>{e.stopPropagation(),e.preventDefault(),this.openFilterPopover(e.currentTarget)}}>${t.testFeaturesFilter}</calcite-button><calcite-chip icon=table .label=${t.testFeatures} .value=${t.testFeatures} @click=${()=>this.tableNode.value?.setMode("features")} ${(0,m.K)(this.featuresChipNode)}>${t.testFeatures}</calcite-chip><calcite-chip icon=compare .label=${t.previewValues} .value=${t.previewValues} @click=${async()=>{this.tableNode.value?.setMode("preview")}} ${(0,m.K)(this.previewChipNode)}>${t.previewValues}</calcite-chip></calcite-chip-group><div class="auto-preview">${t.autoPreview}<calcite-switch .checked=${e} .disabled=${o.f.arcadeExecutor?.isAsync||!1} @calciteSwitchChange=${e=>{o.f.autoPreviewEnabled=e.target.checked,o.f.autoPreviewEnabled&&this.debouncedEditorScriptChange()}} ${(0,m.K)(this.autoPreviewSwitchNode)}></calcite-switch></div></div>`}renderTable(){const{layer:e,originalField:t,_messages:a}=o.f,i={"layer-table":!0,hidden:"map"===this.view};return r.qy`<calcite-panel .heading=${e.title??void 0} class=${(0,g.CP)(i)}><calcite-label class="feature-count" layout=inline slot=header-actions-end><calcite-icon scale=s icon=test-data></calcite-icon>${a.testFeatures}: ${this.testFeatureCount}</calcite-label>${(0,l.D)(`${e.title}${t?.name}`,r.qy`<arcgis-map-config-field-calculate-table @arcgisRecordCountUpdate=${e=>this.testFeatureCount=e.detail} ${(0,m.K)(this.tableNode)}></arcgis-map-config-field-calculate-table>`)}</calcite-panel>`}renderMap(){const{isTable:e}=o.f;return e?"":r.qy`<calcite-panel class=${" map-panel "+("table"===this.view?"hidden":"")}><div class="viewDiv" ${(0,m.K)(this.createMapViewAndPopupTemplate)}></div></calcite-panel>`}renderCalculatePanel(){const{layer:e}=o.f;return r.qy`<calcite-shell-panel slot=panel-start resizable class="panel-border calculate-panel" width=l>${this.renderLayerAndFieldSwitcher()}<arcgis-map-config-field-calculate-editor .editorOpen=${this.editorOpen} @arcgisScriptChange=${async()=>{try{if(o.f.invalidScript=!1,"Arcade"===o.f.selectedLanguage){this.lruCache.clear();const t=x.createArcadeProfile("field-calculation");o.f.arcadeExecutor=await x.createArcadeExecutor(o.f.currentScript,t,{lruCache:this.lruCache,services:{portal:e.portalItem.portal}}),this.autoPreviewSwitchNode.value&&(this.autoPreviewSwitchNode.value.disabled=!!o.f.arcadeExecutor?.isAsync),o.f.arcadeExecutor?.geometryUsed&&this.tableNode.value?.enableGeometry()}else if("SQL"===o.f.selectedLanguage){const t=`${e.url}/${e.layerId}/validateSQL`,a=new FormData;a.append("sql",o.f.currentScript),a.append("sqlType","expression"),a.append("f","json"),(await P({url:t,content:a})).isValidSQL?(o.f.sqlEngine=await N.parseWhereClause(o.f.currentScript,e.fieldsIndex),o.f.sqlEngine.currentUser=e.portalItem.portal.user.username):this.handleInvalidScript()}await this.debouncedEditorScriptChange()}catch{this.handleInvalidScript()}}} @arcgisFilterChange=${async e=>{this.filterPanelOpen&&await this.updateFieldCalcFilter(e.detail,!1)}} @arcgisLanguageSelected=${()=>{this.openFilterPanel(),this.tableNode.value?.refresh(!0)}} @arcgisResetWorkflow=${()=>this.resetWorkflow()} ${(0,m.K)(this.calculationPanelNode)}></arcgis-map-config-field-calculate-editor></calcite-shell-panel>`}renderLayerAndFieldSwitcher(){return this.layerFieldSwitcherOptions?.active?r.qy`<arcgis-map-config-field-calculate-layer-field-switcher .fieldSwitcherDisabled=${this.layerFieldSwitcherOptions.fieldSwitcherDisabled} .layerSwitcherDisabled=${this.layerFieldSwitcherOptions.layerSwitcherDisabled} @arcgisFieldSwitcherChange=${e=>o.f.originalField=e.detail} @arcgisLayerSwitcherChange=${async e=>{await this.loadStore(!0,e.detail.layer,e.detail.field),this.resetWorkflow(),o.f.isTable?this.changeView("table"):(this.map?.layers.removeAll(),this.map?.layers.add(o.f.layer),o.f.layer.popupTemplate=new S.default({title:o.f.layer.displayField?`{${o.f.layer.displayField}}`:`{${o.f.layer.objectIdField}}`,content:c.p,lastEditInfoEnabled:!1}),"table"===this.view&&this.changeView("both")),this.arcgisLayerChange.emit(e.detail)}} @arcgisSwitcherOpen=${()=>{this.filterPanelOpen&&this.calculationPanelNode.value?.closeFilterPopovers()}}></arcgis-map-config-field-calculate-layer-field-switcher>`:""}renderFooter(){const{totalFeatureCount:e,filteredFeatureCount:t,_messages:a}=o.f;return r.qy`<div slot=footer-start class="modal-footer">${this.renderBackButton()}</div><div slot=footer-end class="footer-buttons-end modal-footer">${this.withinPanel&&"none"===this.calculationState&&this.renderViewActions()||""}<calcite-label class="meter-label" alignment=center layout=inline-space-between>${a.selectedFeatures}<calcite-meter class="meter" .label=${a.selectedFeatures} min=0 .max=${e} .value=${t} fill-type=single></calcite-meter></calcite-label><calcite-label class="feature-ratio" layout=inline-space-between>${this.featureRatio}</calcite-label>${!this.withinPanel&&this.renderCancelButton()||""}${this.renderNextButton()}${this.renderRunCalculationsButton()}</div>`}renderBackButton(){const{_messages:e}=o.f;return"none"===this.calculationState&&(this.editorOpen||this.filterPanelOpen)?r.qy`<calcite-button class="button-margin" slot=back width=full alignment=center appearance=transparent icon-start=arrow-left icon-flip-rtl=start @click=${()=>{this.editorOpen?(this.closeEditor(),this.openFilterPanel()):this.filterPanelOpen&&(this.closeFilterPanel(),o.f.workflowState="language-select",this.arcgisWorkflowUpdate.emit("language-select"))}}>${e.back}</calcite-button>`:""}renderNextButton(){const{filteredFeatureCount:e,selectedLanguage:t,_messages:a}=o.f;return this.editorOpen||"none"!==this.calculationState?"":r.qy`<calcite-button class="button-margin" .disabled=${!e||!t} width=full alignment=center appearance=solid icon-end=arrow-right icon-flip-rtl=end @click=${()=>{this.filterPanelOpen?(this.closeFilterPanel(),this.openEditor()):this.openFilterPanel()}}>${a.next}</calcite-button>`}renderRunCalculationsButton(){const{_messages:e}=o.f;return this.editorOpen&&"none"===this.calculationState?r.qy`<calcite-button class="button-margin" width=full alignment=center appearance=solid icon-start=calculator @click=${()=>this.handleRunCalculations()}>${e.runCalculation}</calcite-button>`:""}renderCancelButton(){const{_messages:e}=o.f,t=["success","error"].includes(this.calculationState);return r.qy`<calcite-button .disabled=${"running"===this.calculationState} class="cancel-button" width=full .appearance=${t?"solid":"outline-fill"} alignment=center @click=${()=>{this.arcgisClose.emit(),this.arcgisFieldCalculateClose.emit()}}>${t?e.close:e.cancel}</calcite-button>`}}(0,i.c)("arcgis-map-config-field-calculate",V)}}]);