/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-74d8fa.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-74d8fa"],{41309:(e,t,a)=>{a.r(t),a.d(t,{ArcgisMapConfigLayerViewJoinCreate:()=>S});var i=a(73679),r=a(4395),s=(a(63438),a(18423),a(96086),a(91813),a(21255),a(13078),a(21303),a(12627),a(13661),a(2801)),o=(a(2924),a(33752),a(44345)),n=a(588),d=(a(51072),a(76456)),l=a(4265),c=a(83552),u=a(85643),m=a(73801);async function p(e,t){const{targetItem:a,targetLayer:i,targetLayerId:r,addLayer:d,addLayerId:l}=e,c=a.portal.isPortal,u=Date.now(),m="group"===i.type?(0,s.a)(i).find(e=>e.layerId===r):i,p="group"===d.type?(0,s.a)(d).find(e=>e.layerId===l):d;try{await f(e),c||await async function(e){const{targetLayer:t,targetLayerId:a,addLayer:i,addLayerId:r,attributeRelationships:o}=e;let n="group"===t.type?(0,s.a)(t).find(e=>e.layerId===a):t,d=o.map(e=>e.targetFieldName);await h(n,d,e),n="group"===i.type?(0,s.a)(i).find(e=>e.layerId===r):i,d=o.map(e=>e.addFieldName),await h(n,d,e)}(e);const a=await async function(e,t){const{targetItem:a}=e,{folder:i}=t,r=!i?.id||i.id===a.owner,s=a.portal,d=`${s.restUrl}/content/users/${a.owner}${r?"":`/${i.id}`}/createService`,l=n.default.findCredential(d),c={serviceDescription:"",hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!0,maxRecordCount:2e3,supportedQueryFormats:"JSON",editorTrackingInfo:{enableEditorTracking:!1,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0},capabilities:"Query",description:"",copyrightText:"",allowGeometryUpdates:!1,syncEnabled:!1,xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},tables:[],name:t.title.replace(/ /gu,"_")};if(s.isPortal){const t=await async function(e){await f(e);const{adminServiceInfo:t}=e,a=t?.adminServiceInfo?.database?.datasource||{};return a?.name?.indexOf("/nosqlDatabases")>-1?"spatiotemporal":a?.name?.indexOf("/enterpriseDatabases")>-1?"relational":null}(e);t&&(c.options={dataSourceType:t})}const u={createParameters:JSON.stringify(c),outputType:"featureService"};try{return(await(0,o.default)(d,{query:{...u,f:"json",isView:!0,token:l.token},method:"post",responseType:"json"})).data}catch{return await Promise.reject(new Error("create service failed"))}}(e,t),i={newItemProps:t,createServiceResponse:a,timeStamp:u,targetFL:m,addFL:p};return await async function(e,t){const{createServiceResponse:a,addFL:i,timeStamp:r}=t,{addLayerId:s,joinOperation:o,attributeRelationships:n}=e;if("one-to-one"===o.type&&"summarize"===o.matchType)try{const t=a.serviceurl.replace("rest/services","rest/admin/services"),d=n.map(e=>({name:e.addFieldName,alias:i.fields.find(t=>t.name===e.addFieldName)?.alias||e.addFieldName,source:e.addFieldName})),l=[];o.statisticsFields.forEach(e=>{e.types.forEach(t=>{const a=t.toLowerCase();l.push({name:`${e.fieldName}_${a}`,alias:`${e.fieldName}_${a}`,source:e.fieldName,statisticType:"mean"===a?"avg":a})})});const c={layers:[{name:`${y(i.url,e)}_StatsTable`,description:"tablestatsjoin",adminLayerInfo:{viewLayerDefinition:{table:{materialized:!1,name:`${y(i.url,e)}_${r}_StatsTable`,sourceServiceName:y(i.url,e),sourceLayerId:s,sourceLayerFields:[...d,{name:"join_count",alias:"join_count",source:o.statisticsFields[0].fieldName,statisticType:"count"},...l],groupBy:n.map(e=>e.addFieldName).join(",")}}}}]};return await g(`${t}/addToDefinition`,c,e),Promise.resolve()}catch{return await Promise.reject(new Error("addToDefinition StatsTable failed"))}}(e,i),await async function(e,t){const{createServiceResponse:a,newItemProps:i,targetFL:r,addFL:s,timeStamp:o}=t;try{const t=a.serviceurl.replace("rest/services","rest/admin/services"),n=function(e,t,a,i,r){const{targetLayerId:s,addLayerId:o,joinOperation:n,attributeRelationships:d,adminServiceInfo:l}=e,c=d.map(e=>({name:e.addFieldName,alias:i.fields.find(t=>t.name===e.addFieldName)?.alias||e.addFieldName,source:e.addFieldName}));let u;"one-to-one"===n.type&&"summarize"===n.matchType&&(u=[],n.statisticsFields.forEach(e=>{e.types.forEach(t=>{const a=t.toLowerCase();u.push({name:`${e.fieldName}_${a}`,alias:`${e.fieldName}_${a}`,source:`${e.fieldName}_${a}`})})}));const m={};return m.name=t.title.replace(/ /gu,"_"),m.displayField="",m.description="AttributeJoin",m.adminLayerInfo={viewLayerDefinition:{table:{name:`${y(a.url,e)}_${r}_target`,sourceServiceName:y(a.url,e),sourceLayerId:s,sourceLayerFields:a.fields.filter(e=>"oid"!==e.type).map(e=>({name:e.name,alias:e.alias,source:e.name})),relatedTables:["one-to-one"===n.type&&"summarize"===n.matchType?{name:`${y(i.url,e)}_StatsTable`,sourceServiceName:t.title.replace(/ /gu,"_"),sourceLayerId:0,sourceLayerFields:[...c.filter(e=>!d.some(t=>e.name===t.addFieldName)),{name:"join_count",alias:"join_count",source:"join_count"},...u??[]],type:n.joinType,parentKeyFields:d.map(e=>e.targetFieldName),keyFields:d.map(e=>e.addFieldName)}:{name:`${y(i.url,e)}_${r}_join`,sourceServiceName:y(i.url,e),sourceLayerId:o,sourceLayerFields:i.fields.filter(e=>"oid"!==e.type).map(e=>({name:a.fields.find(t=>t.name.toLowerCase()===e.name.toLowerCase())?`${e.name}_${r}`:e.name,alias:e.alias,source:e.name})),type:n.joinType,parentKeyFields:d.map(e=>e.targetFieldName),keyFields:d.map(e=>e.addFieldName),topFilter:"one-to-one"===n.type&&"first"===n.matchType?{groupByFields:d.map(e=>e.addFieldName).join(","),orderByFields:`${n.sortByFieldName} ${n.sortOrder}`,topCount:1}:void 0}],materialized:!1}},geometryField:a.isTable?null:{name:`${y(a.url,e)}_${r}_target.${l.layers.find(e=>e.id===s).adminLayerInfo.geometryField.name}`}},{layers:[m]}}(e,i,r,s,o);return await g(`${t}/addToDefinition`,n,e),Promise.resolve()}catch{return await Promise.reject(new Error("addToDefinition AttributeJoin failed"))}}(e,i),await async function(e,t){const{createServiceResponse:a,newItemProps:i}=t,{targetItem:r}=e,s=r.portal,d=`${s.restUrl}/content/users/${r.owner}/items/${a.itemId}/update`,l=n.default.findCredential(d),c={title:i.title,tags:i.tags?.length?i.tags.toString():void 0,snippet:i.summary,categories:i.categories?.join(",")};s.isPortal&&(c.typeKeywords="Multi Services View");try{return await(0,o.default)(d,{query:{...c,f:"json",token:l.token},method:"post",responseType:"json"})}catch{return await Promise.reject(new Error("item update request failed"))}}(e,i),a.itemId}catch{return await Promise.reject(new Error("createJoinView failed"))}}async function g(e,t,a,i=!1){let r=n.default.findCredential(e);r||(r=await n.default.getCredential(e));const s={addToDefinition:JSON.stringify(t)};try{return await(0,o.default)(e,{query:{...s,f:"json",token:r.token},method:"post",responseType:"json"}),Promise.resolve()}catch{return i?await Promise.reject(new Error("addToDefinition request failed")):await g(e,t,a,!0)}}function y(e,t){const{targetItem:a}=t,{portal:i}=a,r=e.indexOf("/services/")+10;let s=e.substring(r,e.indexOf("/FeatureServer",r));return i.isPortal&&(s=s.replace("Hosted/","")),s}async function f(e,t){const{targetLayer:a,adminServiceInfo:i}=e;if(i)return;let r=a.portalItem.url.replace("/rest/services","/rest/admin/services");try{await n.default.getCredential(r);const t=await(0,o.default)(r,{query:{f:"json"}});e.adminServiceInfo=t.data}catch{return await Promise.reject(new Error("could not get admin info"))}}async function h(e,t,a){const i={indexes:[]};e.sourceJSON.indexes=e.sourceJSON.indexes||[],t?.forEach(t=>{e.sourceJSON.indexes.some(e=>e.fields===t)||i.indexes.push({name:`${t}_Index`,fields:t,isUnique:!1,isAscending:!0,description:`${t}_Index`})}),i.indexes.length&&await async function(e,t,a){const{targetItem:i}=a,r=`${t.url.replace("/rest/services","/rest/admin/services")}/${t.layerId}/addToDefinition`,s=n.default.findCredential(r),d=i.portal.isPortal,l={f:"json",addToDefinition:JSON.stringify(e),async:!d,token:s.token},c=await(0,o.default)(r,{query:l,method:"post"});if(d)t.sourceJSON.indexes=t.sourceJSON.indexes||[],t.sourceJSON.indexes=t.sourceJSON.indexes.concat(e.indexes);else try{await v(c?.data?.statusURL,{f:"json",token:s.token},a),t.sourceJSON.indexes=t.sourceJSON.indexes||[],t.sourceJSON.indexes=t.sourceJSON.indexes.concat(e.indexes)}catch{}}(i,e,a)}const v=async(e,t,a)=>{if(!e)throw new Error("pollForStatus: no status URL");const i=["processing","partial","Pending","InProgress"],r=["completed","Completed"];try{const s=await(0,o.default)(e,{query:t}),n=s?.data?.status;if(i.includes(n))return await(0,l.t)(500),v(e,t,a);if(r.includes(n))return s;throw new Error(`polling error, status: ${n}`)}catch(e){throw console.error(e),e}},$="info",w="footer",N="footer-top",I="layer-section",T="target-layer",C="add-layer",F="layer-header",L="layer-title",_=r.AH`.panel{height:100%}.info{display:grid;grid-template-columns:repeat(1,minmax(0px,1fr));gap:.5rem;padding:0 .75rem}.footer{width:100%}.footer-top{display:flex}.layer-section{border:1px solid var(--calcite-color-border-3);background-color:#fff;margin:10px}.target-layer{padding:10px;border-bottom:1px solid var(--calcite-color-border-3)}.add-layer{padding:10px}.layer-header{padding-bottom:3px}.layer-title{font-weight:700}.notice{margin:8px}`;class S extends m.WF{constructor(){super(),this._direction=(0,c.jH)(),this.flowItemNode=(0,u._)(),this.backButtonNode=(0,u._)(),this.titleInputNode=(0,u._)(),this.folderPickerNode=(0,u._)(),this.categoriesPickerNode=(0,u._)(),this.tagsPickerNode=(0,u._)(),this.summaryInputNode=(0,u._)(),this.loading=!1,this.arcgisCreateCancel=(0,m.lh)(),this.arcgisCreateDone=(0,m.lh)(),this.arcgisCreateOngoing=(0,m.lh)(),this.arcgisStatusChange=(0,m.lh)(),this.listen("arcgisMsgClosed",this.arcgisMsgClosedHandler)}static{this.properties={loading:16,itemTitle:16,props:0}}static{this.styles=_}async load(){const{props:e}=this,{targetLayer:t,targetLayerId:a,addLayer:i,addLayerId:r}=e;this.targetFL="group"===t.type?(0,s.a)(t).find(e=>e.layerId===a):t,this.addFL="group"===i.type?(0,s.a)(i).find(e=>e.layerId===r):i,this.itemTitle=await async function(e){const{targetItem:t,_messages:a}=e,i=`${t.itemUrl}/relatedItems`,r=n.default.findCredential(i),s=(await(0,o.default)(i,{query:{relationshipType:"Service2Service",direction:"forward",f:"json",token:r.token},method:"post",responseType:"json"}))?.data?.relatedItems?.filter(e=>"Feature Service"===e.type&&(e.title.indexOf(t.title)>-1||e.title.indexOf(t.title?.replace(/ /gu,"_"))>-1||e.title.replace(/ /gu,"_").indexOf(t.title)>-1))||[];return`${a.join.joinFeaturesTo.replace("${name}",t.title??"")}${s.length?` ${s.length+1}`:""} ${a.createView.view}`}(e)}loaded(){requestAnimationFrame(()=>this.backButtonNode.value?.setFocus())}arcgisMsgClosedHandler(){this.msgNode&&(this.msgNode.remove(),this.msgNode=void 0),clearTimeout(this.timeoutHndl),this.timeoutHndl=void 0,this.viewItemId&&this.arcgisCreateDone.emit(this.viewItemId)}goBack(){const{props:e}=this;e.savedItemProps={title:this.titleInputNode.value.itemTitle,tags:this.tagsPickerNode.value.activeTags,summary:this.summaryInputNode.value.summary,categories:this.categoriesPickerNode.value.categories,folder:this.folderPickerNode.value.folder},this.arcgisStatusChange.emit({status:d.j.CONFIG})}async goCreate(){const{props:e}=this;e.savedItemProps={title:this.titleInputNode.value.itemTitle,tags:this.tagsPickerNode.value.activeTags,summary:this.summaryInputNode.value.summary,categories:this.categoriesPickerNode.value.categories,folder:this.folderPickerNode.value.folder};const t={title:this.titleInputNode.value.itemTitle,tags:this.tagsPickerNode.value.activeTags,summary:this.summaryInputNode.value.summary,categories:this.categoriesPickerNode.value.categories,folder:this.folderPickerNode.value.folder};this.loading=!0,this.arcgisCreateOngoing.emit(!0);try{this.viewItemId=await p(e,t),this.showMsg("success")}catch(e){this.showMsg("error",e)}}goCancel(){this.arcgisCreateCancel.emit()}showMsg(e,t){const{props:a,flowItemNode:{value:i},el:s}=this,{_messages:o}=a;this.loading=!1,this.arcgisCreateOngoing.emit(!1),"success"!==e&&console.error("could not create join view",t),this.msgNode=(0,m.dN)(r.qy`<arcgis-map-config-layer-view-msg .props=${a} .flowItemElement=${i} .message=${"success"===e?o.msg.created:o.msg.createFailed} .isError=${"success"!==e} @arcgisMsgClosed=${()=>{clearTimeout(this.timeoutHndl),this.removeMsg(e)}}></arcgis-map-config-layer-view-msg>`),s.shadowRoot.appendChild(this.msgNode),clearTimeout(this.timeoutHndl),this.timeoutHndl=setTimeout(()=>this.removeMsg(e),7e3)}removeMsg(e){this.timeoutHndl=void 0,this.msgNode&&(this.msgNode.remove(),this.msgNode=void 0,"success"===e&&this.arcgisCreateDone.emit(this.viewItemId))}render(){const{props:e,loading:t}=this,{_messages:a}=e;return this.el.classList.add("calcite-match-height"),r.qy`<calcite-flow-item .heading=${a.join.create} .loading=${t} selected class="panel" ${(0,u.K)(this.flowItemNode)}>${this.renderFooterButtons()}${this.renderLayers()}${this.renderInfo()}</calcite-flow-item>`}renderFooterButtons(){return r.qy`<div slot=footer class=${(0,m.CP)(w)}><div class=${(0,m.CP)(N)}>${this.renderBack()}${this.renderCreate()}</div>${this.renderCancel()}</div>`}renderBack(){const{props:e}=this,{_messages:t}=e,a="rtl"===this._direction;return r.qy`<calcite-button @click=${this.goBack} appearance=outline-fill width=half .iconStart=${a?"arrow-right":"arrow-left"} .label=${t.general.back} ${(0,u.K)(this.backButtonNode)}>${t.general.back}</calcite-button>`}renderCreate(){const{props:e,itemTitle:t,titleError:a,summaryError:i}=this,{_messages:s}=e,o=t&&!a&&!i;return r.qy`<calcite-button .disabled=${!o} @click=${o?this.goCreate:void 0} appearance=solid width=half icon-start=plus-square .label=${s.createView.create}>${s.createView.create}</calcite-button>`}renderCancel(){const{props:e}=this,{_messages:t}=e;return r.qy`<calcite-button @click=${this.goCancel} appearance=transparent width=full .label=${t.general.cancel}>${t.general.cancel}</calcite-button>`}renderLayers(){const{props:e,targetFL:t,addFL:a}=this,{targetItem:i,targetLayer:s,addItem:o,addLayer:n,_messages:d}=e,l="rtl"===this._direction,c="group"===s.type?l?`${t.title} / ${i.title}`:`${i.title} / ${t.title}`:s.title,u="group"===n.type?l?`${a.title} / ${o.title}`:`${o.title} / ${a.title}`:n.title;return r.qy`<div class=${(0,m.CP)(I)}><div class=${(0,m.CP)(T)}><div class=${(0,m.CP)(F)}>${d.join.targetLayer}</div><div class=${(0,m.CP)(L)}>${c}</div></div><div class=${(0,m.CP)(C)}><div class=${(0,m.CP)(F)}>${d.join.joinLayer}</div><div class=${(0,m.CP)(L)}>${u}</div></div></div>`}renderInfo(){const{props:e,itemTitle:t}=this,{targetItem:a,targetItemOwner:i,savedItemProps:s}=e,{portal:o}=a,n=o.user,d={portal:o,user:n,api:4};return r.qy`<div class=${(0,m.CP)($)}><arcgis-item-properties .portal=${o} .user=${n} .api=${4} .config=${d} .type=${"Feature Service"} .scale=${"s"}><arcgis-title-input .itemTitle=${s?s.title:t} .enablePublishing=${!0} @arcgisTitleInputChange=${async e=>{const t=await e.target.validateTitle();this.titleError=t}} ${(0,u.K)(this.titleInputNode)}></arcgis-title-input><arcgis-folder-picker .folder=${s?s.folder:a.ownerFolder&&{id:a.ownerFolder,username:a.owner}} .user=${i} ${(0,u.K)(this.folderPickerNode)}></arcgis-folder-picker><arcgis-categories-picker .categories=${s?s.categories:a.categories} ${(0,u.K)(this.categoriesPickerNode)}></arcgis-categories-picker><arcgis-tags-picker .activeTags=${s?s.tags:a.tags} ${(0,u.K)(this.tagsPickerNode)}></arcgis-tags-picker><arcgis-summary-input .summary=${s?s.summary:a.snippet||""} @arcgisSummaryInputChange=${async e=>{const t=await e.target.getErrorMessage();this.summaryError=t}} ${(0,u.K)(this.summaryInputNode)}></arcgis-summary-input></arcgis-item-properties></div>`}}(0,i.c)("arcgis-map-config-layer-view-join-create",S)},76456:(e,t,a)=>{a.d(t,{a:()=>s,b:()=>r,g:()=>o,h:()=>n,j:()=>i});var i=(e=>(e[e.ERROR=0]="ERROR",e[e.LOADING=1]="LOADING",e[e.TARGET_SELECTION=2]="TARGET_SELECTION",e[e.ADD_SELECTION=3]="ADD_SELECTION",e[e.BROWSE_LAYER=4]="BROWSE_LAYER",e[e.CONFIG=5]="CONFIG",e[e.CREATE=6]="CREATE",e))(i||{});function r(e,t){const{fields:a,popupTemplate:i}=e,r=i?.fieldInfos,s=a.find(e=>t===e.name);return s&&r?.find(e=>e.fieldName===s.name)?.label||s?.alias||t}function s(e,t){const{fields:a}=e;return a.find(e=>t===e.name)?.type||""}function o(e,t){const{_messages:a}=t;return e.isTable?a.general.table:"point"===e.geometryType||"multipoint"===e.geometryType?a.join.pointLayer:"polyline"===e.geometryType?a.join.polylineLayer:"polygon"===e.geometryType?a.join.polygonLayer:""}function n(e){return e.sourceJSON.ownershipBasedAccessControlForFeatures&&(!1===e.sourceJSON.ownershipBasedAccessControlForFeatures?.allowAnonymousToQuery||!1===e.sourceJSON.ownershipBasedAccessControlForFeatures?.allowOthersToQuery)}}}]);