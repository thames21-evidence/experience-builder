/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-7b408f.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_com-7b408f"],{2079:(e,t,i)=>{i.d(t,{a:()=>o,i:()=>s});var a=i(42855);function s(e,t,i,s){const{layer:o}=e;switch(t){case a.l.feature:return!!(o&&i===a.s.wms||o&&o.popupTemplate)&&o.popupEnabled;case a.l.cluster:return!!o&&o.featureReduction.popupEnabled;case a.l.mapNotes:return s;default:return!!o?.popupEnabled}}function o(e,t){const i="CALCITE-INPUT"===e.tagName,a=i?e.shadowRoot.querySelector("input"):e.shadowRoot.querySelector("textarea"),s=a.selectionStart,o=[e.value.slice(0,s),`{${t}}`,e.value.slice(s)].join("");e.value=o;const r=s+2+t.length;setTimeout(()=>{i?e.setFocus():(a?.setSelectionRange(r,r),a?.focus()),a?.setSelectionRange(r,r)},1)}},4265:(e,t,i)=>{i.d(t,{a:()=>s,d:()=>a,t:()=>o});const a=(e,t)=>{let i,a="idle";const s=async(...s)=>await new Promise(o=>{switch(a){case"flushed":a="idle",i?(clearTimeout(i),o(e(...s))):o(null);break;case"invoked":clearTimeout(i),a="idle",o(e(...s));break;case"cancelled":clearTimeout(i),a="idle",o(null);break;default:i&&clearTimeout(i),a="pending",i=setTimeout(()=>{a="idle",o(e(...s))},t)}});return s.flush=async function(...e){return a="flushed",await s(...e)},s.invoke=async function(...e){return a="invoked",await s(...e)},s.cancel=async function(...e){return a="cancelled",await s(...e)},s.getStatus=function(){return a},s},s=(e,t)=>{let i;return async(...a)=>await new Promise(s=>{i||(i=setTimeout(()=>{clearTimeout(i),i=void 0,s(e(...a))},t))})};function o(e){return new Promise(t=>setTimeout(t,e))}},7426:(e,t,i)=>{i.r(t),i.d(t,{ArcgisMapConfigPopup:()=>M});var a=i(73679),s=i(4395),o=i(54312),r=i(94206),n=i(13416),p=i(50893),l=i(72646),c=i(6550),d=i(28777),u=i(42106),h=i(50335),m=i(8690),y=i(2832),g=i(31526),f=i(50970),b=i(45075),w=i(97802),v=i(83552),P=i(42855),T=i(66228),C=i(4265),k=i(30812),$=i(83926),F=i(34132),I=i(81565),N=i(34883),E=i(2079),A=i(39258),D=i(98295),L=i(72978),S=i(10763),R=i(85643),x=i(47640),H=i(73801),O=i(58611),_=i(36486);async function q(e){const{popupTemplate:t}=e,i=[],a=(0,N.g)(e);if(function(e){const{popupTemplate:t,layerDisplayType:i}=e;return i===P.l.feature&&("fields"!==(t?.content)[0]?.type||!!t.content[0]?.fieldInfos)}(e)){const s=I.createFieldsContent({fields:await(0,T.k)(a),objectIdField:a.objectIdField,editFieldsInfo:a?.editFieldsInfo??void 0}).fieldInfos,o=new Map(t.fieldInfos.map(e=>[e.fieldName,e]));s.forEach(t=>{if(o.has(t.fieldName)){const a=o.get(t.fieldName);U(e,a),i.push(a),i[i.length-1].visible=!0}}),t.fieldInfos.forEach(e=>{(e.fieldName.includes(P.f.expression)||e.fieldName.includes(P.f.relationship))&&e.visible&&i.push(e.clone())})}else t.fieldInfos.forEach(t=>{if(t.visible){const a=t.clone();U(e,a),i.push(a)}});return i}function U(e,t){const{layerDisplayType:i}=e;if(i!==P.l.feature)return;const a=(0,N.g)(e);if((0,T.s)(a)){const e=a.getFieldConfiguration(t.fieldName);e&&(t.fieldFormat=e.fieldFormat)}}const B=s.AH`.error-notice{margin:var(--calcite-spacing-sm)}.error-message-wrapper{margin:var(--calcite-spacing-md)}.enable-popup-switch{background-color:var(--calcite-color-foreground-1);padding:var(--calcite-spacing-lg) var(--calcite-spacing-sm) var(--calcite-spacing-xxs);border-bottom:solid 1px var(--calcite-color-foreground-3)}.imagery-options{padding:0 var(--calcite-spacing-md)}.edit-info-summary{display:flex;align-items:center;justify-content:space-between}.edit-info-icon{padding:0 var(--calcite-spacing-sm)}.edit-info-text{font-size:var(--calcite-font-size)}`;class M extends H.WF{constructor(){super(),this._direction=(0,v.jH)(),this._initialized=!1,this._loaded=!1,this._propWatcherTask=new x.YZ(this,{task:async([e,t])=>{if(!(0,T.i)(e)||!(0,T.i)(t))throw console.error("[arcgis-map-config-popup] Required properties are missing."),new Error("Required properties are missing.");this._propWatcherTask.autoRun=!1,await this.init()},args:()=>[this.mapView,this.portal]}),this._messages=(0,_.u)({blocking:!0}),this.hasError=!1,this.hasBackingFeatureLayerError=!1,this.hadBackingFeatureLayer=!1,this.isPopupOpenForCurrentLayer=!1,this.popupComponents=[],this.fieldsAndExpressionsData=[],this.fieldsOnlyData=[],this.arcadeBlockOptionsNodes=[],this.relationshipBlockOptionsNodes=[],this.relationshipIconNodes=[],this.associationsBlockNodes=[],this.enablePopupsSwitchNode=(0,R._)(),this.backingFeatureLayerCardNode=(0,R._)(),this.popupContentWrapperNode=(0,R._)(),this.blockGroupNode=(0,R._)(),this.internalCalciteFabNode=(0,R._)(),this.editInfoDivNode=(0,R._)(),this.layerHasAttributes=!0,this.layerHasCharts=!0,this.layerHasImages=!0,this.layerHasText=!0,this.layerHasRelatedRecords=!1,this.popupState=(0,S.u)(),this.handlePopupUpdate=(0,C.d)(e=>{if(this.mapView.popup?.selectedFeature&&this.mapView.popup?.selectedFeatureWidget?.flowItems?.length){const e=this.mapView.popup.selectedFeature;this.mapView.popup.features=[],setTimeout(()=>this.mapView.popup.features=[e],1e3)}this.multiplePopupsSelected&&this.arcgisMultiplePopupsSelected.emit(),!this.disableEditing&&((!e||!this.layer?.popupTemplate)&&this.serviceType!==P.s.wms&&(this.layer&&this.layerDisplayType===P.l.feature?this.layer.popupEnabled===this.enablePopupsSwitchNode.value?.checked&&(this.layer.popupTemplate=this.popupTemplate.clone(),this.backingFeatureLayer&&(this.backingFeatureLayer.popupTemplate=this.popupTemplate.clone())):this.layerDisplayType===P.l.cluster&&(this.layer.featureReduction.popupTemplate=this.popupTemplate.clone())),this.layerDisplayType===P.l.mapNotes?this.arcgisChange.emit({mapNotesPopupTemplate:this.mapNotesPopupEnabled?this.popupTemplate.clone():void 0}):this.arcgisChange.emit(),this.disableEditing=this.multiplePopupsSelected)},1e3),this.showConfigureFields=!1,this.hideManageExpressions=!1,this.hidePopup=!1,this.hideLayerTitle=!1,this.backButton=!1,this.dismissible=!1,this.allowTimeSeriesConfiguration=!1,this.layerDisplayType=P.l.feature,this.multiplePopupsSelected=!1,this.disableEditing=!1,this.store=(0,O.y$)({mapView:void 0,layer:void 0,backingFeatureLayer:void 0,portal:void 0,config:void 0,_messages:void 0,popupTemplate:void 0,layerDisplayType:void 0,serviceType:void 0,layerHasAttributes:void 0,layerSupportsAttachments:void 0,layerHasCharts:void 0,layerHasImages:void 0,layerHasText:void 0,layerSupportsArcade:void 0,layerHasRelatedRecords:!1,layerIsUNLayer:void 0,layerHasEditInfo:void 0,blockFeatureReductionArcade:!1}),this.arcgisChange=(0,H.lh)(),this.arcgisClose=(0,H.lh)(),this.arcgisMultiplePopupsSelected=(0,H.lh)(),this.arcgisHasBackingFeatureLayer=(0,H.lh)(),this.closePopupPopovers=(0,H.lh)(),this.listenOn(window,"arcadeChangeNotification",this.arcadeChangeNotificationHandler),this.listenOn(window,"closePopupPopovers",this.closePopupPopoversHandler)}static{this.properties={mapView:0,layer:0,portal:0,config:0,showConfigureFields:5,hideManageExpressions:5,hidePopup:5,hideLayerTitle:5,backButton:5,dismissible:5,allowTimeSeriesConfiguration:5,calciteFlowProps:0,layerDisplayType:0,mapNotesPopupTemplate:0,mapNotesGraphic:0,multiplePopupsSelected:5,disableEditing:5,store:0}}static{this.styles=B}async done(){if(!this._initialized)return;const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-multimedia"));await Promise.all(e.map(async e=>await e.resetMultimediaIndex())),this.fieldsNode?.done(),this.closePopupPopovers.emit(),await this.showPreviewPopup(!1)}async refresh(){this.handlePopupUpdate()}async setFocus(){this.activeCalciteFabNode?.setFocus()}async updated(){this._propWatcherTask.status===x.e1.COMPLETE&&this._initialized&&!this._loaded&&(this._loaded=!0,await this.setUpDisplay())}async disconnectedCallback(){super.disconnectedCallback(),this.resizeObserver?.disconnect(),this.layerTableHandle?.remove(),this.featureReductionArcadeHandle?.remove(),this.utilityNetworkLayerHandle?.remove(),this.addContentPopoverNode?.remove(),this.addContentPopoverNode=void 0,this.activeCalciteFabNode?.remove(),this.activeCalciteFabNode=void 0,this.fieldsNode?.parentElement&&(await this.fieldsNode.done(),this.fieldsNode.parentElement.remove(),this.fieldsNode=void 0),this.expressionsNode?.parentElement&&(this.expressionsNode.parentElement.remove(),this.expressionsNode=void 0)}async init(){if(!this.layer&&this.layerDisplayType!==P.l.mapNotes)return this.hasError=!0,void console.error("Required properties are missing.");await this.setUpState(!0),this._initialized=!0}arcadeChangeNotificationHandler(){const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-richtext"));if(e?.length){const t=this.popupTemplate?.toJSON().expressionInfos.map(({expression:e,name:t,returnType:i,title:a})=>({name:`expression/${t}`,alias:"New expression"===a?" ":a,type:i,description:e}));this.fieldsAndExpressionsData=t?[...t,...this.fieldsOnlyData]:this.fieldsOnlyData,e.forEach(e=>{e.arcgisColorPickerData.data=this.fieldsAndExpressionsData,e.fieldExpressionData.data=this.fieldsAndExpressionsData})}this.requestUpdate()}closePopupPopoversHandler(){this.addContentPopoverNode&&(this.addContentPopoverNode.remove(),this.addContentPopoverNode=void 0,this.activeCalciteFabNode.disabled=!1,this.activeCalciteFabNode.setFocus(),this.handleDisablePopupPanel(!1))}internalFlowRefHandler(e){e&&(this.internalFlowNode=e)}wrappingFlowItemRefHandler(e){e&&(this.wrappingFlowItemNode=e)}divRefHandler(){const{calciteFlowProps:e}=this;this.wrappingFlowItemNode=e.calciteFlowItem}buttonRefHandler(e){e&&(this.browseFeatureLayersNode=e)}backingFeatureLayerScrimRefHandler(e){e&&(this.backingFeatureLayerScrimNode=e)}arcadeBlockOptionsRefHandler(e){e&&this.arcadeBlockOptionsNodes.push(e)}relatedRecordsBlockOptionsRefHandler(e){e&&this.relationshipBlockOptionsNodes.push(e)}iconRefHandler(e){e&&this.relationshipIconNodes.push(e)}associationsBlockRefHandler(e){e&&this.associationsBlockNodes.push(e)}async setUpState(e){e||(this.layerHasAttributes=!0,this.layerSupportsAttachments=!1,this.layerHasCharts=!0,this.layerHasImages=!0,this.layerHasText=!0,this.layerSupportsArcade=!1,this.layerHasRelatedRecords=!1,this.layerHasEditInfo=!1,(0,S.c)(this.popupState),this.resizeObserver?.disconnect(),this.layerTableHandle?.remove(),this.featureReductionArcadeHandle?.remove(),this.utilityNetworkLayerHandle?.remove());const{popupState:t}=this;if(this.serviceType=this.layer?(0,T.a)(this.layer):P.s.feature,this.layer&&"load"in this.layer&&await this.layer.load(),this.backingFeatureLayer&&await this.backingFeatureLayer.load(),this.layerSupportsArcade=!this.hideManageExpressions&&(this.layerDisplayType===P.l.feature||this.layerDisplayType===P.l.cluster)&&this.serviceType!==P.s.ogcFeature&&this.serviceType!==P.s.imagery&&this.serviceType!==P.s.imageryTile&&this.serviceType!==P.s.wcs,this.layer&&(0,T.p)(this.layer))this.hasError=!0;else if(this.serviceType!==P.s.wms){if(this.hasError=!1,this.layer&&(0,T.r)(this.layer)&&e){const e=new c.default({url:this.layer.url});await e.load(),e.popupEnabled=this.layer.popupEnabled,e.popupTemplate=this.layer.popupTemplate?.clone(),this.backingFeatureLayer=e}const t=this.backingFeatureLayer??this.layer;if(this.layer&&this.layerDisplayType===P.l.feature){const i=this.mapView.popup.visible?this.mapView.popup.selectedFeature?.sourceLayer:void 0,a="type"in t?t.type:"sublayer";if(this.isPopupOpenForCurrentLayer="subtype-sublayer"===a?i?.subtypeCode===t.subtypeCode&&i?.parent.id===t.parent.id:"sublayer"===a?i?.id===t.id&&i?.layer.id===t.layer.id:"id"in t&&i?.id===t.id,!this.backingFeatureLayer||(0,T.r)(this.layer)&&e){const e=this.layer;this.popupTemplate=e.popupTemplate?e.popupTemplate.clone():e.createPopupTemplate(),this.popupTemplate.fieldInfos=[...await(0,k.g)(this.backingFeatureLayer??this.layer,this.popupTemplate)]}else this.popupTemplate=this.backingFeatureLayer.popupTemplate?this.backingFeatureLayer.popupTemplate.clone():this.backingFeatureLayer.createPopupTemplate(),this.popupTemplate.fieldInfos=[...await(0,k.g)(this.backingFeatureLayer,this.popupTemplate)];(0,T.i)(t.capabilities?.data?.supportsAttachment)&&(this.layerSupportsAttachments=t.capabilities.data.supportsAttachment);const s=(0,T.a)(t);this.layerHasRelatedRecords=await(0,A.l)(t,this.mapView,s),this.layerHasEditInfo=!!t.editFieldsInfo,this.serviceType===P.s.mapImage&&!t.popupTemplate&&(this.layer.popupEnabled=!1)}else this.layerDisplayType===P.l.cluster?(this.popupTemplate=t.featureReduction.popupTemplate.clone(),this.layerSupportsAttachments=!1,this.layerHasEditInfo=!1):this.layerDisplayType===P.l.mapNotes&&(this.mapNotesPopupTemplate?(this.mapNotesPopupEnabled=!0,this.popupTemplate=this.mapNotesPopupTemplate.clone()):(this.mapNotesPopupEnabled=!1,this.popupTemplate=new g.default),this.layerHasAttributes=!1,this.layerSupportsAttachments=!1,this.layerHasCharts=!1,this.layerHasEditInfo=!1)}t.layer=this.layer,t.backingFeatureLayer=this.backingFeatureLayer,t.mapView=this.mapView,t.portal=this.portal,t.config=this.config,t._messages=this._messages,t.popupTemplate=this.popupTemplate,t.layerDisplayType=this.layerDisplayType,t.serviceType=this.serviceType,t.layerHasAttributes=this.layerHasAttributes,t.layerSupportsAttachments=this.layerSupportsAttachments,t.layerHasCharts=this.layerHasCharts,t.layerHasImages=this.layerHasImages,t.layerHasText=this.layerHasText,t.layerSupportsArcade=this.layerSupportsArcade,t.layerHasRelatedRecords=this.layerHasRelatedRecords,t.layerIsUNLayer=(0,L.i)(this.popupState),t.layerHasEditInfo=this.layerHasEditInfo,t.blockFeatureReductionArcade=(0,F.e)(this.popupState),t.allowTimeSeriesConfiguration=this.allowTimeSeriesConfiguration;const{layerDisplayType:i,serviceType:a,mapNotesPopupEnabled:s}=this,o=(0,E.i)(t,i,a,s);this.calciteFlowProps?.calciteFab&&!o&&(this.calciteFlowProps.calciteFab.hidden=!0),this.layerDisplayType===P.l.cluster&&(this.featureReductionArcadeHandle=this.getFeatureReductionArcadeHandle(t)),t.layerIsUNLayer&&(this.utilityNetworkLayerHandle=this.getUtilityNetworkLayerHandle(t))}async setUpDisplay(){const{_messages:e,popupState:t,layerDisplayType:i}=this,a=(0,N.g)(t);if(this.popupTemplate&&("string"==typeof this.popupTemplate.content&&(this.popupTemplate.content=[new b.default({text:this.popupTemplate.content})]),Array.isArray(this.popupTemplate.content)?(await Promise.all(this.popupTemplate.content.map(async(e,t)=>{if("fields"===e.type){const t=i===P.l.cluster?a.featureReduction.fields:await(0,T.k)(a),s=(0,T.h)(this.popupTemplate),o=(e.fieldInfos??await q(this.popupState)).filter(e=>{const i=t.find(t=>t.name===e.fieldName),a=s.get(e.fieldName);return i?!("visible"in i)||i.visible:!!a});e.fieldInfos=o,e.title=e.title??"",e.description=e.description??""}"attachments"===e.type&&!this.layerSupportsAttachments&&this.popupTemplate.content.splice(t,1)})),this.popupTemplate.content.forEach(e=>this.addNewPopupContentToExistingPopupContent(e))):console.error("content not supported"),this.requestUpdate()),this.serviceType!==P.s.wms){if(this.layerDisplayType===P.l.feature&&this.watchForChangesToLayersList(),this.calciteFlowProps&&!this.calciteFlowProps.calciteFab){const i=(0,H.dN)(s.qy`<calcite-fab icon=plus slot=fab scale=s appearance=outline-fill kind=neutral .label=${e.addContent} .text=${e.addContent} text-enabled @click=${async e=>{e.stopPropagation(),await this.handleFabClick()}}></calcite-fab>`),{layerDisplayType:a,serviceType:o,mapNotesPopupEnabled:r}=this;(0,E.i)(t,a,o,r)||(i.hidden=!0),this.calciteFlowProps.calciteFab=i,this.calciteFlowProps.calciteFlowItem.appendChild(i)}setTimeout(()=>{this.activeCalciteFabNode=this.calciteFlowProps?.calciteFab??this.internalCalciteFabNode.value},1)}this.handlePopupUpdate(),this.wrappingFlowItemNode?.setFocus(),this.setUpResizeObserver()}showPopupContentInPanel(e){const{serviceType:t}=this;t!==P.s.wms&&(this.popupContentWrapperNode.value.style.display=e?"block":"none",this.activeCalciteFabNode.style.display=e?"block":"none"),this.closePopupPopovers.emit()}handleDisablePopupPanel(e){this.wrappingFlowItemNode.disabled=e}async openItemBrowser(){const{_messages:e,portal:t}=this,i=(0,H.dN)(s.qy`<arcgis-map-config-popup-browse-feature-layers .portal=${t} ._messages=${e} @arcgisClose=${async e=>{e.stopPropagation(),this.wrappingFlowItemNode.loading=!0,i.remove(),this.backingFeatureLayerPendingAction=void 0;const t=e.detail?.[0].item,a=e.detail?.[0].sublayer;if(t&&a){this.backingFeatureLayer=void 0,this.popupComponents=[];const e=`${t.url}/${a.id}`;await this.updateTileLayerBackingFeatureLayer(e)}else this.requestUpdate();this.wrappingFlowItemNode.loading=!1,this.browseFeatureLayersNode&&(this.browseFeatureLayersNode.disabled=!1,this.browseFeatureLayersNode.setFocus())}}></arcgis-map-config-popup-browse-feature-layers>`);document.body.appendChild(i)}createLayerOptions(){const e=this.popupTemplate.layerOptions??new m.default;e.showNoDataRecords=e.showNoDataRecords??!1,e.returnTopmostRaster=e.returnTopmostRaster??!0,this.popupTemplate.layerOptions=e}async showPreviewPopup(e){const{mapView:t,hasError:i,layerDisplayType:a}=this,s=t;if(!i)if(!this.layer||this.hidePopup||a!==P.l.feature||this.isPopupOpenForCurrentLayer)a===P.l.mapNotes&&(e&&this.mapNotesGraphic?s.openPopup({features:[this.mapNotesGraphic],location:(0,T.o)(this.mapNotesGraphic.geometry)}):s.closePopup());else if(e&&this.layer.popupEnabled&&this.layer.popupTemplate){s.popup?.features?.length&&(s.closePopup(),s.popup.features=[]),this.previewPopupController=new AbortController;try{await(0,$.p)(this.mapView,this.layer,this.previewPopupController)}catch(e){this.backingFeatureLayer||console.error(e)}}else this.previewPopupController?.abort(),s.closePopup()}async handleFabClick(){const{popupState:e}=this;this.addContentPopoverNode||(this.addContentPopoverNode=(0,H.dN)(s.qy`<arcgis-map-config-popup-add-content-popover .referenceElement=${this.activeCalciteFabNode} .popoverPanelWidth=${this.el.getBoundingClientRect().width} .popupState=${e} @arcgisAddPopoverContent=${async e=>{const t=e.detail;await this.handleAddNewPopupContent(t)}}></arcgis-map-config-popup-add-content-popover>`),document.body.appendChild(this.addContentPopoverNode),this.activeCalciteFabNode.disabled=!0,this.handleDisablePopupPanel(!0))}async handleAddNewPopupContent(e){this.closePopupPopovers.emit(),e===D.C.EDIT_INFO_SUMMARY?(this.popupTemplate.lastEditInfoEnabled=!0,setTimeout(()=>{this.editInfoDivNode.value?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),this.activeCalciteFabNode.setFocus()},300)):await this.createNewPopupContent(e),this.requestUpdate()}async createNewPopupContent(e){const{popupState:t,layerDisplayType:i}=this,a=(0,N.g)(t);let s=null;if(e===D.C.ATTRIBUTES){const e=i===P.l.cluster?a.featureReduction.fields:await(0,T.k)(a),t=(0,T.h)(this.popupTemplate),o=(await q(this.popupState)).filter(i=>{const a=e.find(e=>e.name===i.fieldName),s=t.get(i.fieldName);return a?!("visible"in a)||a.visible:!!s});s=new d.default({fieldInfos:o,title:"",description:""})}else if(e===D.C.ATTACHMENTS)s=new r.default({displayType:void 0});else if(e===D.C.CHARTS){const e=new p.default({title:"",caption:"",altText:"",value:new n.default({fields:[]})});s=new y.default({mediaInfos:[e]})}else if(e===D.C.IMAGES){const e=new u.default({title:"",caption:"",altText:"",value:new h.default({sourceURL:"",linkURL:""})});s=new y.default({mediaInfos:[e]})}else if(e===D.C.RICH_TEXT)s=new b.default({text:null});else if(e===D.C.ARCADE)s=new l.default({expressionInfo:{expression:(0,F.f)(this.layerDisplayType,this._messages)}});else if(e===D.C.RELATIONSHIP){const e=await(0,A.a)(a,this.mapView,this.serviceType);let t=e.currLayer.fields.find(e=>e.visible&&"date"===e.type);t||(t=e.currLayer.fields.find(e=>e.visible)),s=new f.default({displayCount:1,relationshipId:e.relationship.id,orderByFields:[{field:t.name,order:"asc"}]})}else if(e===D.C.ASSOCIATIONS){const e=[{type:"attachment"}];s=new w.default({associationTypes:e,displayCount:1,title:"",description:""})}this.popupTemplate.content.push(s),this.addNewPopupContentToExistingPopupContent(s,!0),this.handlePopupUpdate(),this.requestUpdate(),this.scrollToNewPopupComponent&&setTimeout(()=>{const e=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),t=e[e.length-1];t?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),t?.setFocus(),this.scrollToNewPopupComponent=!1},300)}addNewPopupContentToExistingPopupContent(e,t=!1){t&&(this.scrollToNewPopupComponent=!0),"fields"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttributes(e,t)]:"attachments"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttachments(e,t)]:"media"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupMultimedia(e,t)]:"text"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupText(e,t)]:"expression"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupArcade(e,t)]:"relationship"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupRelationship(e,t)]:"utility-network-associations"===e.type&&(this.popupComponents=[...this.popupComponents,this.renderPopupAssociations(e,t)])}handleManageExpressionsClick(){const{_messages:e}=this;this.closePopupPopovers.emit();const t=(0,H.dN)(s.qy`<calcite-flow-item .heading=${e.manageExpressions} selected @calciteFlowItemBack=${()=>{t.remove(),this.expressionsNode=void 0,this.wrappingFlowItemNode.selected=!0}}></calcite-flow-item>`);this.expressionsNode=(0,H.dN)(s.qy`<arcgis-map-config-popup-expressions .popupState=${this.popupState} @arcgisChange=${e=>{e.stopPropagation(),this.handlePopupUpdate()}}></arcgis-map-config-popup-expressions>`),t.appendChild(this.expressionsNode),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(t):this.internalFlowNode?.appendChild(t),this.wrappingFlowItemNode.selected=!1,this.expressionsNode.setFocus()}handleDeleteIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),i=e.target,a=Array.from(t).indexOf(i);this.popupTemplate.content.splice(a,1);const s=this.blockGroupNode.value.children[a];this.blockGroupNode.value.removeChild(s),this.popupComponents=[...this.blockGroupNode.value.children],this.handlePopupUpdate(),this.requestUpdate(),this.activeCalciteFabNode?.setFocus()}handleDuplicateIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),i=e.target,a=Array.from(t).indexOf(i),s=this.popupTemplate.content[a].clone();this.popupTemplate.content.push(s),this.addNewPopupContentToExistingPopupContent(s,!0),this.handlePopupUpdate(),this.requestUpdate(),this.scrollToNewPopupComponent&&setTimeout(()=>{const e=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),t=e[e.length-1];t?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),t?.setFocus(),this.scrollToNewPopupComponent=!1},300)}async setUpResizeObserver(){const{layerDisplayType:e}=this,t=this.el?.parentElement;if("CALCITE-SHELL-PANEL"===t?.tagName){const e=t;(0,T.i)(e.collapsed)&&(this.resizeObserver?.disconnect(),this.resizeObserver=new ResizeObserver(async()=>{if(e.collapsed)this.done();else{const{mapView:e}=this;e.popup?.active||await this.showPreviewPopup(!0)}}),this.resizeObserver.observe(e))}else(e!==P.l.mapNotes||(0,T.i)(this.mapNotesPopupTemplate))&&await this.showPreviewPopup(!0)}watchForChangesToLayersList(){const{popupState:e,layerDisplayType:t,serviceType:i}=this,a=(0,N.g)(e);t===P.l.feature&&[P.s.feature,P.s.mapImage].includes(i)&&a?.relationships?.length&&(this.layerTableHandle=o.watch(()=>[this.mapView.map?.allLayers.length,this.mapView.map?.allTables.length],async()=>{this.popupState.layerHasRelatedRecords=await(0,A.l)(a,this.mapView,this.serviceType),this.relationshipBlockOptionsNodes?.forEach(e=>{e.options.disableDuplicate=!this.popupState.layerHasRelatedRecords,e.manager.component.requestUpdate()}),this.relationshipIconNodes?.forEach(e=>{e.icon=this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle"})}))}getFeatureReductionArcadeHandle(e){const{mapView:t}=e,i=(0,N.g)(e);return o.watch(()=>t.scale,()=>{const e=i.featureReduction;t.scale<=e.maxScale&&!this.popupState.blockFeatureReductionArcade?this.popupState.blockFeatureReductionArcade=!0:t.scale>e.maxScale&&this.popupState.blockFeatureReductionArcade&&(this.popupState.blockFeatureReductionArcade=!1),this.arcadeBlockOptionsNodes?.forEach(e=>{e.options.disableDuplicate=this.popupState.blockFeatureReductionArcade,e.manager.component.requestUpdate()})})}getUtilityNetworkLayerHandle(e){const{mapView:t}=e,{map:i}=t,a=(0,N.g)(e);return o.watch(()=>i.utilityNetworks?.length,e=>{if(e){const e=(0,L.g)(a),t=i.utilityNetworks.find(t=>t.sourceJSON?.serviceItemId===e);this.popupState.layerIsUNLayer=(0,T.i)(t)}else this.popupState.layerIsUNLayer=!1;this.associationsBlockNodes?.forEach(e=>{e.disabled=!this.popupState.layerIsUNLayer,this.popupState.layerIsUNLayer||(e.open=!1)}),this.closePopupPopovers.emit()})}getAttachmentContentDescription(e){const{popupState:t}=this,{_messages:i}=t;switch(e.displayType){case D.A.AUTO:return i.auto;case D.A.LIST:return i.list;case D.A.PREVIEW:return i.gallery;default:return i.list}}getMediaBlockDescription(e){const{popupState:t}=this,{_messages:i}=t;return e.mediaInfos.length>1?`${i.multiple} (${e.mediaInfos.length})`:e.mediaInfos.length?this.getMultimediaTypeString(e):""}getMultimediaTypeString(e){const t=e.mediaInfos[0].type,{popupState:i}=this,{_messages:a}=i;return t===D.P.IMAGE?a.image:t===D.P.BAR_CHART||t===D.P.COLUMN_CHART?a.barChart:t===D.P.LINE_CHART?a.lineChart:t===D.P.PIE_CHART?a.pieChart:a.image}getRichTextBlockDescription(e,t){const i=e.text??"",a=document.createElement("div");a.innerHTML=i;const s=a.textContent||a.innerText||"";return`${s.substring(0,t)}${s.length>t?"...":""}`}getRelationshipDescription(e){const{popupState:t}=this,{_messages:i}=t,a=(0,N.g)(t).relationships.find(t=>t.id===e.relationshipId);return e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:a?.name||i.selectTable}getAssociationsBlockDefaultDescription(e){const{_messages:t}=this;return 1===e.associationTypes.length?this.getAssociationTypeString(e.associationTypes[0].type):`${t.multiple} (${e.associationTypes.length})`}getAssociationsBlockCustomDescription(e){return`${e.substring(0,25)}${e.length>25?"...":""}`}getAssociationTypeString(e){const{_messages:t}=this;switch(e){case"attachment":return t.associations.attachment;case"connectivity":return t.associations.connectivity;case"container":return t.associations.container;case"content":return t.associations.content;case"structure":return t.associations.structure}}async updateTileLayerBackingFeatureLayer(e){const t=this.layer,i=t.url;if(t.url=e,(0,T.r)(this.layer)){this.hasBackingFeatureLayerError=!1,this.layer.popupEnabled=!0;const i=new c.default({url:e});await i.load(),this.backingFeatureLayer=i,this.popupTemplate=i.popupTemplate?i.popupTemplate.clone():i.createPopupTemplate(),await t.reload(),t.popupTemplate=this.popupTemplate.clone(),this.backingFeatureLayer.popupTemplate=this.popupTemplate.clone(),await this.showPreviewPopup(!1),await this.setUpState(),await this.setUpDisplay(),this.arcgisHasBackingFeatureLayer.emit(!0),setTimeout(()=>this.activeCalciteFabNode?.setFocus(),300)}else this.hasBackingFeatureLayerError=!0,t.url=i,this.requestUpdate(),this.backingFeatureLayerCardNode.value?setTimeout(()=>this.backingFeatureLayerCardNode.value?.setFocus(),300):setTimeout(()=>this.browseFeatureLayersNode?.setFocus(),300)}render(){return this._propWatcherTask.render({complete:()=>{const{_messages:e,layer:t,hasError:i,serviceType:a,calciteFlowProps:o,hideLayerTitle:r,dismissible:n}=this;return this.el.classList.add("calcite-match-height"),i?o?s.qy`<div ${(0,R.K)(this.divRefHandler)}>${this.renderPopupErrorMessage()}${a!==P.s.wms&&this.renderAddContentFab()||""}</div>`:s.qy`<calcite-flow ${(0,R.K)(this.internalFlowRefHandler)}><calcite-flow-item .heading=${e.popupHeading} .closable=${n} .description=${r?void 0:t?.title??void 0} @calciteFlowItemClose=${e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()}} ${(0,R.K)(this.wrappingFlowItemRefHandler)}>${this.renderPopupErrorMessage()}${a!==P.s.wms&&this.renderAddContentFab()||""}</calcite-flow-item></calcite-flow>`:(o?.calciteFlow&&o.calciteFlow.customItemSelectors,o&&(this.wrappingFlowItemNode=o.calciteFlowItem),o?s.qy`${this.renderBackingFeatureLayerContent()}${a===P.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent()}`:s.qy`<calcite-flow .customItemSelectors=${"arcgis-map-config-popup-expressions"} ${(0,R.K)(this.internalFlowRefHandler)}><calcite-flow-item .heading=${e.popupHeading} .closable=${n} .description=${r?void 0:t?.title??void 0} @calciteFlowItemBack=${e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()}} @calciteFlowItemClose=${e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()}} ${(0,R.K)(this.wrappingFlowItemRefHandler)}>${this.renderBackButton()}${this.renderBackingFeatureLayerContent()}${a===P.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent()}${a!==P.s.wms&&this.renderAddContentFab()||""}</calcite-flow-item></calcite-flow>`)}})}renderPopupErrorMessage(){const{_messages:e,layer:t,portal:i,hadBackingFeatureLayer:a}=this,o=window.customElements?.get("arcgis-item-browser"),r=(0,T.p)(t),n=i.user;return o&&n&&r?s.qy`${this.renderBackingFeatureLayerInvalidConfigurationNotice()}<div class="error-message-wrapper"><calcite-label>${a?e.newBackingFeatureLayer:e.incompatibleLayer}</calcite-label>${!a&&s.qy`<calcite-label>${e.incompatibleLayerDescription}</calcite-label>`||""}<calcite-button width=full appearance=outline-fill kind=brand icon-start=search @click=${()=>{this.browseFeatureLayersNode.disabled=!0,this.openItemBrowser()}} ${(0,R.K)(this.buttonRefHandler)}>${e.browseForFeatureLayers}</calcite-button></div>`:s.qy`<div class="error-notice"><calcite-notice open icon=exclamation-mark-triangle scale=s><div slot=message> ${e.popupTileError}</div></calcite-notice></div>`}renderBackButton(){const{_messages:e,backButton:t}=this;return t?s.qy`<calcite-action .text=${e.back} scale=s slot=header-actions-start @click=${e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()}}><calcite-icon scale=s .icon=${"rtl"===this._direction?"chevron-right":"chevron-left"}></calcite-icon></calcite-action>`:""}renderBackingFeatureLayerContent(){const{popupState:e}=this,{backingFeatureLayer:t}=e;return t?s.qy`${this.renderBackingFeatureLayerScrim()}${this.renderBackingFeatureLayerInvalidConfigurationNotice()}${this.renderBackingFeatureLayerCard()}`:""}renderBackingFeatureLayerScrim(){const{backingFeatureLayerPendingAction:e}=this;return e?s.qy`<arcgis-map-config-popup-backing-feature-layer-scrim .action=${e} @arcgisSelect=${async e=>{const t=e.detail;if(this.backingFeatureLayerPendingAction=void 0,"cancel"===t)return this.requestUpdate(),void setTimeout(()=>this.backingFeatureLayerCardNode.value?.setFocus(),300);if("change"===t)this.openItemBrowser();else{this.backingFeatureLayer=void 0,this.popupComponents=[],this.hadBackingFeatureLayer=!0,this.hasBackingFeatureLayerError=!1;const{layer:e}=this;e.url=`${e.parent.url}/${e.id}`,this.popupTemplate=e.createPopupTemplate()??void 0,e.popupTemplate=this.popupTemplate?.clone(),e.popupEnabled=!1,await this.showPreviewPopup(!1),await this.setUpState(),this.requestUpdate(),this.arcgisHasBackingFeatureLayer.emit(!1),setTimeout(()=>this.browseFeatureLayersNode?.setFocus(),300)}}} ${(0,R.K)(this.backingFeatureLayerScrimRefHandler)}></arcgis-map-config-popup-backing-feature-layer-scrim>`:""}renderBackingFeatureLayerInvalidConfigurationNotice(){const{_messages:e,hasBackingFeatureLayerError:t}=this;return t?s.qy`<div class="error-notice"><calcite-notice scale=s open closable icon=exclamation-mark-triangle kind=danger width=full @calciteNoticeClose=${()=>{this.hasBackingFeatureLayerError=!1,this.requestUpdate()}}><div slot=title>${e.layerError}</div><div slot=message>${e.backingFeatureLayerError}</div></calcite-notice></div>`:""}renderBackingFeatureLayerCard(){return s.qy`<arcgis-map-config-popup-backing-feature-layer-card @arcgisSelect=${e=>{const t=e.detail;this.backingFeatureLayerPendingAction=t,this.requestUpdate(),setTimeout(()=>this.backingFeatureLayerScrimNode?.setFocus(),300)}} ${(0,R.K)(this.backingFeatureLayerCardNode)}></arcgis-map-config-popup-backing-feature-layer-card>`}renderEnablePopupSwitch(){const{_messages:e,popupState:t,layerDisplayType:i,serviceType:a,mapNotesPopupEnabled:o}=this,r=(0,E.i)(t,i,a,o);return s.qy`<calcite-label class="enable-popup-switch" alignment=start layout=inline-space-between>${e.enablePopup}<calcite-switch .checked=${r} @calciteSwitchChange=${e=>{const t=e.target.checked;switch(i){case P.l.feature:this.layer&&(this.layer.popupEnabled=t);break;case P.l.cluster:this.layer.featureReduction.popupEnabled=t;break;case P.l.mapNotes:this.mapNotesPopupEnabled=t;break;default:this.layer&&(this.layer.popupEnabled=t)}this.backingFeatureLayer&&this.layer&&(this.backingFeatureLayer.popupEnabled=this.layer.popupEnabled),this.showPopupContentInPanel(t),this.handlePopupUpdate(!0),i!==P.l.mapNotes&&t&&!this.layer.popupTemplate&&(this.layer.popupTemplate=this.popupTemplate,this.backingFeatureLayer&&(this.backingFeatureLayer.popupTemplate=this.popupTemplate)),this.showPreviewPopup(t)}} ${(0,R.K)(this.enablePopupsSwitchNode)}></calcite-switch></calcite-label>`}renderAllPopupContent(){const{popupState:e,_messages:t,layerHasEditInfo:i,layerDisplayType:a,serviceType:o,mapNotesPopupEnabled:r}=this,n=(0,E.i)(e,a,o,r);return s.qy`${this.renderEnablePopupSwitch()}<div .hidden=${!n} ${(0,R.K)(this.popupContentWrapperNode)}>${this.renderPopupOptions()}${this.renderPopupTitle()}<calcite-block-group drag-enabled .label=${t.popupHeading} @calciteBlockGroupOrderChange=${e=>{const t=e.detail.oldIndex,i=e.detail.newIndex,a=this.popupTemplate.content.splice(t,1)[0];this.popupTemplate.content.splice(i,0,a),this.popupComponents=[...this.blockGroupNode.value.children],this.handlePopupUpdate()}} ${(0,R.K)(this.blockGroupNode)}>${this.popupComponents}</calcite-block-group>${i&&this.popupTemplate.lastEditInfoEnabled?s.qy`<div class="edit-info-summary" ${(0,R.K)(this.editInfoDivNode)}>${this.renderEditInfoSummary()}</div>`:null}</div>`}renderPopupOptions(){const{_messages:e,layerSupportsArcade:t,showConfigureFields:i,serviceType:a}=this,o=a===P.s.imagery;return o||t||i?s.qy`<calcite-block .heading=${e.options} expanded collapsible>${o&&this.renderImageryOptions()||""}${t&&this.renderManageExpressionsButton()||""}${i&&this.renderConfigureFieldsButton()||""}</calcite-block>`:""}renderImageryOptions(){const{layer:e}=this,t=!!e.capabilities?.operations?.supportsQuery&&e.fields?.length,i=e.hasMultidimensions,a=(0,T.u)(e)>=10.8&&(t||i);return s.qy`<div class="imagery-options">${this.renderIgnoreNoData()}${a&&this.renderDisplayTopmostRaster()||""}</div>`}renderIgnoreNoData(){const{_messages:e}=this;return s.qy`<calcite-label alignment=start layout=inline-space-between>${e.ignoreNoData}<calcite-switch .checked=${!this.popupTemplate?.layerOptions?.showNoDataRecords} @calciteSwitchChange=${e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.showNoDataRecords=!t,this.handlePopupUpdate()}}></calcite-switch></calcite-label>`}renderDisplayTopmostRaster(){const{_messages:e}=this;return s.qy`<calcite-label alignment=start layout=inline-space-between>${e.displayTopmost}<calcite-switch .checked=${this.popupTemplate?.layerOptions?.returnTopmostRaster??!0} @calciteSwitchChange=${e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.returnTopmostRaster=t,this.handlePopupUpdate()}}></calcite-switch></calcite-label>`}renderManageExpressionsButton(){const{_messages:e}=this;return s.qy`<calcite-button alignment=icon-end-space-between appearance=transparent kind=neutral .iconEnd=${"rtl"===this._direction?"chevron-left":"chevron-right"} .label=${e.manageExpressions} width=full @click=${e=>{e.stopPropagation(),this.handleManageExpressionsClick()}}>${e.manageExpressions}</calcite-button>`}renderConfigureFieldsButton(){const{_messages:e,layer:t}=this;return t?s.qy`<calcite-button alignment=icon-end-space-between appearance=transparent kind=neutral .iconEnd=${"rtl"===this._direction?"chevron-left":"chevron-right"} .label=${e.configureFields} width=full @click=${t=>{const{popupState:i}=this;t.stopPropagation(),this.closePopupPopovers.emit();const a=(0,H.dN)(s.qy`<calcite-flow-item .heading=${e.attributes} .description=${(0,N.g)(i).title} selected @calciteFlowItemBack=${async()=>{await(this.fieldsNode?.done()),a.remove(),this.fieldsNode=void 0,this.wrappingFlowItemNode.selected=!0}}></calcite-flow-item>`);this.wrappingFlowItemNode.selected=!1,this.fieldsNode=(0,H.dN)(s.qy`<arcgis-map-config-fields .mapView=${this.mapView} .layer=${this.layer} .config=${this.config} .layerDisplayType=${this.layerDisplayType} calcite-flow-props hide-popup @arcgisChange=${async e=>{e.stopPropagation(),this.popupTemplate=this.layer.popupTemplate.clone(),this.popupState.popupTemplate=this.popupTemplate,this.popupComponents=[],this.popupTemplate.content.forEach(e=>this.addNewPopupContentToExistingPopupContent(e));const t=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-attributes"));await Promise.all(t.map(async e=>await e.syncWithFieldsList())),this.requestUpdate(),this.handlePopupUpdate()}}></arcgis-map-config-fields>`),a.appendChild(this.fieldsNode),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(a):this.internalFlowNode?.appendChild(a),a.setFocus()}}>${e.configureFields}</calcite-button>`:""}renderPopupTitle(){return s.qy`<arcgis-map-config-popup-title .referenceElement=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${e=>{e.stopPropagation(),this.handlePopupUpdate()}}></arcgis-map-config-popup-title>`}renderPopupAttributes(e,t){const{_messages:i,popupTemplate:a}=this;return s.qy`<calcite-block .heading=${i.fieldsList} .expanded=${t} collapsible .description=${e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${a.fieldInfos.length} ${i.attributes_L}`}><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=feature-details></calcite-icon></div><arcgis-map-config-popup-attributes .fieldsContent=${e} .popupFlowItem=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const{popupState:a}=this,{popupTemplate:s}=a,o=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${s.fieldInfos.length} ${i.attributes_L}`;t.target.parentElement.description=o,this.handlePopupUpdate()}}></arcgis-map-config-popup-attributes></calcite-block>`}renderPopupAttachments(e,t){const{_messages:i,popupState:a}=this,o=(0,N.g)(a),r=(0,T.i)(o.capabilities?.attachment?.supportsResize)?o.capabilities.attachment.supportsResize:!!o?.capabilities?.operations?.supportsResizeAttachments,n=!!o?.sourceJSON?.advancedQueryCapabilities?.supportsQueryAttachmentOrderByFields,p=!!o?.sourceJSON?.advancedQueryCapabilities?.supportsQueryAttachmentWithTypeWildcard;return s.qy`<calcite-block .expanded=${t} .heading=${i.attachments} .description=${e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e)} collapsible><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0}} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent} @arcgisDelete=${this.handleDeleteIndividualPopupContent}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=attachment></calcite-icon></div><arcgis-map-config-popup-attachments .attachmentsContent=${e} .layerSupportsResizeAttachments=${r} .layerSupportsOrderingAttachments=${n} .layerSupportsFilteringAttachments=${p} .popupFlowItem=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const i=e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-attachments></calcite-block>`}renderPopupMultimedia(e,t){const{_messages:i}=this;return s.qy`<calcite-block .expanded=${t} .heading=${e.mediaInfos.length>1?i.mediaGroup:i.media} .description=${e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e)} collapsible><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=images></calcite-icon></div><arcgis-map-config-popup-multimedia .blockOpen=${t} .mediaContent=${e} .popupFlowItem=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisChange=${t=>{t.stopPropagation();const i=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-multimedia></calcite-block>`}renderPopupText(e,t){const{_messages:i}=this,a=this.popupTemplate.toJSON().fieldInfos?.map(({fieldName:e,label:t})=>({name:e,alias:t||e}));this.fieldsOnlyData=a||[];const o=this.popupTemplate?.toJSON().expressionInfos?.map(({expression:e,name:t,returnType:i,title:a})=>({name:`expression/${t}`,alias:"New expression"===a?" ":a,type:i,description:e}));return o?.length&&(this.fieldsOnlyData=this.fieldsOnlyData.filter(e=>!o.some(t=>t.name===e.name))),this.fieldsAndExpressionsData=o?[...o,...this.fieldsOnlyData]:this.fieldsOnlyData,s.qy`<calcite-block .heading=${i.text} .expanded=${t} collapsible .description=${this.getRichTextBlockDescription(e,25)}><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=text></calcite-icon></div><arcgis-map-config-popup-richtext .blockOpen=${t} .fieldExpressionData=${{data:this.fieldsAndExpressionsData,placeholderText:i.searchFields,heading:i.selectField,label:i.fieldsListPluginName}} .arcgisColorPickerData=${{data:this.fieldsAndExpressionsData,filterPlaceholder:i.searchAttributes,label:i.colorPicker,doneText:i.done,customText:i.customText,attributeText:i.attributeText}} .popupTextContent=${e} .popupFlowItem=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const i=this.getRichTextBlockDescription(e,25);t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-richtext></calcite-block>`}renderPopupArcade(e,t){const{_messages:i}=this;return s.qy`<calcite-block .heading=${i.arcade} .description=${e.expressionInfo.title??void 0} collapsible .expanded=${t}><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0,disableDuplicate:this.popupState.blockFeatureReductionArcade}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent} ${(0,R.K)(this.arcadeBlockOptionsRefHandler)}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=code></calcite-icon></div><arcgis-map-config-popup-arcade .expressionContent=${e} .blockOpen=${t} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const i=e.expressionInfo.title??"";t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-arcade></calcite-block>`}renderPopupRelationship(e,t){const{_messages:i}=this,a=this.getRelationshipDescription(e);return s.qy`<calcite-block .heading=${i.relatedRecords} .expanded=${t} collapsible .description=${a}><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!0,disableDuplicate:!this.popupState.layerHasRelatedRecords}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent} ${(0,R.K)(this.relatedRecordsBlockOptionsRefHandler)}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon .icon=${this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle"} ${(0,R.K)(this.iconRefHandler)}></calcite-icon></div><arcgis-map-config-popup-relationship .relationshipContent=${e} .popupFlowItem=${this.wrappingFlowItemNode} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const i=this.getRelationshipDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-relationship></calcite-block>`}renderPopupAssociations(e,t){const{_messages:i}=this;return s.qy`<calcite-block .disabled=${!this.popupState.layerIsUNLayer} .heading=${i.associations.associations} .description=${e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e)} collapsible .expanded=${this.popupState.layerIsUNLayer&&t} ${(0,R.K)(this.associationsBlockRefHandler)}><div slot=control><arcgis-map-config-block-options .options=${{hasDelete:!0,hasDuplicate:!1}} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @arcgisDuplicate=${this.handleDuplicateIndividualPopupContent}></arcgis-map-config-block-options></div><div slot=icon><calcite-icon icon=view-associations></calcite-icon></div><arcgis-map-config-popup-associations .associationsContent=${e} .referenceElement=${this.wrappingFlowItemNode} .blockOpen=${t} @arcgisDelete=${this.handleDeleteIndividualPopupContent} @disablePopupPanel=${e=>{const t=e.detail;this.handleDisablePopupPanel(t)}} @arcgisChange=${t=>{t.stopPropagation();const i=e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}></arcgis-map-config-popup-associations></calcite-block>`}renderEditInfoSummary(){const{_messages:e}=this;return s.qy`<calcite-icon class="edit-info-icon" icon=user></calcite-icon><div class="edit-info-text">${e.editInfoSummaryHeading}</div><calcite-action .text=${e.remove} appearance=transparent icon=x @click=${e=>{e.stopPropagation(),this.closePopupPopovers.emit(),this.popupTemplate.lastEditInfoEnabled=!1,this.handlePopupUpdate(),this.requestUpdate(),this.activeCalciteFabNode?.setFocus()}}></calcite-action>`}renderAddContentFab(){const{popupState:e,hasError:t,_messages:i,layerDisplayType:a,serviceType:o,mapNotesPopupEnabled:r}=this,n=!t&&(0,E.i)(e,a,o,r);return s.qy`<calcite-fab .hidden=${!n} icon=plus slot=fab scale=s appearance=outline-fill kind=neutral .label=${i.addContent} .text=${i.addContent} text-enabled @click=${async e=>{e.stopPropagation(),await this.handleFabClick()}} ${(0,R.K)(this.internalCalciteFabNode)}></calcite-fab>`}}(0,a.c)("arcgis-map-config-popup",M)},10763:(e,t,i)=>{i.d(t,{c:()=>o,u:()=>r});var a=i(83552),s=i(20936);function o(e){e.mapView=void 0,e.portal=void 0,e.config=void 0,e.layerDisplayType=void 0,e.serviceType=void 0,e.layerHasAttributes=!0,e.layerSupportsAttachments=!1,e.layerHasCharts=!0,e.layerHasImages=!0,e.layerHasText=!0,e.layerSupportsArcade=!1,e.layerHasRelatedRecords=!1,e.layerIsUNLayer=!1,e.layerHasEditInfo=!1,e.blockFeatureReductionArcade=!1,e.allowTimeSeriesConfiguration=!1}function r(){const e=(0,a.Gk)(),t=e;e.manager.onLoad(()=>{t.popupState=function(e,t){const i=n.get(e);if(i)return i;const a=(0,s.el)(e,t);return a&&"store"in a?(n.set(e,a.store),a.store):null}(e.el,"arcgis-map-config-popup")})}const n=new WeakMap},36486:(e,t,i)=>{i.d(t,{u:()=>o});var a=i(83552),s=i(73679);const o=(0,a.yr)(s.g)},39258:(e,t,i)=>{i.d(t,{a:()=>d,c:()=>p,g:()=>r,l:()=>n,r:()=>c});var a=i(42855),s=i(66228),o=i(34883);function r(e){let t=[...e.map?.allLayers?.toArray()||[],...e.map?.allTables?.toArray()||[]];return t.forEach(e=>{if("map-image"===e.type||"subtype-group"===e.type){const i=e;t=t.concat([...i.sublayers])}}),t}async function n(e,t,i){const s=e.capabilities?.queryRelated?.supportsCount,o=e.capabilities?.queryRelated?.supportsPagination;if([a.s.feature,a.s.scene,a.s.mapImage,a.s.subtype].includes(i)&&e?.relationships?.length&&s&&o)for(const i of e.relationships){const a=r(t);for(const t of a){const a=t;if(await l(e,a,i))return await a.load(),await Promise.resolve(!0)}}return await Promise.resolve(!1)}async function p(e,t){const{mapView:i}=e,a=(0,o.g)(e);if(!a)return await Promise.resolve(!1);for(const e of a.relationships)if(e.id===t.relationshipId){const t=r(i);for(const i of t){const t=i;if(await l(a,t,e))return await t.load(),await Promise.resolve(!0)}return await Promise.resolve(!1)}return await Promise.resolve(!1)}async function l(e,t,i){const a=t.url?t.url===e.url||u(t)===u(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id;["feature","scene"].includes(t.type)&&a&&"layerId"in t&&!(0,s.i)(t.layerId)&&await t.load();const o="sublayer"===t.type||"subtype-sublayer"===t.type;return await Promise.resolve(["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&a&&(!o&&t.layerId===i.relatedTableId||o&&t.id===i.relatedTableId))}function c(e,t,i){const a=t.url?t.url===e.url||u(t)===u(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id,s="sublayer"===t.type||"subtype-sublayer"===t.type;return["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&a&&(!s&&t.layerId===i.relatedTableId||s&&t.id===i.relatedTableId)}async function d(e,t,i){if([a.s.feature,a.s.scene,a.s.mapImage,a.s.subtype].includes(i)&&e?.relationships?.length)for(const i of e.relationships){const a=r(t);for(const t of a){const a=t;if(await l(e,a,i))return await a.load(),{relationship:i,currLayer:a}}}}function u(e){return["feature","subtype-sublayer"].indexOf(e.type)&&e.url.toLocaleLowerCase().endsWith("/featureserver")?e.url.substring(0,e.url.length-14):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().endsWith("/mapserver")?e.url.substring(0,e.url.length-10):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().includes("/mapserver/")?e.url.substring(0,e.url.toLocaleLowerCase().indexOf("/mapserver/")):"scene"===e.type&&e.url.toLocaleLowerCase().endsWith("/sceneserver")?e.url.substring(0,e.url.length-12):e.url}},47640:(e,t,i)=>{i.d(t,{YZ:()=>r,e1:()=>s});var a=i(4836);const s={INITIAL:0,PENDING:1,COMPLETE:2,ERROR:3},o=Symbol();class r{get taskComplete(){return this.t||(1===this.i?this.t=new Promise((e,t)=>{this.o=e,this.h=t}):3===this.i?this.t=Promise.reject(this.l):this.t=Promise.resolve(this.u)),this.t}constructor(e,t,i){this.p=0,this.i=0,(this._=e).addController(this);const a="object"==typeof t?t:{task:t,args:i};this.v=a.task,this.j=a.args,this.m=a.argsEqual??n,this.k=a.onComplete,this.A=a.onError,this.autoRun=a.autoRun??!0,"initialValue"in a&&(this.u=a.initialValue,this.i=2,this.O=this.T?.())}hostUpdate(){!0===this.autoRun&&this.S()}hostUpdated(){"afterUpdate"===this.autoRun&&this.S()}T(){if(void 0===this.j)return;const e=this.j();if(!Array.isArray(e))throw Error("The args function must return an array");return e}async S(){const e=this.T(),t=this.O;this.O=e,e===t||void 0===e||void 0!==t&&this.m(t,e)||await this.run(e)}async run(e){let t,i;e??=this.T(),this.O=e,1===this.i?this.q?.abort():(this.t=void 0,this.o=void 0,this.h=void 0),this.i=1,"afterUpdate"===this.autoRun?queueMicrotask(()=>this._.requestUpdate()):this._.requestUpdate();const a=++this.p;this.q=new AbortController;let s=!1;try{t=await this.v(e,{signal:this.q.signal})}catch(e){s=!0,i=e}if(this.p===a){if(t===o)this.i=0;else{if(!1===s){try{this.k?.(t)}catch{}this.i=2,this.o?.(t)}else{try{this.A?.(i)}catch{}this.i=3,this.h?.(i)}this.u=t,this.l=i}this._.requestUpdate()}}abort(e){1===this.i&&this.q?.abort(e)}get value(){return this.u}get error(){return this.l}get status(){return this.i}render(e){switch(this.i){case 0:return e.initial?.();case 1:return e.pending?.();case 2:return e.complete?.(this.value);case 3:return e.error?.(this.error);default:throw Error("Unexpected status: "+this.i)}}}const n=(e,t)=>e===t||e.length===t.length&&e.every((e,i)=>!(0,a.Ec)(e,t[i]))},58611:(e,t,i)=>{i.d(t,{_i:()=>l,y$:()=>y});i(4713);var a=i(54312),s=i(44319),o=i(93461),r=i(53987),n=i(84577),p=i(60331);const l=(e,t)=>t=>d(t,e);class c extends s.G{constructor(e,t){super(e),this.Y=new Map,this.A=void 0,this.#e=(0,r.createObservable)();const i=this;i.#t=t,i.Z(),i.setProvisionalExports(u(e,new WeakRef(i),e.M.length-1,i.instance,i.Y),!1),(0,s.d)(e,t=>{if(t){const s=(0,a.watch)(()=>e[t],t=>{if(t===i.instance)return;const a=i.instance;i.exports=t,i.instance=t,i.Y.forEach((t,i)=>e.requestUpdate(t,a[i])),i.#i&&a.destroy(),i.#i=!1},{sync:!0});i.onDestroy(s.remove)}},i.exports)}#i;#e;#t;get exports(){return(0,r.trackAccess)(this.#e),super.exports}set exports(e){super.exports=e,this.#e.notify()}Z(){const e=this;e.instance="prototype"in e.#t&&"declaredClass"in e.#t.prototype?new e.#t:e.#t(),e.#i=!0}hostConnected(){this.exports=this.instance}hostDestroy(){this.#i&&this.instance.destroy?.()}}const d=(0,o.p)(c),u=(e,t,i,a,o)=>new Proxy(a,{get:(a,r)=>{const n=a[r];if("symbol"==typeof r||o.has(r))return n;const p=e.M[i];return p.A=r,(0,s.t)(e,a=>{if(p.A=void 0,void 0!==a){const s=a.key;o.set(r,s);const n=e.constructor.getPropertyOptions(s);0;const p=r!==s&&s.toLowerCase().includes("disable");h(t,n,r,s,p),void 0===n.i&&m(n,i,r,p)}},n)}}),h=(e,t,i,s,o,r)=>r=(0,a.watch)(()=>{const t=e.deref();return void 0===t||t.component.manager.destroyed?r=r.remove():t.exports[i]},(i,a)=>{if(!r)return;const n=e.deref().component;n?.requestUpdate(s,o?!a:a),t.c=!1},{sync:!0}),m=(e,t,i,a)=>{e.d.get=function(){const e=this.M[t]?.exports[i];return a?!e:e},e.d.set=function(e){const s=this.M[t];s.A!==i&&(s.exports[i]=a?!e:e)}},y=e=>{const t=class extends p.default{},i="function"==typeof e?e():e,a=Object.getOwnPropertyDescriptors(i);for(const[e,i]of Object.entries(a))Object.defineProperty(t.prototype,e,i),(0,n.property)()(t.prototype,e);return new((0,n.subclass)()(t))}},72978:(e,t,i)=>{i.d(t,{g:()=>o,i:()=>s});var a=i(34883);function s(e){const{mapView:t,portal:i}=e,{map:s}=t,{portalHostname:r}=i,n=(0,a.g)(e);if(!s)return!1;const{utilityNetworks:p}=s;if(!p)return!1;const l=i.isPortal,c="1"===window.localStorage.getItem("utility-networks-agol")&&("devext.arcgis.com"===r||"qaext.arcgis.com"===r);if(!l&&!c)return!1;const d=o(n),u=p.find(e=>e.sourceJSON?.serviceItemId===d);return!!u&&u.isUtilityLayer(n)}function o(e){return"subtype-sublayer"===e.type?e.parent.serviceItemId:e.serviceItemId}},83926:(e,t,i)=>{i.d(t,{p:()=>n});var a=i(54312),s=i(6756),o=i(42855),r=i(66228);const n=async(e,t,i)=>{e.closePopup();const a=(0,r.a)(t);if(a!==o.s.parquet&&a!==o.s.voxel){if(a!==o.s.scene||t?.associatedLayer){const s=await p(e,t,i,a);return s?(await e.openPopup({features:[s],location:s.geometry?.extent?.center??s.geometry}),e.popup&&"dockEnabled"in e.popup&&(e.popup.dockEnabled=!0),await Promise.resolve(s)):void await Promise.resolve(void 0)}await Promise.resolve(void 0)}else await Promise.resolve(void 0)},p=async(e,t,i,s)=>{try{let n,p;if(s===o.s.ogcFeature||s===o.s.stream?(n=await e.whenLayerView(t),await a.whenOnce(()=>!n.updating)):n=t,s===o.s.imageryTile||s===o.s.wcs)return(await e.allLayerViews.find(e=>e.layer.id===t.id).fetchPopupFeaturesAtLocation(t.fullExtent?.center))?.[0];if(s===o.s.mapImage&&t.layer.version>=10.5&&!t.layer.capabilities?.operations?.supportsQuery&&t.layer.capabilities?.operations?.supportsIdentify){const i=await(0,r.b)(t,e);return i&&(i.sourceLayer=t),Promise.resolve(i)}const d="isTable"in t&&t.isTable,u=n.createQuery();d||(u.geometry=e.center,u.distance=e.resolution),u.outFields=["*"];const h=await n.queryFeatures(u,{signal:i.signal});if(0===h?.features?.length){const a=n.createQuery();a.geometry=e.extent,a.outFields=["*"],"knowledge-graph-sublayer"===t.type&&(a.returnGeometry=!0);const r=await n.queryFeatures(a,{signal:i.signal});if(r?.features?.length>0)p=await c(r,e,t);else{const a=n.createQuery();a.where=n.definitionExpression||"1=1",a.outFields=["*"],(t.sourceJSON?.advancedQueryCapabilities?.supportsPagination||s===o.s.ogcFeature)&&(a.start=0,a.num=1),a.outSpatialReference=e.spatialReference,p=(await n.queryFeatures(a,{signal:i.signal}))?.features?.[0]}}else p=h?.features?.[0];return p&&s===o.s.imagery&&(p=await l(t,p)),Promise.resolve(p)}catch(e){return console.log(e),void await Promise.resolve(void 0)}},l=async(e,t)=>{const i=e.createQuery();return i.outFields=["*"].concat(e.rasterFields.map(e=>e.name).filter(e=>e.startsWith("Raster."))),i.geometry=t.geometry,i.outSpatialReference=t.geometry.spatialReference,(await e.queryVisibleRasters(i,{returnTopmostRaster:!0,returnDomainValues:!0}))?.[0]??t},c=async(e,t,i)=>{const a=await(0,r.c)(i);if("point"===a){let i=[void 0,void 0];for(let a=0;a<e.features.length;a++){const s=e.features[a].geometry.distance(t.center);(0===a||(0,r.i)(i?.[1]&&i[1]>s))&&(i=[e.features[a],s])}return i[0]}if("polyline"===a){let i=[void 0,void 0];for(let a=0;a<e.features.length;a++){const o=s.getNearestVertex(e.features[a].geometry,t.center).distance;(0===a||(0,r.i)(i?.[1]&&i[1]>o))&&(i=[e.features[a],o])}return i[0]}if("polygon"===a||"imagery"===(0,r.a)(i)){let i=[void 0,void 0];for(let a=0;a<e.features.length;a++){const s=e.features[a].geometry.centroid.distance(t.center);(0===a||(0,r.i)(i?.[1]&&i[1]>s))&&(i=[e.features[a],s])}return i[0]}return e.features[0]}},98295:(e,t,i)=>{i.d(t,{A:()=>s,C:()=>a,I:()=>r,P:()=>o});var a=(e=>(e.ATTRIBUTES="attributes",e.ATTACHMENTS="attachments",e.CHARTS="charts",e.IMAGES="images",e.RICH_TEXT="richText",e.ARCADE="arcade",e.RELATIONSHIP="relationship",e.ASSOCIATIONS="associations",e.EDIT_INFO_SUMMARY="editInfoSummary",e))(a||{}),s=(e=>(e.PREVIEW="preview",e.LIST="list",e.AUTO="auto",e))(s||{}),o=(e=>(e.IMAGE="image",e.BAR_CHART="bar-chart",e.COLUMN_CHART="column-chart",e.LINE_CHART="line-chart",e.PIE_CHART="pie-chart",e))(o||{}),r=(e=>(e.SOURCE_URL="sourceUrl",e.TITLE="title",e.CAPTION="caption",e.LINK_URL="linkUrl",e.ALT_TEXT="altText",e))(r||{})}}]);