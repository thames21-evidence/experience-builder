"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_common_feature-report_node_modules_arcgis-survey123_feature-report-d3c1a4"],{491:(e,t,r)=>{r.r(t),r.d(t,{feature_report:()=>E});var s,i=r(826),n=r(938),o=r(5),a=r(291),h=r(129);!function(e){e.TOKEN_REFRESH_FAILED="TOKEN_REFRESH_FAILED",e.GENERATE_TOKEN_FOR_SERVER_FAILED="GENERATE_TOKEN_FOR_SERVER_FAILED",e.REFRESH_TOKEN_EXCHANGE_FAILED="REFRESH_TOKEN_EXCHANGE_FAILED",e.NOT_FEDERATED="NOT_FEDERATED",e.UNKNOWN_ERROR_CODE="UNKNOWN_ERROR_CODE"}(s||(s={}));class l extends Error{constructor(e="UNKNOWN_ERROR",t=s.UNKNOWN_ERROR_CODE,r,i,n){super(e);const o=new.target.prototype;Object.setPrototypeOf(this,o),this.name="ArcGISTokenRequestError",this.message=`${t}: ${e}`,this.originalMessage=e,this.code=t,this.response=r,this.url=i,this.options=n}}class c extends Error{constructor(){super("The user has denied your authorization request.");const e=new.target.prototype;Object.setPrototypeOf(this,e),this.name="ArcGISAccessDeniedError"}}function p(e){return!e||e.length<=0?{}:e.replace(/^#/,"").replace(/^\?/,"").split("&").reduce((e,t)=>{const{key:r,value:s}=function(e){const[t,r]=e.split("=");return{key:decodeURIComponent(t),value:decodeURIComponent(r)}}(t);return e[r]=s,e},{})}const d=3e5;function u(e,t){const r=t;return r.rawResponse=!1,(0,a.r)(e,r).then(e=>{if("token"in e&&"expires"in e)return{token:e.token,username:t.params.username,expires:new Date(e.expires)};const r={token:e.access_token,username:e.username,expires:new Date(Date.now()+1e3*e.expires_in-d),ssl:!0===e.ssl};return e.refresh_token&&(r.refreshToken=e.refresh_token),e.refresh_token_expires_in&&(r.refreshTokenExpires=new Date(Date.now()+1e3*e.refresh_token_expires_in-d)),r})}const m=/^https?:\/\/(\S+)\.arcgis\.com.+/;function g(e){return m.test(e)}function f(e){if(!m.test(e))return null;const t=e.match(m)[1].split(".").pop();return t.includes("dev")?"dev":t.includes("qa")?"qa":"production"}function k(e,t){const r=(0,a.c)(function(e){if(!m.test(e))return e;switch(f(e)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}(t)).replace(/https?:\/\//,""),s=(0,a.c)(e).replace(/https?:\/\//,"");return new RegExp(s,"i").test(r)}function v(e,t=window){return!t&&window&&(t=window),t.btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function w(e){!e&&window&&(e=window);return v(e.crypto.getRandomValues(new Uint8Array(32)))}class _{constructor(e){if(this.clientId=e.clientId,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this._username=e.username,this.password=e.password,this._token=e.token,this._tokenExpires=e.tokenExpires,this.portal=e.portal?(0,a.c)(e.portal):"https://www.arcgis.com/sharing/rest",this.ssl=e.ssl,this.provider=e.provider||"arcgis",this.tokenDuration=e.tokenDuration||20160,this.redirectUri=e.redirectUri,this.server=e.server,this.referer=e.referer,this.federatedServers={},this.trustedDomains=[],e.server){const t=this.getServerRootUrl(e.server);this.federatedServers[t]={token:e.token,expires:e.tokenExpires}}this._pendingTokenRequests={}}get token(){return this._token}get tokenExpires(){return this._tokenExpires}get refreshToken(){return this._refreshToken}get refreshTokenExpires(){return this._refreshTokenExpires}get username(){return this._username?this._username:this._user&&this._user.username?this._user.username:void 0}get canRefresh(){return!(!this.username||!this.password)||!!(this.clientId&&this.refreshToken&&this.redirectUri)}static beginOAuth2(e,t){!t&&window&&(t=window);const{portal:r,provider:s,clientId:i,expiration:n,redirectUri:o,popup:h,popupWindowFeatures:l,locale:p,params:d,style:u,pkce:m,state:g}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",expiration:20160,popup:!0,popupWindowFeatures:"height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes",locale:"",style:"",pkce:!0},e),f=g||w(t),k=`ARCGIS_REST_JS_AUTH_STATE_${i}`;t.localStorage.setItem(k,f);let E=`${(0,a.c)(r)}/oauth2/authorize`;const T={client_id:i,response_type:m?"code":"token",expiration:n,redirect_uri:o,state:JSON.stringify({id:f,originalUrl:t.location.href}),locale:p,style:u};let I;if("arcgis"!==s&&(E=`${(0,a.c)(r)}/oauth2/social/authorize`,T.socialLoginProviderName=s,T.autoAccountCreateForSocial=!0),m){const e=w(t),r=`ARCGIS_REST_JS_CODE_VERIFIER_${i}`;t.localStorage.setItem(r,e),I=function(e,t=window){if(!t&&window&&(t=window),e&&t.isSecureContext&&t.crypto&&t.crypto.subtle){const r=(new t.TextEncoder).encode(e);return t.crypto.subtle.digest("SHA-256",r).then(e=>v(new Uint8Array(e),t))}return Promise.resolve(null)}(e,t).then(function(t){T.code_challenge_method=t?"S256":"plain",T.code_challenge=t||e})}else I=Promise.resolve();return I.then(()=>(E=`${E}?${(0,a.e)(T)}`,d&&(E=`${E}&${(0,a.e)(d)}`),h?new Promise((e,s)=>{t.addEventListener(`arcgis-rest-js-popup-auth-${i}`,t=>{if("access_denied"===t.detail.error){const e=new c;return s(e),e}if(t.detail.errorMessage){const e=new a.a(t.detail.errorMessage,t.detail.error);return s(e),e}e(new _({clientId:i,portal:r,ssl:t.detail.ssl,token:t.detail.token,tokenExpires:t.detail.expires,username:t.detail.username,refreshToken:t.detail.refreshToken,refreshTokenExpires:t.detail.refreshTokenExpires,redirectUri:o}))},{once:!0}),t.open(E,"oauth-window",l),t.dispatchEvent(new CustomEvent("arcgis-rest-js-popup-auth-start"))}):void(t.location.href=E)))}static completeOAuth2(e,t){!t&&window&&(t=window);const{portal:r,clientId:s,popup:i,pkce:n,redirectUri:o}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",popup:!0,pkce:!0},e),h=`ARCGIS_REST_JS_AUTH_STATE_${s}`,l=t.localStorage.getItem(h),d=p(n?t.location.search.replace(/^\?/,""):t.location.hash.replace(/^#/,"")),m=d&&d.state?JSON.parse(d.state):void 0;function g(e,r,n){return t.localStorage.removeItem(h),i&&t.opener?(t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${s}`,{detail:{error:r,errorMessage:e}})),void t.close()):(n&&t.history.replaceState(t.history.state,"",n),"access_denied"===r?Promise.reject(new c):Promise.reject(new a.a(e,r)))}function f(e,n){return t.localStorage.removeItem(h),i&&t.opener?(t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${s}`,{detail:Object.assign({},e)})),void t.close()):(t.history.replaceState(t.history.state,"",n),new _({clientId:s,portal:r,ssl:e.ssl,token:e.token,tokenExpires:e.expires,username:e.username,refreshToken:e.refreshToken,refreshTokenExpires:e.refreshTokenExpires,redirectUri:o||location.href.replace(location.search,"")}))}if(!l||!m)return g("No authentication state was found, call `ArcGISIdentityManager.beginOAuth2(...)` to start the authentication process.","no-auth-state");if(m.id!==l)return g("Saved client state did not match server sent state.","mismatched-auth-state");if(d.error){const e=d.error;return g(d.error_description||"Unknown error",e,m.originalUrl)}if(n&&d.code){const e=(0,a.c)(`${r}/oauth2/token/`),i=`ARCGIS_REST_JS_CODE_VERIFIER_${s}`,n=t.localStorage.getItem(i);return t.localStorage.removeItem(i),u(e,{httpMethod:"POST",params:{client_id:s,code_verifier:n,grant_type:"authorization_code",redirect_uri:o||location.href.replace(location.search,""),code:d.code}}).then(e=>f(Object.assign(Object.assign({},e),m),m.originalUrl)).catch(e=>g(e.originalMessage,e.code,m.originalUrl))}return!n&&d.access_token?Promise.resolve(f(Object.assign({token:d.access_token,expires:new Date(Date.now()+1e3*parseInt(d.expires_in,10)),ssl:"true"===d.ssl,username:d.username},m),m.originalUrl)):g("Unknown error","oauth-error",m.originalUrl)}static fromParent(e,t){let r;return!t&&window&&(t=window),new Promise((s,i)=>{r=e=>{if(e.source===t.parent&&e.data)try{return s(_.parentMessageHandler(e))}catch(e){return i(e)}},t.addEventListener("message",r,!1),t.parent.postMessage({type:"arcgis:auth:requestCredential"},e)}).then(e=>(t.removeEventListener("message",r,!1),e))}static authorize(e,t){const{portal:r,clientId:s,expiration:i,redirectUri:n,state:o}=Object.assign({portal:"https://arcgis.com/sharing/rest",expiration:20160},e),h={client_id:s,expiration:i,response_type:"code",redirect_uri:n};o&&(h.state=o);const l=`${r}/oauth2/authorize?${(0,a.e)(h)}`;t.writeHead(301,{Location:l}),t.end()}static exchangeAuthorizationCode(e,t){const{portal:r,clientId:i,redirectUri:n}=Object.assign({portal:"https://www.arcgis.com/sharing/rest"},e);return u(`${r}/oauth2/token`,{params:{grant_type:"authorization_code",client_id:i,redirect_uri:n,code:t}}).then(e=>new _({clientId:i,portal:r,ssl:e.ssl,redirectUri:n,refreshToken:e.refreshToken,refreshTokenExpires:e.refreshTokenExpires,token:e.token,tokenExpires:e.expires,username:e.username})).catch(e=>{throw new l(e.message,s.REFRESH_TOKEN_EXCHANGE_FAILED,e.response,e.url,e.options)})}static deserialize(e){const t=JSON.parse(e);return new _({clientId:t.clientId,refreshToken:t.refreshToken,refreshTokenExpires:t.refreshTokenExpires?new Date(t.refreshTokenExpires):void 0,username:t.username,password:t.password,token:t.token,tokenExpires:t.tokenExpires?new Date(t.tokenExpires):void 0,portal:t.portal,ssl:t.ssl,tokenDuration:t.tokenDuration,redirectUri:t.redirectUri,server:t.server})}static fromCredential(e,t){const r=void 0===e.ssl||e.ssl,s=e.expires||Date.now()+72e5;return t.hasServer?new _({server:e.server,ssl:r,token:e.token,username:e.userId,tokenExpires:new Date(s)}):new _({portal:(0,a.c)(e.server.includes("sharing/rest")?e.server:e.server+"/sharing/rest"),ssl:r,token:e.token,username:e.userId,tokenExpires:new Date(s)})}static parentMessageHandler(e){if("arcgis:auth:credential"===e.data.type)return new _(e.data.credential);if("arcgis:auth:error"===e.data.type){const t=new Error(e.data.error.message);throw t.name=e.data.error.name,t}throw new Error("Unknown message type.")}static destroy(e){return function(e){const t=`${(0,a.c)(e.portal||"https://www.arcgis.com/sharing/rest")}/oauth2/revokeToken/`,r=e.token,s=e.clientId;delete e.portal,delete e.clientId,delete e.token;const i=Object.assign(Object.assign({},e),{httpMethod:"POST",params:{client_id:s,auth_token:r}});return(0,a.r)(t,i).then(e=>{if(!e.success)throw new a.A("Unable to revoke token",500,e,t,i);return e})}({clientId:e.clientId,portal:e.portal,token:e.refreshToken||e.token})}static fromToken(e){const t=new _(e);return t.getUser().then(()=>t)}static signIn(e){const t=new _(e);return t.getUser().then(()=>t)}toCredential(){return{expires:this.tokenExpires.getTime(),server:this.server||this.portal,ssl:this.ssl,token:this.token,userId:this.username}}getUser(e){if(this._pendingUserRequest)return this._pendingUserRequest;if(this._user)return Promise.resolve(this._user);{const t=`${this.portal}/community/self`,r=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:!1});return this._pendingUserRequest=(0,a.r)(t,r).then(e=>(this._user=e,this._pendingUserRequest=null,e)),this._pendingUserRequest}}getPortal(e){if(this._pendingPortalRequest)return this._pendingPortalRequest;if(this._portalInfo)return Promise.resolve(this._portalInfo);{const t=`${this.portal}/portals/self`,r=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:!1});return this._pendingPortalRequest=(0,a.r)(t,r).then(e=>(this._portalInfo=e,this._pendingPortalRequest=null,e)),this._pendingPortalRequest}}getUsername(){return this.username?Promise.resolve(this.username):this.getUser().then(e=>e.username)}getToken(e,t){return function(e,t){const r=g(e),s=g(t),i=f(e),n=f(t);return!(!r||!s||i!==n)}(this.portal,e)||new RegExp(this.portal,"i").test(e)?this.getFreshToken(t):this.getTokenForServer(e,t)}validateAppAccess(e){return this.getToken(this.portal).then(t=>function(e,t,r="https://www.arcgis.com/sharing/rest"){const s=`${r}/oauth2/validateAppAccess`,i={method:"POST",params:{f:"json",client_id:t,token:e}};return(0,a.r)(s,i)}(t,e))}toJSON(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires||void 0,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires||void 0,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,server:this.server}}serialize(){return JSON.stringify(this)}enablePostMessageAuth(e,t){!t&&window&&(t=window),this._hostHandler=this.createPostMessageHandler(e),t.addEventListener("message",this._hostHandler,!1)}disablePostMessageAuth(e){!e&&window&&(e=window),e.removeEventListener("message",this._hostHandler,!1)}refreshCredentials(e){return this._user=null,this.username&&this.password?this.refreshWithUsernameAndPassword(e):this.clientId&&this.refreshToken?this.refreshWithRefreshToken():Promise.reject(new l("Unable to refresh token. No refresh token or password present.",s.TOKEN_REFRESH_FAILED))}getServerRootUrl(e){const[t]=(0,a.c)(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/),[r,s,i]=t.match(/(https?:\/\/)(.+)/),[n,...o]=i.split("/");return`${s}${n.toLowerCase()}/${o.join("/")}`}getDomainCredentials(e){return this.trustedDomains&&this.trustedDomains.length&&this.trustedDomains.some(t=>e.startsWith(t))?"include":"same-origin"}signOut(){return _.destroy(this)}createPostMessageHandler(e){return t=>{const r=e.indexOf(t.origin)>-1,s="arcgis:auth:requestCredential"===t.data.type,i=this.tokenExpires.getTime()>Date.now();if(r&&s){let e={};if(i){e={type:"arcgis:auth:credential",credential:this.toJSON()}}else e={type:"arcgis:auth:error",error:{name:"tokenExpiredError",message:"Token was expired, and not returned to the child application"}};t.source.postMessage(e,t.origin)}}}getTokenForServer(e,t){const r=this.getServerRootUrl(e),i=this.federatedServers[r];return i&&i.expires&&i.expires.getTime()>Date.now()?Promise.resolve(i.token):(this._pendingTokenRequests[r]||(this._pendingTokenRequests[r]=this.fetchAuthorizedDomains().then(()=>(0,a.r)(`${r}/rest/info`,{credentials:this.getDomainCredentials(e)}).then(i=>{if(i.owningSystemUrl){if(k(i.owningSystemUrl,this.portal))return(0,a.r)(`${i.owningSystemUrl}/sharing/rest/info`,t);throw new l(`${e} is not federated with ${this.portal}.`,s.NOT_FEDERATED)}if(i.authInfo&&void 0!==this.federatedServers[r])return Promise.resolve({authInfo:i.authInfo});throw new l(`${e} is not federated with any portal and is not explicitly trusted.`,s.NOT_FEDERATED)}).then(e=>this.token&&this.tokenExpires.getTime()<Date.now()?this.server?this.refreshCredentials().then(()=>({token:this.token,expires:this.tokenExpires})):this.refreshCredentials().then(()=>this.generateTokenForServer(e.authInfo.tokenServicesUrl,r)):this.generateTokenForServer(e.authInfo.tokenServicesUrl,r)).then(e=>(this.federatedServers[r]=e,delete this._pendingTokenRequests[r],e.token)))),this._pendingTokenRequests[r])}generateTokenForServer(e,t){return(0,a.r)(e,{params:{token:this.token,serverUrl:t,expiration:this.tokenDuration}}).then(e=>({token:e.token,expires:new Date(e.expires-3e5)})).catch(e=>{throw new l(e.message,s.GENERATE_TOKEN_FOR_SERVER_FAILED,e.response,e.url,e.options)})}getFreshToken(e){return this.token&&!this.tokenExpires||this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()?Promise.resolve(this.token):(this._pendingTokenRequests[this.portal]||(this._pendingTokenRequests[this.portal]=this.refreshCredentials(e).then(()=>(this._pendingTokenRequests[this.portal]=null,this.token))),this._pendingTokenRequests[this.portal])}refreshWithUsernameAndPassword(e){const t={username:this.username,password:this.password,expiration:this.tokenDuration,client:"referer",referer:this.referer?this.referer:"undefined"!=typeof window&&void 0!==window.document&&window.location&&window.location.origin?window.location.origin:a.N};return(this.server?(0,a.r)(`${this.getServerRootUrl(this.server)}/rest/info`).then(r=>(0,a.r)(r.authInfo.tokenServicesUrl,Object.assign({params:t},e))):(0,a.r)(`${this.portal}/generateToken`,Object.assign({params:t},e))).then(e=>(this.updateToken(e.token,new Date(e.expires)),this)).catch(e=>{throw new l(e.message,s.TOKEN_REFRESH_FAILED,e.response,e.url,e.options)})}refreshWithRefreshToken(e){if(this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()-864e5<Date.now())return this.exchangeRefreshToken(e);const t=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e);return u(`${this.portal}/oauth2/token`,t).then(e=>this.updateToken(e.token,e.expires)).catch(e=>{throw new l(e.message,s.TOKEN_REFRESH_FAILED,e.response,e.url,e.options)})}updateToken(e,t){return this._token=e,this._tokenExpires=t,this}exchangeRefreshToken(e){const t=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e);return u(`${this.portal}/oauth2/token`,t).then(e=>(this._token=e.token,this._tokenExpires=e.expires,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this)).catch(e=>{throw new l(e.message,s.REFRESH_TOKEN_EXCHANGE_FAILED,e.response,e.url,e.options)})}fetchAuthorizedDomains(){return this.server||!this.portal?Promise.resolve(this):this.getPortal().then(e=>(e.authorizedCrossOriginDomains&&e.authorizedCrossOriginDomains.length&&(this.trustedDomains=e.authorizedCrossOriginDomains.filter(e=>!e.startsWith("http://")).map(e=>e.startsWith("https://")?e:`https://${e}`)),this))}}const E=class{constructor(e){(0,i.r)(this,e),this.userInfoGetted=(0,i.c)(this,"userInfoGetted",7),this.i18nStringUpdated=(0,i.c)(this,"i18nStringUpdated",7),this._credentialGetted=(0,i.c)(this,"_credentialGetted",7),this.stateService=h.S.getService(),this.reportService=o.R.getService(),this.token=void 0,this.portalUrl=void 0,this.apiUrl=void 0,this.featureLayerUrl=void 0,this.surveyItemId=void 0,this.templateItemId=void 0,this.queryParameters=void 0,this.mergeFiles=void 0,this.outputFormat=void 0,this.outputReportName=void 0,this.outputPackageName=void 0,this.packageFiles=void 0,this.uploadInfo=void 0,this.webmapItemId=void 0,this.mapScale=void 0,this.locale=void 0,this.utcOffset=void 0,this.show=void 0,this.hide=void 0,this.inputFeatureTemplate=void 0,this.label=void 0,this.reportTemplateIds=void 0,this.clientId=void 0,this.requestSource=void 0,this.where=void 0,this.username=void 0,this.state="generate-report",this.visibleConf=[],this.checkingList=[],this.jobs=[],this.error=void 0,this.langTasks=void 0,this.langCommon=void 0,this.langCustomPrint=void 0,this.surveyItemInfo=void 0}surveyItemIdChanged(e){n.P.setProps({surveyItemId:e}),this._updateTemplateList(!0)}queryParametersChanged(e){return n.P.setProps({queryParameters:e}),this.reportService.getFeatureCount().then(()=>{this.stateService.notifyDataChanged("update-features-preview",{value:void 0})})}mergeFilesChanged(e){n.P.setProps({mergeFiles:e})}outputFormatChanged(e){n.P.setProps({outputFormat:e}),this.outputFormat=n.P.outputFormat}localeChanged(e){this.localeChangeHandler(e),a.U.getService().setDir()}showChanged(e){n.P.setProps({show:e}),this.visibleConf=this.generateVisibleElems(),this.reportService.setHelperObj({visibleConf:this.visibleConf})}hideChanged(e){n.P.setProps({hide:e}),this.visibleConf=this.generateVisibleElems(),this.reportService.setHelperObj({visibleConf:this.visibleConf})}inputFeatureTemplateChanged(e){n.P.setProps({inputFeatureTemplate:e}),this.stateService.notifyDataChanged("update-features-preview",{value:this.inputFeatureTemplate})}labelChanged(e){return n.P.setProps({label:e}),Promise.resolve(!0).then(()=>n.T.getService().getTranslate()).then(e=>{const t=e.customPrint.recentTasks;this.langCustomPrint=e.customPrint,this.langTasks=t,this.langCommon=e.common,this.stateService.notifyDataChanged("locale-data-changed",{value:e})})}reportTemplateIdsChanged(e){n.P.setProps({reportTemplateIds:e}),this._updateTemplateList(!0)}requestSourceChanged(e){n.P.setProps({requestSource:e})}async updateTemplateList(){const e=this.el.shadowRoot.querySelector("template-chooser");e&&e.reload(!0)}componentWillLoad(){return n.P.setProps(this),this.portalUrl=n.P.portalUrl,this.outputFormat=n.P.outputFormat,Promise.resolve(!0).then(()=>n.T.getService().getTranslate()).then(e=>{const t=e.customPrint.recentTasks;if(this.langCustomPrint=e.customPrint,this.langTasks=t,this.langCommon=e.common,this.i18nStringUpdated.emit({locale:n.P.locale,i18n:this.langCommon}),!this.isOAuthCallbackpage()){if(!this.featureLayerUrl)throw this.error={html:e.customPrint.missingRequiredParamsErr.replace("${$paramName}","featureLayerUrl")},new Error("featureLayerUrl is required.");if(!this.queryParameters)throw this.error={html:e.customPrint.missingRequiredParamsErr.replace("${$paramName}","queryParameters")},new Error("queryParameters is required.")}}).then(()=>{if(this.token)return this.init(),!0;if(!this.token){if(this.isOAuthCallbackpage()){const e=`${this.portalUrl}/sharing/rest`,t=new URL(window.location.href),r=`${t.origin}${t.pathname}?portalUrl=${this.portalUrl}&isOAuthCallback=true`;return void _.completeOAuth2({portal:e,popup:!0,clientId:this.clientId,redirectUri:r})}{const e=`${this.portalUrl}/sharing/rest/oauth2/platformSelf?f=json`,t={httpMethod:"POST",headers:{"X-Esri-Auth-Client-Id":this.clientId,"X-Esri-Auth-Redirect-Uri":window.location.href},params:{f:"json"},credentials:"include"};return(0,a.r)(e,t).then(e=>(e.expires_in&&(e.expires=(new Date).valueOf()+1e3*e.expires_in-5e3,delete e.expires_in),this._credentialGetted.emit(e),this.token=e.token,n.P.setProps(this),this.init(),!0)).catch(()=>{this.state="login"})}}}).catch(e=>{console.error(e)})}init(){const e=a.U.getService();return this.stateService.subscribe("job-complete",e=>{var t;const r=this.checkingList.indexOf(e.jobId);r>=0&&(e.jobStatus!==o.E.partialSucceeded&&e.jobStatus!==o.E.succeeded||(null===(t=null==e?void 0:e.resultInfo)||void 0===t?void 0:t.resultFiles)&&(this.checkingList.splice(r,1),this.checkingList=[].concat(this.checkingList),this.reportService.downloadReport(e)))}),this.stateService.subscribe("show-error",e=>{this.error=e}),Promise.resolve(!0).then(()=>(this.uploadInfo&&this.reportService.setParamCache({uploadInfo:JSON.parse(this.uploadInfo)}),!0)).then(()=>e.getPortalInfo()).then(t=>{const r=t.user.privileges.includes("portal:user:createItem");if(this.reportService.setHelperObj({canCreateItem:r}),this.userInfoGetted.emit(t.user),this.locale)this.i18nStringUpdated.emit({locale:this.locale,i18n:this.langCommon});else{const e=n.P.getLocale({userInfo:t.user,portalInfo:t});e!==n.P.locale&&this.localeChangeHandler(e)}if(a.U.getService().setDir(),this.visibleConf=this.generateVisibleElems(),this.reportService.setHelperObj({visibleConf:this.visibleConf}),this.stateService.notifyDataChanged("portal-info-updated"),n.P.surveyItemId)return e.getSurveyItemInfo(n.P.surveyItemId)}).catch(e=>{this.reportService.setHelperObj({surveyIsInvalid:!0}),this.surveyItemInfo={},this.reportService.manageError(e,"surveyItemId")}).then(e=>(this.surveyItemInfo=e,this.reportService.setHelperObj({surveyIsInvalid:!1}),this.reportService.initParamCache(),this.reportService.getFeatureCount())).then(()=>(this.stateService.notifyDataChanged("update-features-preview",{value:void 0}),this._updateTemplateList())).catch(e=>{e.message&&!e.html&&(e.html=e.message),this.error=e})}startLogin(){const e=`${this.portalUrl}/sharing/rest`,t=new URL(window.location.href),r=`${t.origin}${t.pathname}?portalUrl=${this.portalUrl}&isOAuthCallback=true`;return _.beginOAuth2({portal:e,popup:!0,clientId:this.clientId,redirectUri:r}).then(e=>(this.token=e.token,n.P.setProps(this),this.switchState("generate-report"),this.init(),this._credentialGetted.emit(e.toCredential()),!0))}isOAuthCallbackpage(){return(new URL(window.location.href).search+"").includes("isOAuthCallback=true")}localeChangeHandler(e){return n.P.setProps({locale:e}),Promise.resolve(!0).then(()=>n.T.getService().getTranslate()).then(t=>{const r=t.customPrint.recentTasks;return this.langCustomPrint=t.customPrint,this.langTasks=r,this.langCommon=t.common,this.stateService.notifyDataChanged("locale-data-changed",{value:t}),this.i18nStringUpdated.emit({locale:e,i18n:this.langCommon}),!0})}generateVisibleElems(){var e,t;const r=["inputFeatures","selectTemplate","fileOptions","reportName","saveToAGSAccount","outputFormat","showCredits","recentReports"];let s=[];if(null===(e=this.show)||void 0===e?void 0:e.length)s=this.show.split(",");else if(null===(t=this.hide)||void 0===t?void 0:t.length){const e=this.hide.split(",");s=r.filter(t=>e.indexOf(t)<0)}else s=r;return s.indexOf("fileOptions")<0&&s.indexOf("reportName")<0&&s.indexOf("saveToAGSAccount")<0&&s.indexOf("outputFormat")<0||s.push("reportSetting"),[].concat(s)}switchState(e){this.state=e}_updateTemplateList(e){return Promise.resolve(!0).then(()=>{if(this.visibleConf.indexOf("selectTemplate")<0||e){const e=void 0===this.reportTemplateIds||null===this.reportTemplateIds?{}:{templateIds:this.reportTemplateIds};return this.reportService.getReportTemplates(this.surveyItemId,e)}}).then(e=>{if(e){this.reportService.setHelperObj({printTemplates:e}),this.stateService.notifyDataChanged("print-templates-updated",{value:e});if(!(this.reportService.getParamCache().templateItemId||n.P.templateItemId)&&e.length){const t=e[0].id;this.reportService.setParamCache({templateItemId:t})}}})}generateReportHander(e){const t=e.detail;this.jobs=t.jobs,this.checkingList=[...this.checkingList,e.detail.jobId],this.state="report-list"}render(){var e,t,r,s,o,a;return(0,i.h)(i.H,{key:"4fef7292647e747d04e8497b9d63685fc1815ae6"},(0,i.h)("calcite-panel",{key:"040aaa93c6d52bb6f6c315c7bb04d92d379de309"},(0,i.h)("div",{key:"cec12c70c8c1bdf5e4868b7280709d7670c99169",style:{display:"generate-report"===this.state&&this.token?"block":"none"}},this.visibleConf.indexOf("inputFeatures")<0?"":(0,i.h)("features-preview",{queryParameters:this.queryParameters,inputFeatureTemplate:this.inputFeatureTemplate}),this.visibleConf.indexOf("selectTemplate")<0?"":(0,i.h)("template-chooser",{surveyItemId:this.surveyItemId,selectedTemplateId:this.templateItemId,templateIds:this.reportTemplateIds}),this.visibleConf.indexOf("reportSetting")<0?"":(0,i.h)("report-settings",{visibleElems:this.visibleConf,role:"group","aria-label":null===(e=this.langCustomPrint)||void 0===e?void 0:e.resultSettingsLabel1,mergeFiles:this.mergeFiles,outputFormat:this.outputFormat,fileName:this.outputReportName}),(0,i.h)("report-generator",{key:"789507fd4e2c4df4f8cee4df83dcc0c80eb3e128",visibleConf:this.visibleConf,templateItemId:this.templateItemId,onReportCreated:e=>{this.generateReportHander(e)}}),this.visibleConf.indexOf("recentReports")<0?null:(0,i.h)("div",{class:"banner"},(0,i.h)("calcite-action",{text:null===(t=this.langTasks)||void 0===t?void 0:t.label,onClick:()=>this.switchState("report-list"),icon:"chevrons-right","text-enabled":!0},(null===(r=this.checkingList)||void 0===r?void 0:r.length)?(0,i.h)(i.F,null,(0,i.h)("div",{class:"task-num",id:"task-num"},(0,i.h)("span",null,`${this.checkingList.length||""}`)),(0,i.h)("calcite-tooltip",{label:this.langTasks.panelNumberTip,"reference-element":"task-num"},(0,i.h)("span",null,this.langTasks.panelNumberTip))):null))),this.token?(0,i.h)("task-list",{style:{display:"report-list"===this.state?"block":"none"},jobs:this.jobs,onGoBackClicked:()=>{this.state="generate-report"}}):"",this.error?(0,i.h)("calcite-alert",{slot:"alerts",open:!0,onCalciteAlertClose:()=>{this.error=null},label:this.error.html,icon:!0,kind:this.error.alertType||"danger",placement:"top",scale:"s"},(0,i.h)("div",{class:"error-message",slot:"message"},this.error.html,this.error.detail?(0,i.h)("p",{innerHTML:this.error.detail}):null)):null,"login"!==this.state||n.P.token?"":(0,i.h)("calcite-dialog",{modal:!0,"aria-labelledby":"modal-title",id:"login-modal","close-disabled":!0,"outside-close-disabled":!0,scale:"s","width-scale":"s",heading:null===(s=this.langCommon)||void 0===s?void 0:s.signIn,open:"true"},(0,i.h)("calcite-label",{style:{height:"100px"}},(0,i.h)("p",null,null===(o=this.langCommon)||void 0===o?void 0:o.signInMsg),(0,i.h)("calcite-button",{id:"reportLoginBtn",kind:"brand",onClick:()=>this.startLogin()},null===(a=this.langCommon)||void 0===a?void 0:a.signIn)))),(0,i.h)("slot",{key:"501387c77c64de535fc84dcc23bed35be4ac5092"}))}get el(){return(0,i.g)(this)}static get watchers(){return{surveyItemId:["surveyItemIdChanged"],queryParameters:["queryParametersChanged"],mergeFiles:["mergeFilesChanged"],outputFormat:["outputFormatChanged"],locale:["localeChanged"],show:["showChanged"],hide:["hideChanged"],inputFeatureTemplate:["inputFeatureTemplateChanged"],label:["labelChanged"],reportTemplateIds:["reportTemplateIdsChanged"],requestSource:["requestSourceChanged"]}}};E.style=":host{color:var(--calcite-color-text-2);display:block;overflow:auto}:host div.banner{display:block;cursor:pointer;line-height:60px}:host .task-num{display:inline-block;height:16px;text-align:center;border-radius:16px;border-color:#31872E;background-color:#31872E;margin-left:4px;color:#ffffff;line-height:16px !important;transition:all 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28)}:host .task-num span{position:relative;line-height:1 !important;color:#ffffff;padding:1px 4px}:host .task-num.active{-webkit-transform:scale(1.2);transform:scale(1.2)}:host .error-message{word-break:break-word}:host-context([dir=rtl]) .task-num{margin-left:unset !important;margin-right:4px}"}}]);