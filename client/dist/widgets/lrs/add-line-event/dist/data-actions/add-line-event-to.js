System.register(["jimu-core","widgets/shared-code/lrs"],function(e,t){var n={},r={};return{setters:[function(e){n.AbstractDataAction=e.AbstractDataAction,n.DataLevel=e.DataLevel,n.DataSourceStatus=e.DataSourceStatus,n.DataSourceTypes=e.DataSourceTypes,n.MutableStoreManager=e.MutableStoreManager,n.getAppStore=e.getAppStore,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){r.QueryRouteMeasures=e.QueryRouteMeasures,r.findEventInfoFromMapViewsConfig=e.findEventInfoFromMapViewsConfig,r.findNetworkInfoFromMapViewsConfig=e.findNetworkInfoFromMapViewsConfig,r.getDateWithTZOffset=e.getDateWithTZOffset,r.getRouteFromEndMeasures=e.getRouteFromEndMeasures,r.isDefined=e.isDefined,r.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{var e={47626:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=n}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var i={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(i),o.d(i,{default:()=>Z});const e="object"==typeof global&&global&&global.Object===Object&&global;var t="object"==typeof self&&self&&self.Object===Object&&self;const n=e||t||Function("return this")();var r=/\s/;const a=function(e){for(var t=e.length;t--&&r.test(e.charAt(t)););return t};var s=/^\s+/;const u=function(e){return e?e.slice(0,a(e)+1).replace(s,""):e};const l=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};const d=n.Symbol;var f=Object.prototype,c=f.hasOwnProperty,g=f.toString,m=d?d.toStringTag:void 0;const v=function(e){var t=c.call(e,m),n=e[m];try{e[m]=void 0;var r=!0}catch(e){}var o=g.call(e);return r&&(t?e[m]=n:delete e[m]),o};var p=Object.prototype.toString;const D=function(e){return p.call(e)};var S=d?d.toStringTag:void 0;const y=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":S&&S in Object(e)?v(e):D(e)};const b=function(e){return null!=e&&"object"==typeof e};const h=function(e){return"symbol"==typeof e||b(e)&&"[object Symbol]"==y(e)};var N=/^[-+]0x[0-9a-f]+$/i,M=/^0b[01]+$/i,O=/^0o[0-7]+$/i,w=parseInt;const I=function(e){if("number"==typeof e)return e;if(h(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=u(e);var n=M.test(e);return n||O.test(e)?w(e.slice(2),n?2:8):N.test(e)?NaN:+e};var j=1/0;const R=function(e){return e?(e=I(e))===j||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const F=function(e){var t=R(e),n=t%1;return t==t?n?t-n:t:0};const T=function(e,t){for(var n=-1,r=null==e?0:e.length,o=Array(r);++n<r;)o[n]=t(e[n],n,e);return o};const P=Array.isArray;var A=d?d.prototype:void 0,C=A?A.toString:void 0;const L=function e(t){if("string"==typeof t)return t;if(P(t))return T(t,e)+"";if(h(t))return C?C.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n};const k=function(e){return null==e?"":L(e)};var x=n.isFinite,E=Math.min;const V=function(e){var t=Math[e];return function(e,n){if(e=I(e),(n=null==n?0:E(F(n),292))&&x(e)){var r=(k(e)+"e").split("e"),o=t(r[0]+"e"+(+r[1]+n));return+((r=(k(o)+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}("round");var J=o(79244),G=o(47626),W=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}u((r=r.apply(e,t||[])).next())})};class Z extends J.AbstractDataAction{isSupported(e,t){return W(this,void 0,void 0,function*(){var n;if(e.length>1)return!1;const r=e[0];if(1!==r.records.length)return!1;const o=r.records[0],i=o.getData(),a=JSON.parse(JSON.stringify(i)),s=Object.fromEntries(Object.entries(a).map(([e,t])=>[e.toLowerCase(),t]));let u=null,l=!1;if(yield(0,J.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then(e=>{[u]=e}).then(()=>{const e=o.getGeometry();0===new u(e).paths.length&&(l=!0)}),!l)return!1;if(""===String(s.measure))return!1;const{dataSource:d,records:f}=r,c=d.type===J.DataSourceTypes.FeatureLayer||d.type===J.DataSourceTypes.SceneLayer,g=d.isDataSourceSet(),m=t!==J.DataLevel.Records,v=t===J.DataLevel.Records&&0===(null==f?void 0:f.length),p=!d.isInAppConfig()&&!c;if(g||m||v||p)return!1;if(!d||d.getStatus()===J.DataSourceStatus.NotReady)return!1;const D=d.getOriginDataSources()[0],S=q(),y=null===(n=null==S?void 0:S.widgets)||void 0===n?void 0:n[this.widgetId];if(!(0,G.isDefined)(D))return!1;let b,h;if(y.config.lrsLayers.forEach(e=>{e.id===D.id&&(b=e.networkInfo)}),!(0,G.isDefined)(b)){const e=y.config.mapViewsConfig;b=(0,G.findNetworkInfoFromMapViewsConfig)(e,D)}if(!b)return!1;const N=b.eventLayers;if(y.config.lrsLayers.forEach(e=>{N.forEach(t=>{String(e.originName)===t&&(h=e.eventInfo)})}),!(0,G.isDefined)(h)){const e=y.config.mapViewsConfig;h=(0,G.findEventInfoFromMapViewsConfig)(e,b)}return!!h})}onExecute(e,t){return W(this,void 0,void 0,function*(){var n;const r=e[0],{records:o,dataSource:i}=r,a=i.getOriginDataSources()[0];if(t===J.DataLevel.DataSource)J.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",i);else{const e=q(),t=null===(n=null==e?void 0:e.widgets)||void 0===n?void 0:n[this.widgetId];let r;if(t.config.lrsLayers.forEach(e=>{e.id===a.id&&(r=e.networkInfo)}),!(0,G.isDefined)(r)){const e=t.config.mapViewsConfig;r=(0,G.findNetworkInfoFromMapViewsConfig)(e,a)}const i=t.config.hideMeasures,s=o[0],u=s.getData(),l=JSON.parse(JSON.stringify(u)),d=Object.fromEntries(Object.entries(l).map(([e,t])=>[e.toLowerCase(),t])),f={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},c=Object.keys(l).find(e=>e===r.routeIdFieldSchema.name),g=Object.keys(l).find(e=>{var t;return e===(null===(t=r.routeNameFieldSchema)||void 0===t?void 0:t.name)}),m=Object.keys(l).find(e=>e===r.fromDateFieldSchema.name),v=Object.keys(l).find(e=>e===r.toDateFieldSchema.name),p=Object.keys(l).find(e=>{var t;return e===(null===(t=r.lineIdFieldSchema)||void 0===t?void 0:t.name)}),D=Object.keys(l).find(e=>{var t;return e===(null===(t=r.lineNameFieldSchema)||void 0===t?void 0:t.name)}),S=Object.keys(l).find(e=>{var t;return e===(null===(t=r.lineOrderFieldSchema)||void 0===t?void 0:t.name)}),y=(0,G.isDefined)(l[m])?(0,G.getDateWithTZOffset)(l[m],a):null,b=(0,G.isDefined)(l[v])?(0,G.getDateWithTZOffset)(l[v],a):null;if(f.fromDate=y,f.toRouteFromDate=y,f.selectedFromDate=new Date(Date.now()),f.toDate=b,f.toRouteToDate=b,f.selectedToDate=null,f.routeId=(0,G.isDefined)(l[c])?String(l[c]):null,f.toRouteId=(0,G.isDefined)(l[c])?String(l[c]):null,f.routeName=(0,G.isDefined)(g)&&(0,G.isDefined)(l[g])?String(l[g]):null,f.toRouteName=(0,G.isDefined)(g)&&(0,G.isDefined)(l[g])?String(l[g]):null,f.lineId=(0,G.isDefined)(p)&&(0,G.isDefined)(l[p])?String(l[p]):null,f.toLineId=(0,G.isDefined)(p)&&(0,G.isDefined)(l[p])?String(l[p]):null,f.routeLineOrder=(0,G.isDefined)(S)&&(0,G.isDefined)(l[S])?Number(l[S]):null,f.toRouteLineOrder=(0,G.isDefined)(S)&&(0,G.isDefined)(l[S])?Number(l[S]):null,f.lineName=(0,G.isDefined)(D)&&(0,G.isDefined)(l[D])?String(l[D]):null,f.toLineName=(0,G.isDefined)(D)&&(0,G.isDefined)(l[D])?String(l[D]):null,f.fromMeasure=(0,G.isDefined)(d.measure)?Number(d.measure):NaN,f.toRouteFromMeasure=(0,G.isDefined)(d.measure)?Number(d.measure):NaN,f.selectedToMeasure=(0,G.isDefined)(d.measure)?Number(d.measure):NaN,f.toMeasure=(0,G.isDefined)(d.tomeasure)?Number(d.tomeasure):NaN,f.toRouteToMeasure=(0,G.isDefined)(d.tomeasure)?Number(d.tomeasure):NaN,f.validRoute=!0,f.validToRoute=!0,!i){const e=s.getGeometry();f.selectedPoint=null,f.selectedToPoint=e}let h=null;if((0,G.isDefined)(r)){const e=r.useRouteName?f.routeName:f.routeId;yield(0,G.queryRouteIdOrName)(e,r,a,!1,!0,"",f.fromDate).then(e=>W(this,void 0,void 0,function*(){if((0,G.isDefined)(e)&&(yield Promise.all(e.features.map(e=>(h=e.geometry,e))),(0,G.isDefined)(h))){const e=(0,G.getRouteFromEndMeasures)(h);if((0,G.isDefined)(e)){const t=yield(0,G.QueryRouteMeasures)(a,r,e,f.fromDate,f.routeId),n=Math.min(...t),o=Math.max(...t);f.fromMeasure=V(n,r.measurePrecision),f.toRouteFromMeasure=V(n,r.measurePrecision),f.toMeasure=V(o,r.measurePrecision),f.toRouteToMeasure=f.toMeasure}if(i){const e=h.getPoint(0,0),t=h.paths[h.paths.length-1].length-1,n=h.getPoint(h.paths.length-1,t);f.selectedPoint=e,f.selectedToPoint=n,f.selectedMeasure=f.fromMeasure,f.selectedToMeasure=f.toRouteToMeasure}}}))}f.selectedPolyline=(0,G.isDefined)(h)?h:null,f.selectedToPolyline=(0,G.isDefined)(h)?h:null,J.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",a),J.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",f)}return!0})}}function q(){var e,t,n;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,J.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(n=(0,J.getAppStore)().getState())||void 0===n?void 0:n.appConfig}})(),i})())}}});