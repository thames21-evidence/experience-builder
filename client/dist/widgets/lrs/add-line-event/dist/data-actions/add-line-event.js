System.register(["jimu-core","widgets/shared-code/lrs"],function(e,t){var n={},i={};return{setters:[function(e){n.AbstractDataAction=e.AbstractDataAction,n.DataLevel=e.DataLevel,n.DataSourceStatus=e.DataSourceStatus,n.DataSourceTypes=e.DataSourceTypes,n.MutableStoreManager=e.MutableStoreManager,n.getAppStore=e.getAppStore,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){i.QueryRouteMeasures=e.QueryRouteMeasures,i.findEventInfoFromMapViewsConfig=e.findEventInfoFromMapViewsConfig,i.findNetworkInfoFromMapViewsConfig=e.findNetworkInfoFromMapViewsConfig,i.getDateWithTZOffset=e.getDateWithTZOffset,i.getRouteFromEndMeasures=e.getRouteFromEndMeasures,i.isDefined=e.isDefined,i.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{var e={47626:e=>{"use strict";e.exports=i},79244:e=>{"use strict";e.exports=n}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="";var o={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(o),r.d(o,{default:()=>W});const e="object"==typeof global&&global&&global.Object===Object&&global;var t="object"==typeof self&&self&&self.Object===Object&&self;const n=e||t||Function("return this")();var i=/\s/;const s=function(e){for(var t=e.length;t--&&i.test(e.charAt(t)););return t};var a=/^\s+/;const u=function(e){return e?e.slice(0,s(e)+1).replace(a,""):e};const l=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};const d=n.Symbol;var f=Object.prototype,c=f.hasOwnProperty,m=f.toString,g=d?d.toStringTag:void 0;const D=function(e){var t=c.call(e,g),n=e[g];try{e[g]=void 0;var i=!0}catch(e){}var r=m.call(e);return i&&(t?e[g]=n:delete e[g]),r};var p=Object.prototype.toString;const v=function(e){return p.call(e)};var S=d?d.toStringTag:void 0;const y=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":S&&S in Object(e)?D(e):v(e)};const h=function(e){return null!=e&&"object"==typeof e};const N=function(e){return"symbol"==typeof e||h(e)&&"[object Symbol]"==y(e)};var b=/^[-+]0x[0-9a-f]+$/i,M=/^0b[01]+$/i,O=/^0o[0-7]+$/i,I=parseInt;const w=function(e){if("number"==typeof e)return e;if(N(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=u(e);var n=M.test(e);return n||O.test(e)?I(e.slice(2),n?2:8):b.test(e)?NaN:+e};var R=1/0;const F=function(e){return e?(e=w(e))===R||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const j=function(e){var t=F(e),n=t%1;return t==t?n?t-n:t:0};const T=function(e,t){for(var n=-1,i=null==e?0:e.length,r=Array(i);++n<i;)r[n]=t(e[n],n,e);return r};const P=Array.isArray;var A=d?d.prototype:void 0,k=A?A.toString:void 0;const L=function e(t){if("string"==typeof t)return t;if(P(t))return T(t,e)+"";if(N(t))return k?k.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n};const C=function(e){return null==e?"":L(e)};var x=n.isFinite,J=Math.min;const E=function(e){var t=Math[e];return function(e,n){if(e=w(e),(n=null==n?0:J(j(n),292))&&x(e)){var i=(C(e)+"e").split("e"),r=t(i[0]+"e"+(+i[1]+n));return+((i=(C(r)+"e").split("e"))[0]+"e"+(+i[1]-n))}return t(e)}}("round");var V=r(79244),_=r(47626),G=function(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}u((i=i.apply(e,t||[])).next())})};class W extends V.AbstractDataAction{isSupported(e,t){return G(this,void 0,void 0,function*(){var n;if(e.length>1)return!1;const i=e[0],r=i.records[0];if(!(0,_.isDefined)(r))return!1;const o=r.getData(),s=JSON.parse(JSON.stringify(o)),{dataSource:a,records:u}=i,l=a.type===V.DataSourceTypes.FeatureLayer||a.type===V.DataSourceTypes.SceneLayer,d=a.isDataSourceSet(),f=t!==V.DataLevel.Records,c=t===V.DataLevel.Records&&0===(null==u?void 0:u.length),m=!a.isInAppConfig()&&!l;if(d||f||c||m)return!1;let g=a;if((a.id.includes("output_point")||a.id.includes("output_line"))&&(g=a.getOriginDataSources()[0]),!(0,_.isDefined)(g))return!1;const D=Z(),p=null===(n=null==D?void 0:D.widgets)||void 0===n?void 0:n[this.widgetId];let v,S;if(p.config.lrsLayers.forEach(e=>{(0,_.isDefined)(g)&&e.id===g.id&&(v=e.networkInfo)}),!(0,_.isDefined)(v)){const e=p.config.mapViewsConfig;v=(0,_.findNetworkInfoFromMapViewsConfig)(e,g)}if(!v)return!1;if(!(0,_.isDefined)(v.eventLayers)||0===v.eventLayers.length)return!1;const y=v.eventLayers;if(p.config.lrsLayers.forEach(e=>{y.forEach(t=>{String(e.originName)===t&&(S=e.eventInfo)})}),!(0,_.isDefined)(S)){const e=p.config.mapViewsConfig;S=(0,_.findEventInfoFromMapViewsConfig)(e,v)}if(!S)return!1;const h=Object.keys(s).find(e=>e===v.routeIdFieldSchema.name),N=Object.keys(s).find(e=>e===v.fromDateFieldSchema.name),b=Object.keys(s).find(e=>e===v.toDateFieldSchema.name),M=Object.keys(s).find(e=>{var t;return e===(null===(t=v.lineIdFieldSchema)||void 0===t?void 0:t.name)});if(!(0,_.isDefined)(h))return!1;if(i.records.length>2)return!1;let O=null,I=!1;if(yield(0,V.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then(e=>{[O]=e}).then(()=>{const e=r.getGeometry();0===new O(e).paths.length&&(I=!0)}),I)return!1;let w=!1;if(a.id.includes("output_line")&&(w=!0),w&&1!==i.records.length)return!1;if(!a||a.getStatus()===V.DataSourceStatus.NotReady)return!1;if(!w&&2===i.records.length&&!(0,_.isDefined)(M))return!1;if(!w&&2===i.records.length){const e=i.records[0],t=i.records[1],n=e.getData(),r=t.getData(),o=JSON.parse(JSON.stringify(n)),s=JSON.parse(JSON.stringify(r));if(String(o[M])!==String(s[M]))return!1;if(String(o[h])===String(s[h])&&Number(o[N])!==Number(s[N])&&Number(o[b])!==Number(s[b]))return!1}return!0})}onExecute(e,t){return G(this,void 0,void 0,function*(){var t;const n=e[0],{records:i,dataSource:r}=n,o=Z(),s=null===(t=null==o?void 0:o.widgets)||void 0===t?void 0:t[this.widgetId],a=s.config.hideMeasures;let u,l=r;if((r.id.includes("output_point")||r.id.includes("output_line"))&&(l=r.getOriginDataSources()[0]),!(0,_.isDefined)(l))return!1;if(s.config.lrsLayers.forEach(e=>{(0,_.isDefined)(l)&&e.id===l.id&&(u=e.networkInfo)}),!(0,_.isDefined)(u)){const e=s.config.mapViewsConfig;u=(0,_.findNetworkInfoFromMapViewsConfig)(e,l)}const d=i[0],f=d.getData();let c=JSON.parse(JSON.stringify(f));const m=Object.keys(c).find(e=>{var t;return e===(null===(t=u.lineOrderFieldSchema)||void 0===t?void 0:t.name)});let g=null,D=!1;n.records.length>1&&(g=i[1],D=!0);let p=null;if((0,_.isDefined)(g)){const e=g.getData();p=JSON.parse(JSON.stringify(e));const t=c[m],n=p[m];if((0,_.isDefined)(t)&&(0,_.isDefined)(n)&&Number(t)>Number(n)){const e=c;c=p,p=e}}const v={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},S=Object.keys(c).find(e=>e===u.routeIdFieldSchema.name),y=Object.keys(c).find(e=>{var t;return e===(null===(t=u.routeNameFieldSchema)||void 0===t?void 0:t.name)}),h=Object.keys(c).find(e=>e===u.fromDateFieldSchema.name),N=Object.keys(c).find(e=>e===u.toDateFieldSchema.name),b=Object.keys(c).find(e=>{var t;return e===(null===(t=u.lineIdFieldSchema)||void 0===t?void 0:t.name)}),M=Object.keys(c).find(e=>{var t;return e===(null===(t=u.lineNameFieldSchema)||void 0===t?void 0:t.name)}),O=(0,_.isDefined)(c[h])?(0,_.getDateWithTZOffset)(c[h],l):null,I=(0,_.isDefined)(p)&&(0,_.isDefined)(p[h])?(0,_.getDateWithTZOffset)(p[h],l):null,w=(0,_.isDefined)(c[N])?(0,_.getDateWithTZOffset)(c[N],l):null,R=(0,_.isDefined)(p)&&(0,_.isDefined)(p[N])?(0,_.getDateWithTZOffset)(p[N],l):null;v.fromDate=O,v.toRouteFromDate=D?I:O,v.selectedFromDate=new Date(Date.now()),v.toDate=w,v.toRouteToDate=D?R:w,v.selectedToDate=null,v.routeId=(0,_.isDefined)(c[S])?String(c[S]):null,v.toRouteId=D?(0,_.isDefined)(p[S])?String(p[S]):null:(0,_.isDefined)(c[S])?String(c[S]):null,v.routeName=(0,_.isDefined)(y)&&(0,_.isDefined)(c[y])?String(c[y]):null,v.toRouteName=D?(0,_.isDefined)(p[y])?String(p[y]):null:(0,_.isDefined)(y)&&(0,_.isDefined)(c[y])?String(c[y]):null,v.lineId=(0,_.isDefined)(b)&&(0,_.isDefined)(c[b])?String(c[b]):null,v.toLineId=(0,_.isDefined)(b)&&(0,_.isDefined)(c[b])?String(c[b]):null,v.routeLineOrder=(0,_.isDefined)(m)&&(0,_.isDefined)(c[m])?Number(c[m]):null,v.toRouteLineOrder=D?(0,_.isDefined)(p[m])?Number(p[m]):null:(0,_.isDefined)(m)&&(0,_.isDefined)(c[m])?Number(c[m]):null,v.lineName=(0,_.isDefined)(M)&&(0,_.isDefined)(c[M])?String(c[M]):null,v.toLineName=(0,_.isDefined)(M)&&(0,_.isDefined)(c[M])?String(c[M]):null;const F=Object.fromEntries(Object.entries(c).map(([e,t])=>[e.toLowerCase(),t]));if(v.fromMeasure=(0,_.isDefined)(F.measure)?Number(F.measure):NaN,v.toRouteFromMeasure=(0,_.isDefined)(F.measure)?Number(F.measure):NaN,v.selectedMeasure=(0,_.isDefined)(F.measure)?Number(F.measure):NaN,v.toMeasure=(0,_.isDefined)(F.tomeasure)?Number(F.tomeasure):NaN,v.toRouteToMeasure=(0,_.isDefined)(F.tomeasure)?Number(F.tomeasure):NaN,v.selectedToMeasure=(0,_.isDefined)(F.tomeasure)?Number(F.tomeasure):NaN,v.validRoute=!0,v.validToRoute=!0,!a&&(0,_.isDefined)(c.Measure)){let e=null;yield(0,V.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then(t=>{[e]=t}).then(()=>{const t=d.getGeometry(),n=new e(t);if(n.paths.length>0){const e=n.getPoint(0,0),t=n.paths[n.paths.length-1].length-1,i=n.getPoint(n.paths.length-1,t);v.selectedPoint=e,v.selectedToPoint=i}})}let j=null,T=null;if((0,_.isDefined)(u)){const e=u.useRouteName?v.routeName:v.routeId;if(yield(0,_.queryRouteIdOrName)(e,u,l,!1,!0,"",v.fromDate).then(e=>G(this,void 0,void 0,function*(){if((0,_.isDefined)(e)&&(yield Promise.all(e.features.map(e=>{const t=e.attributes[u.fromDateFieldSchema.name],n=e.attributes[u.toDateFieldSchema.name];return(v.fromDate instanceof Date&&t===v.fromDate.getTime()||t===v.fromDate)&&(v.toDate instanceof Date&&n===v.toDate.getTime()||n===v.toDate)&&(j=e.geometry),e})),(0,_.isDefined)(j))){const e=(0,_.getRouteFromEndMeasures)(j);if((0,_.isDefined)(e)){const t=yield(0,_.QueryRouteMeasures)(l,u,e,v.fromDate,v.routeId),n=Math.min(...t),i=Math.max(...t);v.fromMeasure=E(n,u.measurePrecision),v.toRouteFromMeasure=E(n,u.measurePrecision),v.toMeasure=E(i,u.measurePrecision),v.toRouteToMeasure=v.toMeasure,v.selectedMeasure=E(n,u.measurePrecision),v.selectedToMeasure=v.toMeasure}if(a&&j.paths.length>0){const e=j.getPoint(0,0),t=j.paths[j.paths.length-1].length-1,n=j.getPoint(j.paths.length-1,t);v.selectedPoint=e,v.selectedToPoint=n,v.selectedMeasure=v.fromMeasure,v.selectedToMeasure=v.toRouteToMeasure}}})),D){const e=u.useRouteName?v.toRouteName:v.toRouteId;yield(0,_.queryRouteIdOrName)(e.trim(),u,l,!1,!0,"",v.toRouteFromDate).then(e=>G(this,void 0,void 0,function*(){if((0,_.isDefined)(e)&&(yield Promise.all(e.features.map(e=>(T=e.geometry,e))),(0,_.isDefined)(T))){const e=(0,_.getRouteFromEndMeasures)(T);if((0,_.isDefined)(e)){const t=yield(0,_.QueryRouteMeasures)(l,u,e,v.toRouteFromDate,v.toRouteId),n=Math.min(...t),i=Math.max(...t);v.toRouteFromMeasure=E(n,u.measurePrecision),v.toRouteToMeasure=E(i,u.measurePrecision)}if(a&&T.paths.length>0){const e=T.paths[T.paths.length-1].length-1,t=T.getPoint(T.paths.length-1,e);v.selectedToPoint=t,v.selectedToMeasure=v.toRouteToMeasure}}}))}}return v.selectedPolyline=(0,_.isDefined)(j)?j:null,v.selectedToPolyline=(0,_.isDefined)(j)?j:null,D&&(v.selectedToPolyline=(0,_.isDefined)(T)?T:null),V.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",l),V.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",v),!0})}}function Z(){var e,t,n;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,V.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(n=(0,V.getAppStore)().getState())||void 0===n?void 0:n.appConfig}})(),o})())}}});