System.register(["jimu-core","widgets/shared-code/lrs"],function(e,t){var r={},n={};return{setters:[function(e){r.AbstractDataAction=e.AbstractDataAction,r.DataLevel=e.DataLevel,r.DataSourceStatus=e.DataSourceStatus,r.DataSourceTypes=e.DataSourceTypes,r.MutableStoreManager=e.MutableStoreManager,r.getAppStore=e.getAppStore,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){n.QueryRouteMeasures=e.QueryRouteMeasures,n.findEventInfoFromMapViewsConfig=e.findEventInfoFromMapViewsConfig,n.findNetworkInfoFromMapViewsConfig=e.findNetworkInfoFromMapViewsConfig,n.getDateWithTZOffset=e.getDateWithTZOffset,n.getRouteFromEndMeasures=e.getRouteFromEndMeasures,n.isDefined=e.isDefined,n.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{var e={47626:e=>{"use strict";e.exports=n},79244:e=>{"use strict";e.exports=r}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var i={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(i),o.d(i,{default:()=>W});const e="object"==typeof global&&global&&global.Object===Object&&global;var t="object"==typeof self&&self&&self.Object===Object&&self;const r=e||t||Function("return this")();var n=/\s/;const s=function(e){for(var t=e.length;t--&&n.test(e.charAt(t)););return t};var a=/^\s+/;const u=function(e){return e?e.slice(0,s(e)+1).replace(a,""):e};const l=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};const c=r.Symbol;var f=Object.prototype,d=f.hasOwnProperty,v=f.toString,m=c?c.toStringTag:void 0;const g=function(e){var t=d.call(e,m),r=e[m];try{e[m]=void 0;var n=!0}catch(e){}var o=v.call(e);return n&&(t?e[m]=r:delete e[m]),o};var p=Object.prototype.toString;const y=function(e){return p.call(e)};var D=c?c.toStringTag:void 0;const S=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":D&&D in Object(e)?g(e):y(e)};const b=function(e){return null!=e&&"object"==typeof e};const h=function(e){return"symbol"==typeof e||b(e)&&"[object Symbol]"==S(e)};var w=/^[-+]0x[0-9a-f]+$/i,O=/^0b[01]+$/i,M=/^0o[0-7]+$/i,I=parseInt;const N=function(e){if("number"==typeof e)return e;if(h(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=u(e);var r=O.test(e);return r||M.test(e)?I(e.slice(2),r?2:8):w.test(e)?NaN:+e};var P=1/0;const j=function(e){return e?(e=N(e))===P||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const F=function(e){var t=j(e),r=t%1;return t==t?r?t-r:t:0};const A=function(e,t){for(var r=-1,n=null==e?0:e.length,o=Array(n);++r<n;)o[r]=t(e[r],r,e);return o};const C=Array.isArray;var R=c?c.prototype:void 0,k=R?R.toString:void 0;const L=function e(t){if("string"==typeof t)return t;if(C(t))return A(t,e)+"";if(h(t))return k?k.call(t):"";var r=t+"";return"0"==r&&1/t==-1/0?"-0":r};const T=function(e){return null==e?"":L(e)};var x=r.isFinite,E=Math.min;const V=function(e){var t=Math[e];return function(e,r){if(e=N(e),(r=null==r?0:E(F(r),292))&&x(e)){var n=(T(e)+"e").split("e"),o=t(n[0]+"e"+(+n[1]+r));return+((n=(T(o)+"e").split("e"))[0]+"e"+(+n[1]-r))}return t(e)}}("round");var _=o(79244),J=o(47626),G=function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}u((n=n.apply(e,t||[])).next())})};class W extends _.AbstractDataAction{isSupported(e,t){var r;if(e.length>1)return Promise.resolve(!1);const n=e[0],o=n.records[0];if(!(0,J.isDefined)(o))return Promise.resolve(!1);const i=o.getData(),s=JSON.parse(JSON.stringify(i)),{dataSource:a,records:u}=n,l=a.type===_.DataSourceTypes.FeatureLayer||a.type===_.DataSourceTypes.SceneLayer,c=a.isDataSourceSet(),f=t!==_.DataLevel.Records,d=t===_.DataLevel.Records&&0===(null==u?void 0:u.length),v=!a.isInAppConfig()&&!l;if(c||f||d||v)return Promise.resolve(!1);let m=a;if((a.id.includes("output_point")||a.id.includes("output_line"))&&(m=a.getOriginDataSources()[0]),!(0,J.isDefined)(m))return Promise.resolve(!1);const g=Z(),p=null===(r=null==g?void 0:g.widgets)||void 0===r?void 0:r[this.widgetId];let y,D;if(p.config.lrsLayers.forEach(e=>{(0,J.isDefined)(m)&&e.id===m.id&&(y=e.networkInfo)}),!(0,J.isDefined)(y)){const e=p.config.mapViewsConfig;y=(0,J.findNetworkInfoFromMapViewsConfig)(e,m)}if(!y)return Promise.resolve(!1);if(!(0,J.isDefined)(y.eventLayers)||0===y.eventLayers.length)return Promise.resolve(!1);const S=y.eventLayers;if(p.config.lrsLayers.forEach(e=>{S.forEach(t=>{String(e.originName)===t&&(D=e.eventInfo)})}),!(0,J.isDefined)(D)){const e=p.config.mapViewsConfig;D=(0,J.findEventInfoFromMapViewsConfig)(e,y)}if(!D)return Promise.resolve(!1);const b=Object.keys(s).find(e=>e===y.routeIdFieldSchema.name);if(!(0,J.isDefined)(b)||!(0,J.isDefined)(s[b]))return Promise.resolve(!1);if(n.records.length>1)return Promise.resolve(!1);let h=!1;const w=a.id;return(w.includes("output_point")||w.includes("output_line"))&&(h=!0),h&&1!==n.records.length?Promise.resolve(!1):a&&a.getStatus()!==_.DataSourceStatus.NotReady?Promise.resolve(!0):Promise.resolve(!1)}onExecute(e,t){return G(this,void 0,void 0,function*(){var t;const r=e[0],{records:n,dataSource:o}=r,i=Z(),s=null===(t=null==i?void 0:i.widgets)||void 0===t?void 0:t[this.widgetId];let a,u=o;if((o.id.includes("output_point")||o.id.includes("output_line"))&&(u=o.getOriginDataSources()[0]),!(0,J.isDefined)(u))return Promise.resolve(!1);if(s.config.lrsLayers.forEach(e=>{(0,J.isDefined)(u)&&e.id===u.id&&(a=e.networkInfo)}),!(0,J.isDefined)(a)){const e=s.config.mapViewsConfig;a=(0,J.findNetworkInfoFromMapViewsConfig)(e,u)}const l=n[0],c=l.getData(),f=JSON.parse(JSON.stringify(c)),d=Object.fromEntries(Object.entries(f).map(([e,t])=>[e.toLowerCase(),t])),v={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},m=Object.keys(f).find(e=>e===a.routeIdFieldSchema.name),g=Object.keys(f).find(e=>{var t;return e===(null===(t=a.routeNameFieldSchema)||void 0===t?void 0:t.name)}),p=Object.keys(f).find(e=>e===a.fromDateFieldSchema.name),y=Object.keys(f).find(e=>e===a.toDateFieldSchema.name),D=Object.keys(f).find(e=>{var t;return e===(null===(t=a.lineIdFieldSchema)||void 0===t?void 0:t.name)}),S=Object.keys(f).find(e=>{var t;return e===(null===(t=a.lineOrderFieldSchema)||void 0===t?void 0:t.name)}),b=(0,J.isDefined)(f[p])?(0,J.getDateWithTZOffset)(f[p],u):null,h=(0,J.isDefined)(f[y])?(0,J.getDateWithTZOffset)(f[y],u):null;if(v.fromDate=b,v.selectedFromDate=new Date(Date.now()),v.toDate=h,v.selectedToDate=null,v.routeId=(0,J.isDefined)(f[m])?String(f[m]):null,v.routeName=(0,J.isDefined)(g)&&(0,J.isDefined)(f[g])?String(f[g]):null,v.lineId=(0,J.isDefined)(D)&&(0,J.isDefined)(f[D])?String(f[D]):null,v.routeLineOrder=(0,J.isDefined)(S)&&(0,J.isDefined)(f[S])?Number(f[S]):null,v.fromMeasure=(0,J.isDefined)(d.measure)?Number(d.measure):NaN,v.selectedMeasure=(0,J.isDefined)(d.measure)?Number(d.measure):NaN,v.validRoute=!0,(0,J.isDefined)(f.Measure)){let e=null,t=null;yield(0,_.loadArcGISJSAPIModules)(["esri/geometry/Point","esri/geometry/Polyline"]).then(r=>{[e,t]=r}).then(()=>{const r=l.getRawGeometry();if("point"===r.type){const t=new e(r);v.selectedPoint=t}else if("polyline"===r.type){const e=new t(r).getPoint(0,0);v.selectedPoint=e}})}let w=null;if((0,J.isDefined)(a)){const e=a.useRouteName?v.routeName:v.routeId;yield(0,J.queryRouteIdOrName)(e,a,u,!1,!0,"",v.fromDate).then(e=>G(this,void 0,void 0,function*(){if((0,J.isDefined)(e)&&(yield Promise.all(e.features.map(e=>(w=e.geometry,e))),(0,J.isDefined)(w))){v.selectedPolyline=w;const e=(0,J.getRouteFromEndMeasures)(w);if((0,J.isDefined)(e)){const t=yield(0,J.QueryRouteMeasures)(u,a,e,v.fromDate,v.routeId),r=Math.min(...t),n=Math.max(...t);v.fromMeasure=V(r,a.measurePrecision),v.toMeasure=V(n,a.measurePrecision)}}}))}return _.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",u),_.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",v),Promise.resolve(!0)})}}function Z(){var e,t,r;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,_.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(r=(0,_.getAppStore)().getState())||void 0===r?void 0:r.appConfig}})(),i})())}}});