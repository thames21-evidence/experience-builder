System.register(["jimu-core/emotion","jimu-core","jimu-ui","esri/rest/query","esri/rest/support/Query","esri/geometry/SpatialReference"],function(e,t){var r={},s={},o={},i={},n={},a={};return{setters:[function(e){r.jsx=e.jsx,r.jsxs=e.jsxs},function(e){s.AllDataSourceTypes=e.AllDataSourceTypes,s.DataSourceComponent=e.DataSourceComponent,s.DataSourceManager=e.DataSourceManager,s.DataSourceStatus=e.DataSourceStatus,s.Immutable=e.Immutable,s.React=e.React,s.SessionManager=e.SessionManager,s.css=e.css,s.esri=e.esri,s.getAppStore=e.getAppStore,s.moduleLoader=e.moduleLoader,s.portalUrlUtils=e.portalUrlUtils,s.semver=e.semver},function(e){o.WidgetPlaceholder=e.WidgetPlaceholder},function(e){i.executeQueryJSON=e.executeQueryJSON},function(e){n.default=e.default},function(e){a.default=e.default}],execute:function(){e((()=>{var e={14321:e=>{"use strict";e.exports=o},36510:e=>{"use strict";e.exports=n},51705:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" d="M10.227 13.694 7.211 10.55c-.294-.307-.28-.818.03-1.143.312-.324.802-.339 1.096-.032l2.66 2.774 4.695-4.896c.311-.324.802-.339 1.095-.032.294.306.28.817-.03 1.142l-5.113 5.33a.974.974 0 0 1-1.418 0"></path><path fill="#000" fill-rule="evenodd" d="M20 2c0-1.105-.948-2-2.118-2H4.118C2.948 0 2 .895 2 2v2H1a1 1 0 0 0 0 2h1v3H1a1 1 0 1 0 0 2h1v3H1a1 1 0 1 0 0 2h1v2c0 1.105.948 2 2.118 2h13.764c1.17 0 2.118-.895 2.118-2zM3 16v2c0 .552.478 1 1.067 1h13.866c.59 0 1.067-.448 1.067-1V2c0-.552-.478-1-1.067-1H4.067C3.477 1 3 1.448 3 2v2h1a1 1 0 0 1 0 2H3v3h1a1 1 0 1 1 0 2H3v3h1a1 1 0 1 1 0 2z" clip-rule="evenodd"></path></svg>'},53205:e=>{"use strict";e.exports=a},61222:e=>{"use strict";e.exports=i},67386:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=s}},t={};function l(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,l),o.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var r in t)l.o(t,r)&&!l.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.p="";var u={};return l.p=window.jimuConfig.baseUrl,(()=>{"use strict";l.r(u),l.d(u,{__set_webpack_public_path__:()=>m,default:()=>p});var e=l(67386),t=l(79244),r=l(14321);const s=new class{setQueryObject(e){const t=e?e.survey123:"",r=t?decodeURIComponent(t+""):"",s=this._urlParamToJson(r);this.queryObj=s}constructor(){this.surveyFeatureServices={},this._commonParams={},this.setCommonParams()}getSurveyHostUrlFromPortal(e){if(e=e||"https://www.arcgis.com",this.surveyUrlFromPortal||null===this.surveyUrlFromPortal)return Promise.resolve(this.surveyUrlFromPortal);e.endsWith("/")||(e+="/");const t=e+"home/js/arcgisonline/config.js",r=e+"sharing/rest/portals/self/settings?f=json";return Promise.resolve(!0).then(()=>fetch(r,{mode:"cors",method:"GET"}).then(e=>{if(e.ok)return e.json();throw new Error(e)}).then(e=>{var t;(null===(t=e.portalConfigProperties)||void 0===t?void 0:t.surveyUrl)&&(this.surveyUrlFromPortal=e.portalConfigProperties.surveyUrl)}).catch(()=>{})).then(()=>{if(this.surveyUrlFromPortal)return this.surveyUrlFromPortal;const e=document.createElement("script");e.type="text/javascript",e.src=t;const r=document.documentElement,s=r.getAttribute("dir");return new Promise((t,o)=>{e.onload=()=>{r.getAttribute("dir")!==s&&r.setAttribute("dir",s);const e=window.esriGeowConfig;e&&e.surveyUrl?(this.surveyUrlFromPortal=e.surveyUrl,t(e.surveyUrl)):(this.surveyUrlFromPortal=null,t(null))},e.onerror=()=>{r.getAttribute("dir")!==s&&r.setAttribute("dir",s),console.log("Failed to get survey url from portal's config.js, will fallback to use the default survey123 url."),this.surveyUrlFromPortal=null,t(null)},document.getElementsByTagName("head")[0].appendChild(e)})})}getSurvey123HostUrl(){let e="https://survey123.arcgis.com";this.surveyUrlFromPortal&&(e=this.surveyUrlFromPortal);let t=window.jimuConfig.hostEnv;if(this.queryObj&&this.queryObj.env&&(t=this.queryObj.env+"",t.startsWith("http://")||t.startsWith("https://")))return t;let r=!0;if("https://survey123.arcgis.com"!==e){const t=e.match(/https:\/\/survey123(\.[^\.]*)\.arcgis\.com/);r=!(!t||!t.length)}return t&&"prd"!==t&&"prod"!==t&&r&&(e=`https://survey123${t}.arcgis.com`),e}getSurvey123HostAPIUrl(){let e=this.getSurvey123HostUrl()+"/api/jsapi/3.24/";return this.queryObj&&this.queryObj.jsapi&&(e=this.getSurvey123HostUrl()+"/api/jsapi/"+this.queryObj.jsapi),e}createSurvey(e,t,r,s){return s=Object.assign({snippet:""},s||{}),Promise.resolve(!0).then(()=>{if(!(e&&r&&r.token&&r.username))throw new Error("missing title, tags, username or token")}).then(()=>{const o=`${this.getSurvey123HostUrl()}/api/survey/create`,i={title:e,tags:t&&Array.isArray(t)?t.join(","):t||null,snippet:s.snippet,thumbnailUrl:s.thumbnailUrl,token:r.token,username:r.username,portalUrl:r.portalUrl||"https://www.arcgis.com"};return fetch(o,{mode:"cors",method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(i)}).then(e=>{if(e.ok)return e.json();throw new Error(e)})})}isPortal(e){return!["www.arcgis.com","devext.arcgis.com","qaext.arcgis.com"].find((t,r)=>e.includes(t))}querySurvey(e,t){return t=Object.assign({isPublished:!1,isSearchAll:!0,surveyClientAPI:null},t||{}),Promise.resolve(!0).then(()=>{if(!e||!e.token||!e.username)throw new Error("missing token or username")}).then(()=>{const r={isPublished:t.isPublished,isSearchAll:t.isSearchAll,token:e.token,username:e.username,portalUrl:e.portalUrl||"https://www.arcgis.com"};return t.searchSurveyType&&(r.searchSurveyType=t.searchSurveyType),t.surveyClientAPI?t.surveyClientAPI.survey123.searchSurvey(r).then(e=>{if(e&&e.results)return e.results;throw new Error(e)}):(console.log("Survey client api is not provided."),null)})}queryOthersSurvey(e,t){return Promise.resolve(!0).then(()=>{if(!e||!e.token||!e.username)throw new Error("missing token or username")}).then(()=>{e.token;const r=e.username,s=e.portalUrl||"https://www.arcgis.com",o=t.orgId;let i=null;const n=`${s}/sharing/rest/search`,a={q:`((type:Form AND (typekeywords:xForm OR typekeywords:Form)) OR (type:'Code Sample' AND typekeywords:XForms AND tags:'xform')) AND (NOT owner:${r}) AND (access:shared OR access:org OR (access:public AND orgid:${o}) OR access:private)`};return this.searchAGO(n,a,e).then(t=>{if(i=t,t.results=(t.results||[]).map(t=>this.convertItemToSurveyInfo(t,e)),-1===t.nextStart)return i;const r=[];let s=Math.floor(t.total/t.num);t.total%t.num>0&&(s+=1);for(let o=1;o<s;o++){const s=Object.assign({},a,{start:o*t.num+1});s.start<=t.total&&r.push(this.searchAGO(n,s,e))}return Promise.all(r).then(r=>{if(!r)throw new Error("something wrong when searchAll");let s=t.results||[],o=-1;return r.forEach((t,i)=>{const n=t.results.map(t=>this.convertItemToSurveyInfo(t,e));s=s.concat(n),i===r.length-1&&(o=t.nextStart)}),i.nextStart=o,i.results=s,i})})}).then(e=>e&&e.results||[])}searchAGO(e,t,r){t=Object.assign({num:100,start:1,sortField:"title",sortOrder:"asc"},t);const s=Object.assign({},{f:"json",token:r.token},t),o=`${e}?${Object.keys(s).map(e=>e+"="+s[e]).join("&")}`;return fetch(o,{mode:"cors",method:"GET"}).then(e=>{if(e.ok)return e.json();throw new Error(e)})}convertItemToSurveyInfo(e,t){return{created:e.created,featureService:null,form:null,formItemInfo:e,id:e.id,owner:e.owner,report:null,snippet:e.snippet,tags:e.tags,thumbnail:`${t.portalUrl}/sharing/rest/content/items/${e.id}/info/${e.thumbnail}?token=${t.token}`,title:e.title}}getSurvey123DesignerUrl(e,t){t=Object.assign({},t||{});let r=`${this.getSurvey123HostUrl()}/surveys/${e}/design?embed=exb`;return t.portalUrl&&"https://www.arcgis.com"!==t.portalUrl&&(r+=`&portalUrl=${t.portalUrl}`),"https://survey123dev.arcgis.com"!==this.getSurvey123HostUrl()||t.portalUrl&&"https://www.arcgis.com"!==t.portalUrl||(r+=`&portalUrl=${t.portalUrl}`),r}getSurvey123WebformUrl(e,t){t=Object.assign({queryParams:[]},t||{});let r=`${this.getSurvey123HostUrl()}/share/${e}`;return t.queryParams.length>0&&(r+=`?${t.queryParams.join("&")}`),r}flatQuestions(e){let t=[];return e.forEach(e=>{e.questions?"esriQuestionTypeRepeat"!==e.type&&("esriQuestionTypeAddress"===e.type&&t.push(e),t=t.concat(this.flatQuestions(e.questions))):t.push(e)}),t}getSurveyQuestionFields(e,t){return Promise.resolve(!0).then(()=>{if(!e||!t||!t.token)throw new Error("missing surveyItemId or token")}).then(()=>{let r=`${this.getSurvey123HostUrl()}/api/survey/${e}/form`;const s={token:t.token,portalUrl:t.portalUrl};return r=`${r}?${Object.keys(s).map(e=>e+"="+s[e]).join("&")}`,fetch(r,{mode:"cors",method:"GET"}).then(e=>{if(e.ok)return e.json();throw new Error(e)})})}setCommonParams(){var e,r;const s=(0,t.getAppStore)().getState().portalUrl;this._commonParams={token:null===(e=t.SessionManager.getInstance().getMainSession())||void 0===e?void 0:e.token,username:null===(r=(0,t.getAppStore)().getState().user)||void 0===r?void 0:r.username,portalUrl:s}}getCommonParams(){return this._commonParams||this.setCommonParams(),this._commonParams}getBaseRequestOptions(){const e=t.SessionManager.getInstance(),r=(0,t.getAppStore)().getState().portalUrl,s=t.portalUrlUtils.getPortalRestUrl(r);return{authentication:e.getSessionByUrl(r),portal:s}}updateRelatedDataSources(e,r){const s=t.DataSourceManager.getInstance().getDataSourcesAsArray();if(s.length)return Promise.resolve(!0).then(()=>this.getSurveyFeatureServices(e)).then(e=>{s.filter(t=>{const r=t.itemId,s=t.url||"",o=e.find(e=>!(e.itemId!==r&&!s.startsWith(e.url)));return o&&t.afterAddRecord(null),o})})}getSurveyFeatureServices(e){const r=this.surveyFeatureServices[e];if(r)return Promise.resolve(r);const s=t.SessionManager.getInstance().getMainSession(),o=[];let i=`type:Feature Service AND typekeywords:${e} AND typekeywords:StakeholderView`;i+=" AND ((typekeywords:Hosted Service AND typekeywords:View Service) OR (NOT typekeywords:Hosted Service))";const n=`${this._commonParams.portalUrl}/sharing/rest/search`,a={q:i};return this.searchAGO(n,a,this._commonParams).then(e=>{if(!e||e.error)throw new Error(JSON.stringify(e));if(e.results&&0===e.results.length)return null;const t=e.results[0];o.push({type:"stakeholder",url:t.url,temId:t.id})}).then(()=>{const r=Object.assign({id:e,relationshipType:"Survey2Service"},this.getBaseRequestOptions());return t.esri.restPortal.getRelatedItems(r).then(r=>{r&&!r.error||console.warn("Failed to get related templates");const i=r.relatedItems[0];if(!i)return o;const n=i.typeKeywords;if(-1===n.indexOf(e)||-1===n.indexOf("FieldworkerView")&&-1===n.indexOf("View Service"))return o.push({type:"source",url:i.url,temId:i.id}),o;{o.push({type:"fieldworker",url:i.url,temId:i.id});const e=`${i.url}/sources`,r={httpMethod:"GET",authentication:s};return t.esri.restRequest.request(e,r).then(e=>{const t=e.services[0];return t?this.getItemInfo(t.serviceItemId).then(e=>(e&&o.push({type:"source",url:e.url,temId:e.id}),o)):o})}})}).catch(e=>(console.log("Error occurs when get related feature services with survey,",e),o)).finally(()=>{this.surveyFeatureServices[e]=o})}getItemInfo(e){return t.esri.restPortal.getItem(e,this.getBaseRequestOptions())}getQuesLabelString(e,t){var r;if(t=Object.assign({locales:[],currentLocale:"en"},t||{}),!e||!e.label)return"";let s=e.label;if("object"==typeof s){let o=Object.keys(t.locales||[]).find(e=>e.isDefault+""=="true");o&&(o=o.code||"en");const i=null===(r=t.locales)||void 0===r?void 0:r.map(e=>(e.code+"").trim()),n=this._findMatchedLocale(t.currentLocale,i)||o;if(n&&n in e.label)s=e.label[n];else{const t=Object.keys(e.label)[0];s=t?e.label[t]:""}}return s}_urlParamToJson(e){if(!e)return null;const t=(e+="").split(";");if(t.length<2&&e.split(":").length<2)return e.split(",").length>1?e.split(","):e;{const e={};return t.forEach(t=>{const r=(t+"").split(":");if(r.length>1){const t=r[0];let s=(Array.isArray(r.slice(1))?r.slice(1):[]).join(":");s.length&&"{"===s[0]&&(s=this._stringToJson(s)),"string"==typeof s&&s.split(",").length>1&&(s=s.split(",")),e[t]=s}}),e}}_findMatchedLocale(e,t){if(!t||!t.length||!e)return null;if(t.indexOf(e)>=0)return e;const r=e.split("-")[0];return t.indexOf(r)>=0?r:t.find(e=>e.startsWith(`${r}-`))}_stringToJson(e){let t=e;try{t=JSON.parse(e)}catch(r){t=e}return t}};const o="Survey";var i=l(51705),n=l.n(i),a=l(61222),c=l(36510),d=l(53205);class h extends t.React.PureComponent{constructor(e){super(e),this.API={Survey123WebForm:null},this.webappStatus="normal",this.state={featureLayerViewDS:null},this._dsManager=t.DataSourceManager.getInstance(),this.prepare=()=>{const e=this.props.config.portalUrl||this.props.portalUrl||"https://www.arcgis.com",r=!t.portalUrlUtils.isAGOLDomain(e);return Promise.resolve(!0).then(()=>!r||s.getSurveyHostUrlFromPortal(e)).then(()=>this.loadSurveyAPI())},this.loadSurveyAPI=()=>{const e=s.getSurvey123HostAPIUrl();return this.API.Survey123WebForm?Promise.resolve(this.API.Survey123WebForm):t.moduleLoader.loadModule(e).then(e=>(e&&e.Survey123WebForm?this.API=e:this.API.Survey123WebForm=e,this.API.Survey123WebForm))},this.updateDomId=()=>{const e=(1e6*Math.random()|0).toString();return this.domId="survey_container_"+this.props.id+"_"+e,this.domId},this.isDsConfigured=()=>{const e=this.props.config.mode||"new";return!(!this.props.useDataSources||1!==this.props.useDataSources.length||!this.props.config.activeLinkData&&"edit"!==e&&"view"!==e)},this.doQuery=e=>{const r={geometry:e,spatialRelationship:"intersects",returnGeometry:!0};this.getUsedDataSource().getStatus()!==t.DataSourceStatus.Loading&&this.getUsedDataSource().load(r)},this.checkWebformOptionChanged=e=>{const t=this._formOption;return!Object.is(t,e)&&(!(t||!e)||(t.itemId!==e.itemId||t.surveyItemId!==e.surveyItemId||t.portalUrl!==e.portalUrl||t.token!==e.token||t.surveyStatusCode!==e.surveyStatusCode||(t.mode||"new")!==(e.mode||"new")||("edit"===e.mode||"view"===e.mode)&&this._cachedUniqueId!==this._currentGlobalId||(t.hideElements?t.hideElements.asMutable():[]).sort().join(",")!==(e.hideElements?e.hideElements.asMutable():[]).sort().join(",")))},this.updateStyle=()=>{if("safari"===(window.jimuUA.browser?(window.jimuUA.browser.name+"").toLowerCase():"")){const e=document.querySelector("#"+this.domId);e.style.cssText="overflow-y: auto;";e.closest(".widget-content").style.cssText="position: absolute;"}},this.getSelectedDsRecord=e=>{var t;if(!e)return Promise.resolve(null);const r=e.getSelectedRecords();if(!r||!r.length||!r[0].feature)return Promise.resolve(null);const s=r[0].feature;let o=!1;const i=this.props.config.mode||"new";let n=[];if("new"===i&&this.props.config.activeLinkData&&this.props.config.fieldQuestionMapping)this.props.config.fieldQuestionMapping.forEach(e=>{n.push(e.field)});else if("view"===i||"edit"===i){const e=this.getUniqueFieldName();n=e?[e]:[]}if(s.attributes){const e=Object.keys(s.attributes);o=n.find(t=>!e.includes(t))}if(!o){let e=null===(t=s.geometry)||void 0===t?void 0:t.spatialReference;if(!e)return Promise.resolve(s);if(e=new d.default("function"==typeof e.toJSON?e.toJSON():e),e.isWGS84)return Promise.resolve(s);if((s.geometry.longitude||0===s.geometry.longitude)&&(s.geometry.latitude||0===s.geometry.latitude))return Promise.resolve(s)}if(!e.url)return Promise.resolve(s);const l=e.getIdField()||"objectid",u=new c.default({where:`${l} = ${s.attributes[l]}`,outFields:["*"],returnGeometry:!0,outSpatialReference:new d.default({wkid:4326})});return a.executeQueryJSON(e.url,u).then(e=>e.features&&e.features[0]?e.features[0]:s)},this.onDataSourceCreated=()=>null,this.onDataSourceInfoChange=()=>{const e=this._dsManager.getDataSource(this.props.useDataSources[0].dataSourceId);if(e){const r="preserve"===this.props.config.selectionChangeBehavior,s=this.props.config.mode||"new",o="new"===s&&this.props.config.activeLinkData&&this.props.config.fieldQuestionMapping,i="view"===s||"edit"===s,n=e.getSelectedRecords();if(n&&n.length){const s=n[0].feature,i=this.props.config.mode||"new",a=this.getFeatureUniqueId(s,"new"===i);if(!a||a!==this._cachedUniqueId){const i=e.type===t.AllDataSourceTypes.SceneLayer;Promise.resolve(!0).then(()=>i?s:this.getSelectedDsRecord(e)).then(e=>{!r&&o&&!this._isClearSelectionFreezing&&this._cachedUniqueId&&this.refreshWebapp(),this.featureLayerViewHandler(e)})}}else{if(r)return this._isClearSelectionFreezing=!0,setTimeout(()=>{this._isClearSelectionFreezing=!1},1700),void((o||i)&&this._cachedUniqueId&&setTimeout(()=>{var t;(null===(t=e.getSelectedRecords())||void 0===t?void 0:t.length)||this._isClearSelectionFreezing||(i&&(this._currentGlobalId=""),this.clearQuestionValue(),this._cachedUniqueId="")},1800));(o||i)&&(i&&(this._currentGlobalId=""),this.refreshWebapp(),this._cachedUniqueId="")}}},this.getClientId(),this.listenSurvey123WebformEvent()}componentDidMount(){s.setQueryObject(this.props.queryObject),this.prepare()}getUsedDataSource(){const e=this.props.useDataSources;let t=null;if(e&&e.length>0){const r=e[0].dataSourceId;t=this._dsManager.getDataSource(r)}return t}getUniqueFieldName(e){var t,r;const s=this.getUsedDataSource(),o=s?s.getLayerDefinition():null;if(!o)return"";let i=o.globalIdField;const n=o.objectIdField;return i||(e&&n?n:(i=null===(t=o.fields.find(e=>"esriFieldTypeGlobalID"===e.type))||void 0===t?void 0:t.name,i||(e?null===(r=o.fields.find(e=>"esriFieldTypeOID"===e.type))||void 0===r?void 0:r.name:void 0)))}featureLayerViewHandler(e,t){return Promise.resolve(!0).then(()=>e||(t&&t.getSelectedRecords()?this.getSelectedDsRecord(t):void 0)).then(e=>{if(!e)return;const t=this.props.config.mode||"new";if("new"===t&&this.props.config.activeLinkData&&this.props.config.fieldQuestionMapping){const t=e.attributes||{},r={};this.props.config.fieldQuestionMapping.forEach(s=>{var o;const i=s.field,n=s.question;if("geometry"===i){const t=e.geometry;!t||!t.y&&0!==t.y||!t.x&&0!==t.x?(t&&t.paths&&t.paths.length||t&&t.rings&&t.rings.length)&&(r[n]=t):(r[n]=t,!t.longitude&&0!==t.longitude||!t.latitude&&0!==t.latitude||(r[n]={x:t.longitude,y:t.latitude})),(null===(o=r[n])||void 0===o?void 0:o.toJSON)&&(r[n]=r[n].toJSON())}else{const e=t[i];r[n]=i in t?e:""}}),this.sendValueFromMapToSurvey(r);const s=this.getFeatureUniqueId(e,!0);s&&(this._cachedUniqueId=s)}else if("view"===t||"edit"===t){this._currentGlobalId="";const t=this.getFeatureUniqueId(e);if(!t)return void console.log("The global id field is not existing in the source layer");this._currentGlobalId=t,this.renderDS(),this._cachedUniqueId=this._currentGlobalId}})}sendValueFromMapToSurvey(e){if("loading"===this.webappStatus);else if("normal"===this.webappStatus){if(!this.webform)return;e&&this.webform.setQuestionValue(e)}else if("thankyouScreen"===this.webappStatus){const t=this.buildWebFormConfig({setQuestionValue:e});this.createWebForm(t)}}listenSurvey123WebformEvent(){const e=e=>{if(e&&e.data){let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data&&e.data.payload?"string"==typeof e.data.payload?JSON.parse(e.data.payload):e.data.payload:e.data}catch(e){console.error(e)}const r=t.event,s=t.data;"survey123:onFormLoaded"===r&&"survey123:onFormLoaded"===r&&t.contentHeight,"survey123:onSubmitted"===r&&console.log("survey123:onSubmitted!",s)}};window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)}getClientId(){var e,r;const s=t.SessionManager.getInstance().getMainSession();this._clientId="",s&&s.clientId?this._clientId=s.clientId:(null===(r=null===(e=(0,t.getAppStore)().getState().appConfig)||void 0===e?void 0:e.attributes)||void 0===r?void 0:r.clientId)&&(this._clientId=(0,t.getAppStore)().getState().appConfig.attributes.clientId)}getFeatureUniqueId(e,t){if(!e)return null;const r=e.attributes||{},s=this.getUniqueFieldName(t);return s?r[s]:null}createWebForm(e){document.querySelector("#"+this.domId)&&(document.querySelector("#"+this.domId).innerHTML="",this.webform=null),this.webappStatus="loading",this.webform=new this.API.Survey123WebForm(e)}buildWebFormConfig(e){var r;const o=this.props.config,i={clientId:this._clientId||"survey123hub",container:this.domId||this.updateDomId(),itemId:o.surveyItemId,isDebugMode:!1,stringKeyMapping:{"hubOpen.viewGIDCannotWorkErrMsg":{value:"hubOpen.viewGIDCannotWorkErrMsg2",type:"key"},"hubOpen.editGIDCannotWorkErrMsg":{value:"hubOpen.editGIDCannotWorkErrMsg2",type:"key"}}},n=o.portalUrl||this.props.portalUrl||"https://www.arcgis.com";i.portalUrl=n;const a=null===(r=t.SessionManager.getInstance().getMainSession())||void 0===r?void 0:r.token;a&&(i.portalUrl=n,i.token=a);const l=(0,t.getAppStore)().getState().appConfig.originExbVersion;t.semver.lt(l,window.jimuConfig.isInPortal?"1.8.0":"1.9.0")&&(i.autoRefresh=3);const u=o.hides||(0,t.Immutable)(["navbar","header","description","footer","theme"]);u.length>0&&(i.hideElements=u);const c=o.defaultValue;c&&"object"==typeof c&&null!=c&&(i.defaultValue=c),"edit"!==o.mode&&"view"!==o.mode||(i.mode=o.mode,i.globalId=this._currentGlobalId||"");const d=this.props.stateProps?this.props.stateProps.surveyStatusCode:0;return d&&(i.surveyStatusCode=d),i.onFormLoaded=t=>{if(this.updateIframeTitle(),this.webappStatus="normal",e)this.sendValueFromMapToSurvey(e.setQuestionValue);else if("normal"===this.webappStatus){const e=this.getUsedDataSource();e&&this.featureLayerViewHandler(null,e)}},i.onFormSubmitted=e=>{this.webappStatus="thankyouScreen",e.error||s.updateRelatedDataSources(o.surveyItemId,o.mode)},i.onFormFailed=e=>{this.webappStatus="error",this.updateIframeTitle()},i}getWebformUrl(){var e;const r=this.props.config,o=r.surveyItemId,i=r.portalUrl||this.props.portalUrl||"https://www.arcgis.com";let n=null;if(o){const a=[];"https://www.arcgis.com"!==i&&a.push(`portalUrl=${i}`),"https://survey123dev.arcgis.com"===s.getSurvey123HostUrl()&&"https://www.arcgis.com"===i&&a.push(`portalUrl=${i}`);let l=r.embeds||[];l.includes("jsapi")||(l=l.concat(["jsapi"])),l.includes("onSubmitted")||(l=l.concat(["onSubmitted"])),l.length>0&&a.push(`embed=${l.join(",")}`);const u=r.hides||["navbar","header","description","footer","theme"];u.length>0&&a.push(`hide=${u.join(",")}`);const c=r.defaultValue;c&&"object"==typeof c&&null!=c&&Object.keys(c).forEach(e=>{a.push(`field:${e}=${c[e]}`)});const d=r.open||"web";d&&"web"!==d&&["web","menu","native"].includes(d)&&a.push(`open=${d}`);const h=null===(e=t.SessionManager.getInstance().getMainSession())||void 0===e?void 0:e.token;h&&a.push(`token=${h}`),a.push("autoRefresh=3"),n=s.getSurvey123WebformUrl(o,{queryParams:a})}return n}refreshWebapp(){this.renderDS(!0)}clearQuestionValue(){const e={};this.props.config.fieldQuestionMapping.forEach(t=>{const r=t.question;e[r]=""}),this.sendValueFromMapToSurvey(e)}updateIframeTitle(){var e;const t=this.props.a11yLabel||this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:o}),r=null===(e=this.iframeContainer)||void 0===e?void 0:e.querySelector("iframe");r&&(r.title=t)}renderDS(r){const{id:s}=this.props;let o=null,i=null,n=null;const a=this.buildWebFormConfig();this.isDsConfigured()&&(i=this.props.useDataSources[0].dataSourceId,n=this.props.useDataSources[0].rootDataSourceId,o=this.props.useDataSources[0]);const l=!!r||this.checkWebformOptionChanged(a);this._formOption=a;const u=this.getWebformUrl();return this.prepare().then(()=>{if(u&&(!this.webform||l))return this.createWebForm(a),this.updateStyle(),!0}),i&&n&&this.isDsConfigured()?(0,e.jsx)(t.DataSourceComponent,{widgetId:s,useDataSource:(0,t.Immutable)(o),onDataSourceCreated:this.onDataSourceCreated,onDataSourceInfoChange:this.onDataSourceInfoChange}):(0,e.jsx)("div",{})}render(){s.setQueryObject(this.props.queryObject);let i;return this.getWebformUrl()?(this.domId||this.updateDomId(),i=(0,e.jsx)("div",{className:"survey123__webform",children:(0,e.jsx)("div",{className:"embed-container",ref:e=>{this.iframeContainer=e},id:this.domId})}),this.updateIframeTitle()):i=(0,e.jsx)("div",{className:"survey123__noSurvey",children:(0,e.jsx)(r.WidgetPlaceholder,{icon:n(),name:this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:o}),widgetId:this.props.id})}),(0,e.jsxs)("div",{css:(this.props.theme,t.css`
    &.survey123{
        width: 100%;
        height: 100%;
        overflow: auto;


        .title{
            font-weight: bold;
        }

        .survey123__noSurvey{
            width:100%;
            height:100%;
            text-align:center;
        }

        .survey123__webform{
            width:100%;
            height:100%;

            .embed-container {
                position: relative;
                height: 100%;
                // padding-bottom:80%;
                width: 100%;
            }

            .embed-container iframe,
            .embed-container object,
            .embed-container iframe{
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: 0px;
            }
            small{
                position: absolute;
                z-index: 40;
                bottom: 0;
                margin-bottom: -15px;
            }
        }
    }
  `),className:"survey123",children:[i,this.renderDS()]})}}h.mapExtraStateProps=e=>({queryObject:e.queryObject});const p=h;function m(e){l.p=e}})(),u})())}}});